<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>MassPort</title>

    <link href="https://fonts.googleapis.com/css2?family=Special+Elite&family=Yrsa:wght@500;600&family=Inter:wght@400;600;800&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="style.css">

    <script src="script.js"></script>
</head>
<body>

    <div class="top-controls">
        <div class="control-btn" id="share-btn" onclick="shareProfile()">
            <span class="material-symbols-rounded">ios_share</span> Share
        </div>
        <div class="control-btn" id="logout-btn" style="color: #c65265;" onclick="handleLogout()">
            Logout
        </div>
    </div>

    <div class="header">
        <h1 id="view-title">MassPort</h1>
        <p style="font-size:13px; opacity:0.6; letter-spacing: 1px;">TRAVEL ARCHIVE</p>
    </div>

    <div id="auth-container" class="modal-overlay">
        <div class="auth-card">
            <h2 style="text-align:center; font-family: 'Yrsa'; font-size: 32px; margin-bottom: 20px;">Passport Control</h2>
            <p style="font-size:12px; text-align:center; color:#666; margin-bottom:20px;">Please identify yourself to proceed.</p>
            
            <input type="text" id="username" placeholder="Username (Required)">
            <input type="email" id="email" placeholder="Email Address">
            <input type="password" id="password" placeholder="Password">
            
            <button class="primary-btn" onclick="handleLogin()">Login</button>
            <button class="primary-btn" style="background:#f1f5f9; color:#333;" onclick="handleSignUp()">Create Passport</button>
            <p id="auth-msg" style="font-size:11px; color:#c65265; text-align:center; margin-top:10px;"></p>
        </div>
    </div>

    <div id="main-grid"></div>

    <div id="nav-bar" class="collector-nav-container hidden">
        <div class="collector-nav" id="filter-nav"></div>
        <button class="add-btn" onclick="openAddModal()">+</button>
    </div>

    <div id="modal-overlay" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 id="modal-title" style="margin:0 0 15px; font-family:'Yrsa'; font-size:24px;">New Stamp</h3>
            
            <label style="font-size:11px; font-weight:700; color:#555;">TITLE</label>
            <input type="text" id="s-name" placeholder="e.g. The Louvre">
            
            <label style="font-size:11px; font-weight:700; color:#555; margin-top:10px; display:block;">LOCATION (Search)</label>
            <input type="text" id="s-address" placeholder="City, Country...">
            
            <label style="font-size:11px; font-weight:700; color:#555; margin-top:10px; display:block;">NOTES</label>
            <textarea id="s-notes" placeholder="Memories..." rows="3"></textarea>
            
            <label style="font-size:11px; font-weight:700; color:#555; margin-top:10px; display:block;">IMAGE</label>
            <input type="file" id="s-image-input" accept="image/*" onchange="previewImage()">
            
            <div id="preview-box" class="image-preview-container">
                <div class="remove-img-btn" onclick="clearImage()">Ã—</div>
                <img id="img-preview" style="width:100%; height:120px; object-fit:cover; border-radius:8px; border:1px solid #ddd;">
            </div>
            
            <input type="hidden" id="edit-id">
            <input type="hidden" id="current-img-url">

            <button class="primary-btn" id="save-btn" onclick="saveStamp()">Save Stamp</button>
            <button class="primary-btn" style="background:transparent; color:#888; margin-top:0;" onclick="closeModal()">Cancel</button>
        </div>
    </div>

    <div id="img-modal" class="modal-overlay hidden" onclick="this.classList.add('hidden')">
        <div style="position:relative; width:100%; height:100%; display:flex; flex-direction:column; align-items:center; justify-content:center; pointer-events:none;">
            <img id="modal-img" style="max-width:90%; max-height:80vh; border:10px solid white; box-shadow:0 0 50px black; pointer-events:auto;">
            <h2 id="modal-caption" style="color:white; font-family:'Yrsa'; margin-top:20px; text-shadow:0 2px 4px black;"></h2>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://ujyoxnrfchzyduhtcpaz.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVqeW94bnJmY2h6eWR1aHRjcGF6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcyNzQ3MzUsImV4cCI6MjA4Mjg1MDczNX0.AWdu8ScAz8MqfzqKlcuxtNUncYq3m5pu59EMhef0-9M';
        const LOCATIONIQ_KEY = 'pk.7fb90bfc2abb6e9b7ac921233aa0d0ce';
        const IMGBB_API_KEY = '7dd3553ba2a58dca14721122d652e484';
        
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        // ðŸ”‘ AUTH STATE LISTENER (REQUIRED)
    supabaseClient.auth.onAuthStateChange((event, session) => {
        handleAuthState(session);
    });

        // --- CONSTANTS & MAPS ---
        const themes = ['#4478A2','#C65265','#D78143','#297381','#89974F','#DAAD60','#757498','#AA7876','#D7A995','#6E917A'];
        const inkPalette = ['#1B4F72', '#78281F', '#186A3B', '#7E5109', '#512E5F', '#4A235A', '#0B5345'];
        
        const stateIcons = { "AZ": "brightness_7", "CA": "beach_access", "PA": "notifications_active", "EU": "public", "NY": "apartment", "FL": "sunny", "TX": "star", "NV": "playing_cards", "WA": "coffee", "HI": "surfing", "CO": "mountain_flag", "MA": "history_edu", "IL": "location_city", "LA": "music_note", "TN": "music_note", "GA": "agriculture", "OR": "forest", "ME": "sailing", "DC": "gavel", "UT": "hiking", "NM": "light_mode", "OH": "flight", "MI": "kayaking", "AK": "ac_unit", "WI": "forest", "VT": "ac_unit", "MT":"landscape", "NE":"psychiatry", "INTL": "public" };
        const defaultIcons = ['explore', 'place', 'map', 'flag', 'travel_explore'];

        const abbrToState = { 
            "AL":"ALABAMA","AK":"ALASKA","AZ":"ARIZONA","AR":"ARKANSAS","CA":"CALIFORNIA","CO":"COLORADO","CT":"CONNECTICUT","DE":"DELAWARE","FL":"FLORIDA","GA":"GEORGIA","HI":"HAWAII","ID":"IDAHO","IL":"ILLINOIS","IN":"INDIANA","IA":"IOWA","KS":"KANSAS","KY":"KENTUCKY","LA":"LOUISIANA","ME":"MAINE","MD":"MARYLAND","MA":"MASSACHUSETTS","MI":"MICHIGAN","MN":"MINNESOTA","MS":"MISSISSIPPI","MO":"MISSOURI","MT":"MONTANA","NE":"NEBRASKA","NV":"NEVADA","NH":"NEW HAMPSHIRE","NJ":"NEW JERSEY","NM":"NEW MEXICO","NY":"NEW YORK","NC":"NORTH CAROLINA","ND":"NORTH DAKOTA","OH":"OHIO","OK":"OKLAHOMA","OR":"OREGON","PA":"PENNSYLVANIA","RI":"RHODE ISLAND","SC":"SOUTH CAROLINA","SD":"SOUTH DAKOTA","TN":"TENNESSEE","TX":"TEXAS","UT":"UTAH","VT":"VERMONT","VA":"VIRGINIA","WA":"WASHINGTON","WV":"WEST VIRGINIA","WI":"WISCONSIN","WY":"WYOMING", "DC": "DISTRICT OF COLUMBIA"
        };
        // Reverse map for lookup
        const stateToAbbr = Object.fromEntries(Object.entries(abbrToState).map(a => a.reverse()));

        let currentUser = null;
        let profileUsername = null; // Stores the username of the logged in user
        let publicViewUser = null; // Stores the username we are currently viewing
        let globalStamps = [];

        // --- AUTH & INIT ---
    window.addEventListener('load', checkRoute);

        window.addEventListener('hashchange', checkRoute);

        function checkRoute() {
            const hash = window.location.hash.replace('#', '').trim();
            if (hash && !hash.includes('access_token')) {
                // Viewing a public profile
                publicViewUser = hash;
                document.getElementById('auth-container').classList.add('hidden');
                document.querySelector('.top-controls').classList.add('hidden'); // Hide controls if viewing other
                document.getElementById('nav-bar').classList.add('hidden'); // Hide controls for public view initially (optional, but requested layout implies controls for owner)
                fetchPublicStamps(hash);
            } else {
                publicViewUser = null;
                initAuth();
            }
        }

        async function initAuth() {
            const { data: { session } } = await supabaseClient.auth.getSession();
            handleAuthState(session);
        }

        async function handleAuthState(session) {
            if (session?.user) {
                currentUser = session.user;
                // Fetch username from profiles
                const { data: profile } = await supabaseClient.from('profiles').select('username').eq('id', currentUser.id).single();
                profileUsername = profile ? profile.username : 'Traveler';
                
                if (!publicViewUser) {
                    document.getElementById('auth-container').classList.add('hidden');
                    document.querySelector('.top-controls').classList.remove('hidden');
                    document.getElementById('nav-bar').classList.remove('hidden');
                    document.getElementById('view-title').innerText = "MassPort";
                    fetchMyStamps();
                }
            } else {
                if (!publicViewUser) {
                    document.getElementById('auth-container').classList.remove('hidden');
                    document.querySelector('.top-controls').classList.add('hidden');
                    document.getElementById('nav-bar').classList.add('hidden');
                }
            }
        }

        async function handleSignUp() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const username = document.getElementById('username').value;
            const msg = document.getElementById('auth-msg');

            if(!username) { msg.innerText = "Username is required"; return; }

            const { data, error } = await supabaseClient.auth.signUp({ 
                email, 
                password,
                options: { data: { username: username } } // Store in metadata to trigger profile creation
            });
            
            if (error) msg.innerText = error.message;
            else msg.innerText = "Confirmation link sent to your email!";
        }

        async function handleLogin() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const msg = document.getElementById('auth-msg');
            
            const { error } = await supabaseClient.auth.signInWithPassword({ email, password });
            if (error) msg.innerText = error.message;
        }

        async function handleLogout() {
            await supabaseClient.auth.signOut();
            window.location.hash = '';
            location.reload();
        }

        // --- DATA FETCHING ---
        async function fetchMyStamps() {
            const { data } = await supabaseClient.from('stamps').select('*').eq('user_id', currentUser.id).order('created_at', {ascending: true});
            processStamps(data, true);
        }

        async function fetchPublicStamps(username) {
            document.getElementById('view-title').innerText = `@${username}`;
            const { data: profile } = await supabaseClient.from('profiles').select('id').eq('username', username).single();
            if (profile) {
                const { data } = await supabaseClient.from('stamps').select('*').eq('user_id', profile.id).order('created_at', {ascending: true});
                processStamps(data, false);
            } else {
                alert("User not found");
            }
        }

        function processStamps(data, isOwner) {
            globalStamps = [];
            const groups = {}; // Key: "AZ" or "INTL", Value: Count

            // 1. Group logic
            data.forEach(s => {
                let groupKey = "INTL";
                if (s.country_code === 'US' || s.country_code === 'USA' || s.country_code === 'us') {
                    // Try to get state abbreviation
                    if (s.state_code && s.state_code.length === 2) groupKey = s.state_code;
                    else if (stateToAbbr[s.full_state_name]) groupKey = stateToAbbr[s.full_state_name];
                    else groupKey = "USA"; // Fallback
                }
                
                s._groupKey = groupKey;
                groups[groupKey] = (groups[groupKey] || 0) + 1;
            });

            // 2. Sort: USA States alphabetical, then INTL
            data.sort((a, b) => {
                if (a._groupKey === "INTL" && b._groupKey !== "INTL") return 1;
                if (a._groupKey !== "INTL" && b._groupKey === "INTL") return -1;
                if (a._groupKey === b._groupKey) return 0;
                return a._groupKey.localeCompare(b._groupKey);
            });

            // 3. Insert Separators
            let lastGroup = null;
            let inkIdx = 0;
            
            data.forEach(s => {
                if (s._groupKey !== lastGroup) {
                    globalStamps.push({ 
                        type: 'ink', 
                        code: s._groupKey, 
                        color: inkPalette[inkIdx % inkPalette.length],
                        full: abbrToState[s._groupKey] || (s._groupKey === 'INTL' ? 'INTERNATIONAL' : s._groupKey)
                    });
                    lastGroup = s._groupKey;
                    inkIdx++;
                }
                globalStamps.push({ ...s, type: 'paper' });
            });

            renderGrid(globalStamps);
            renderNav(groups);
        }

        // --- RENDERING ---
        function renderGrid(items) {
            const grid = document.getElementById('main-grid');
            grid.innerHTML = '';

            items.forEach((item, i) => {
                // Stagger Animation Delay
                const delay = i * 0.05;
                
                if (item.type === 'ink') {
                    const wrap = document.createElement('div');
                    wrap.className = 'stamp-wrapper state-ink-wrapper stagger-in';
                    wrap.style.animationDelay = `${delay}s`;
                    wrap.id = `group-${item.code}`;

                    // Border style randomization
                    const borderStyles = ['solid', 'double', 'dashed'];
                    const bStyle = borderStyles[i % borderStyles.length];
                    const rot = (Math.random() * 10 - 5).toFixed(1);
                    
                    // Icon logic
                    let iconName = stateIcons[item.code] || defaultIcons[i % defaultIcons.length];

                    wrap.innerHTML = `
                        <div class="ink-stamp" style="--ink-color: ${item.color}; --ink-rot: ${rot}deg">
                            <div class="ink-stamp-inner" style="border-style: ${bStyle}">
                                <span class="material-symbols-rounded" style="font-size:36px; margin-bottom:5px;">${iconName}</span>
                                <div class="ink-abbr">${item.code}</div>
                                <div class="ink-full">${item.full}</div>
                            </div>
                        </div>`;
                    grid.appendChild(wrap);

                } else {
                    const wrap = document.createElement('div');
                    wrap.className = 'stamp-wrapper stagger-in';
                    wrap.style.animationDelay = `${delay}s`;

                    const rot = (Math.random() * 6 - 3).toFixed(1);
                    const sealRot = (Math.random() * 30 - 15).toFixed(1);
                    const theme = themes[i % themes.length];
                    
                    // Postmark Text: Just the City
                    const cityText = item.city.split(',')[0].trim();

                    wrap.innerHTML = `
                        <div class="stamp" style="--theme-color: ${theme}; --r_deg: ${rot}deg" onclick="viewStamp(${i})">
                            <div class="stamp-image">
                                ${item.img_url ? `<img src="${item.img_url}">` : `<div class="placeholder pattern-${(i%2)+1}" style="--theme-color: ${theme}"></div>`}
                                <div class="stamp-title-overlay">
                                    <div class="stamp-name">${item.name}</div>
                                    <div class="stamp-note">${item.notes || ''}</div>
                                </div>
                            </div>
                        </div>
                        <div class="postmark-seal" style="--seal-rot: ${sealRot}deg">
                            <div class="pm-line"></div>
                            <div class="pm-city">${cityText}</div>
                            <div class="pm-line"></div>
                        </div>`;
                    grid.appendChild(wrap);
                }
            });
            setupMobileScroll();
        }

        function renderNav(groups) {
            const nav = document.getElementById('filter-nav');
            nav.innerHTML = '';
            
            // Sort keys similar to stamps
            const keys = Object.keys(groups).sort((a,b) => {
                if(a==='INTL') return 1; if(b==='INTL') return -1;
                return a.localeCompare(b);
            });

            keys.forEach(k => {
                const btn = document.createElement('div');
                btn.className = 'nav-tag';
                btn.innerHTML = `${k} <span style="opacity:0.6; font-size:9px; margin-left:2px;">${groups[k]}</span>`;
                btn.onclick = () => scrollToGroup(k, btn);
                nav.appendChild(btn);
            });
        }

        function scrollToGroup(code, btnEl) {
            // Update active state
            document.querySelectorAll('.nav-tag').forEach(t => t.classList.remove('active'));
            if(btnEl) btnEl.classList.add('active');

            const target = document.getElementById(`group-${code}`);
            if (target) {
                target.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'center' });
            }
        }

        // --- UI INTERACTIONS ---
        function viewStamp(idx) {
            // idx in renderGrid refers to globalStamps index
            // Find the actual item in globalStamps
            // Note: globalStamps includes ink separators. We need to pass the actual object or logic.
            // Simplified: The onclick in renderGrid passes the loop index.
            
            const item = globalStamps[idx];
            if (item.type === 'ink') return;

            if(item.img_url) {
                document.getElementById('modal-img').src = item.img_url;
                document.getElementById('modal-caption').innerText = item.name;
                document.getElementById('img-modal').classList.remove('hidden');
            } else if (currentUser) {
                openAddModal(item); 
            }
        }

        function shareProfile() {
            if(!profileUsername) return alert("Please log in first.");
            const url = `${window.location.origin}${window.location.pathname}#${profileUsername}`;
            navigator.clipboard.writeText(url);
            alert("Profile link copied to clipboard!");
        }

        // --- ADD/EDIT LOGIC ---
        function openAddModal(existing = null) {
            document.getElementById('modal-overlay').classList.remove('hidden');
            clearImage();
            
            if(existing) {
                document.getElementById('edit-id').value = existing.id;
                document.getElementById('s-name').value = existing.name;
                document.getElementById('s-address').value = existing.city; 
                document.getElementById('s-notes').value = existing.notes;
                document.getElementById('current-img-url').value = existing.img_url || '';
                if(existing.img_url) {
                    document.getElementById('img-preview').src = existing.img_url;
                    document.getElementById('preview-box').classList.add('has-image');
                }
                document.getElementById('save-btn').innerText = "Update Stamp";
            } else {
                document.getElementById('edit-id').value = '';
                document.getElementById('s-name').value = '';
                document.getElementById('s-address').value = '';
                document.getElementById('s-notes').value = '';
                document.getElementById('save-btn').innerText = "Save Stamp";
            }
        }

        function closeModal() { 
            document.getElementById('modal-overlay').classList.add('hidden'); 
        }

        function previewImage() {
            const file = document.getElementById('s-image-input').files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('img-preview').src = e.target.result;
                    document.getElementById('preview-box').classList.add('has-image');
                }
                reader.readAsDataURL(file);
            }
        }

        function clearImage() {
            document.getElementById('s-image-input').value = '';
            document.getElementById('preview-box').classList.remove('has-image');
            document.getElementById('img-preview').src = '';
            // If editing, logic to clear hidden url if user explicitly removed it could go here, 
            // but simplified for now we just clear the input preview.
        }

        async function saveStamp() {
            const btn = document.getElementById('save-btn');
            const addressInput = document.getElementById('s-address').value;
            if(!addressInput) return alert("Location is required!");

            btn.innerText = "Processing...";
            
            // 1. Geocode
            let finalCity = addressInput;
            let finalStateCode = null;
            let finalStateName = null;
            let finalCountry = 'US'; // Default assumption if parsing fails, but we adjust

            try {
                const res = await fetch(`https://us1.locationiq.com/v1/search?key=${LOCATIONIQ_KEY}&q=${encodeURIComponent(addressInput)}&format=json&addressdetails=1`);
                const data = await res.json();
                
                if(data && data[0]) {
                    const addr = data[0].address;
                    finalCity = addr.city || addr.town || addr.village || addr.county || addressInput.split(',')[0];
                    finalCountry = addr.country_code ? addr.country_code.toUpperCase() : 'INTL';
                    
                    if(finalCountry === 'US' || finalCountry === 'USA') {
                        finalStateCode = addr.state_code ? addr.state_code.toUpperCase() : null;
                        finalStateName = addr.state ? addr.state.toUpperCase() : null;
                    }
                    
                    // Create formatted string for display
                    if(finalStateCode) finalCity = `${finalCity}, ${finalStateCode}`;
                    else finalCity = `${finalCity}, ${addr.country || finalCountry}`;
                }
            } catch(e) {
                console.log("Geocode fail", e);
            }

            // 2. Image Upload
            let imgUrl = document.getElementById('current-img-url').value;
            const file = document.getElementById('s-image-input').files[0];
            
            if (file) {
                btn.innerText = "Uploading Image...";
                const fd = new FormData(); fd.append('image', file);
                const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { method: 'POST', body: fd });
                const json = await res.json();
                imgUrl = json.data.url;
            }

            // 3. Supabase Save
            const payload = {
                name: document.getElementById('s-name').value,
                city: finalCity, // Display string
                country_code: finalCountry,
                state_code: finalStateCode,
                full_state_name: finalStateName,
                notes: document.getElementById('s-notes').value,
                user_id: currentUser.id,
                img_url: imgUrl
            };

            const editId = document.getElementById('edit-id').value;
            if (editId) await supabaseClient.from('stamps').update(payload).eq('id', editId);
            else await supabaseClient.from('stamps').insert([payload]);

            closeModal();
            fetchMyStamps();
        }

        // --- MOBILE SCROLL FX ---
        function setupMobileScroll() {
            if(window.innerWidth > 600) return;
            const grid = document.getElementById('main-grid');
            
            grid.addEventListener('scroll', () => {
                const center = window.innerWidth / 2;
                document.querySelectorAll('.stamp-wrapper').forEach(card => {
                    const rect = card.getBoundingClientRect();
                    const cardCenter = rect.left + rect.width/2;
                    const dist = Math.abs(center - cardCenter);
                    
                    if(dist < 120) {
                        card.classList.add('is-centered');
                        card.style.transform = `scale(1.05)`;
                    } else {
                        card.classList.remove('is-centered');
                        card.style.transform = 'scale(0.9)';
                    }
                });
            });
        }
    </script>
</body>
</html>
