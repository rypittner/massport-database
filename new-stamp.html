<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>MassPort</title>
    <link rel="icon" type="image/x-icon" href="icon_location.png">

    <link href="https://fonts.googleapis.com/css2?family=Special+Elite&family=Yrsa:wght@500;600&family=Inter:wght@400;600;800&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDhkXIYU0gQZA8yYcCOWlfyjgfS33SISrg&libraries=places"></script>

    <style>
        
        /* MASONRY*/
        :root {
    --bg: #FCF1E7; --grid-max: 1200px; 
    --btn-bg: #FFFFFF; --accent: #4478A2; --r: 12px; 
    --ease-out-quint: cubic-bezier(0.23, 1, 0.32, 1);
    --ease-smooth: cubic-bezier(0.2, 0.8, 0.2, 1);
    --stamp-red: #C65265; 
    --ink-gray: #5e666e;
    --ink-hover: #2c333a;
}

* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

html, body {
    margin: 0; padding: 0;
    font-family: 'Inter', sans-serif; 
    background: var(--bg) url("https://www.transparenttextures.com/patterns/cardboard-flat.png"); 
    color: #333; 
    min-height: 100%; width: 100%;
}

body { 
    overflow-x: hidden; 
    overflow-y: auto;
    display: flex; flex-direction: column;
}

/* ---------- TOP CONTROLS ---------- */
.top-controls {
    position: fixed; top: 0; left: 0; right: 0; padding: 20px;
    display: flex; justify-content: space-between;
    align-items: center;
    pointer-events: none; z-index: 15000;
}

.control-group { display: flex; gap: 10px; pointer-events: auto; }

.control-btn {
    background: rgba(255,255,255,0.9);
    backdrop-filter: blur(5px); border: 1px solid rgba(0,0,0,0.1);
    padding: 8px 16px; border-radius: 30px; font-size: 13px; font-weight: 600;
    color: #333; cursor: pointer; transition: 0.2s;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08); display: flex; align-items: center; gap: 5px;
}
.control-btn:hover { transform: translateY(-2px); }

/* ---------- HEADER ---------- */
.header { 
    max-width: var(--grid-max); 
    margin: 60px auto 20px; 
    text-align: center; 
    position: relative; 
    z-index: 10; 
}
.header h1 { font-family: 'Yrsa', serif; font-size: 48px; margin: 0; letter-spacing: -1px; }

/* ---------- MASONRY GRID SYSTEM ---------- */
#main-grid { 
    max-width: var(--grid-max); 
    margin: 0 auto; 
    padding: 20px 20px 140px; 
    width: 100%;
    /* This creates the masonry effect */
    columns: 4 280px; 
    column-gap: 40px;
}

/* Wrapper ensures items don't split between columns */
.stamp-wrapper { 
    display: inline-block;
    width: 100%;
    margin-bottom: 40px; 
    position: relative;
    transition: transform 0.4s var(--ease-smooth);
    break-inside: avoid;
}

.stamp-wrapper:hover {
    transform: translateY(-8px) scale(1.02);
    z-index: 100;
}

/* ---------- STAMP VISUALS (WITH IMAGE) ---------- */
.stamp {
    aspect-ratio: 39 / 50; 
    background-image: url('https://raw.githubusercontent.com/rypittner/massport-database/main/stamp_bg.svg');
    background-size: 100% 100%;
    background-repeat: no-repeat;
    position: relative; 
    transform: rotate(var(--r_deg, 0deg));
    filter: drop-shadow(2px 5px 10px rgba(0,0,0,0.1));
    transition: transform 0.4s var(--ease-smooth);
}

.stamp-image { 
    position: absolute; 
    inset: 6% 7.689%; 
    overflow: hidden; 
    background: var(--theme-color);
    border: 4px solid var(--theme-color);
}
.stamp-image img { width: 100%; height: 100%; object-fit: cover; display: block; }

/* ---------- INFO CARD (WITHOUT IMAGE) ---------- */
.info-card {
    background: #fff;
    padding: 25px;
    border-radius: 2px;
    border-left: 6px solid var(--theme-color);
    box-shadow: 2px 4px 15px rgba(0,0,0,0.08);
    transform: rotate(var(--r_deg, 0deg));
    position: relative;
    min-height: 180px;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
}
.info-card::after {
    content: ""; position: absolute; inset: 0;
    background: url("https://www.transparenttextures.com/patterns/natural-paper.png");
    opacity: 0.4; pointer-events: none;
}

/* ---------- DETAILS & NOTES ---------- */
.stamp-details {
    padding: 15px 5px 5px;
    text-align: center;
}

.stamp-name { 
    font-family: 'Yrsa', serif; font-size: 20px; font-weight: 600; line-height: 1.2; 
    margin: 0; color: #1a1a1a;
}

.stamp-note { 
    font-size: 12px; line-height: 1.4; color: #555;
    opacity: 0; max-height: 0; overflow: hidden;
    transition: all 0.4s var(--ease-smooth);
    margin-top: 0;
}

.stamp-wrapper:hover .stamp-note {
    opacity: 1; max-height: 150px; margin-top: 10px;
}

/* ---------- POSTMARK SEAL ---------- */
.postmark-seal {
    position: absolute; top: -15px; right: -25px; width: 110px; height: 110px;
    border: 4px solid var(--stamp-red); border-radius: 50%;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    font-family: 'Special Elite'; color: var(--stamp-red);
    background: rgba(255,255,255,0.98); z-index: 2000;
    transform: scale(0.6) rotate(var(--seal-rot, 15deg)); 
    opacity: 0; transition: all 0.4s var(--ease-out-quint);
    box-shadow: 0 5px 15px rgba(0,0,0,0.1); 
    cursor: pointer; text-decoration: none !important;
}
.postmark-seal::after {
    content: ""; position: absolute; inset: 4px; 
    border: 2px solid var(--stamp-red); border-radius: 50%; pointer-events: none;
}

.stamp-wrapper:hover .postmark-seal {
    opacity: 1; transform: scale(0.9) rotate(var(--seal-rot)) translateY(-5px);
}

.pm-line { width: 80%; height: 1px; background: var(--stamp-red); margin: 4px 0; }
.pm-city { font-size: 12px; font-weight: 900; text-transform: uppercase; line-height: 1.1; }

/* ---------- MOBILE SCROLLING OVERRIDE ---------- */
@media (max-width: 600px) {
    #main-grid { 
        display: flex; flex-wrap: nowrap; overflow-x: auto; 
        scroll-snap-type: x mandatory; height: 80vh; 
        align-items: center; padding: 0 40px; gap: 20px;
        columns: auto; /* Disable columns on mobile */
    }
    .stamp-wrapper { flex: 0 0 80vw; scroll-snap-align: center; margin-bottom: 0; }
    .postmark-seal, .stamp-note { opacity: 1; max-height: 100px; }
}

/* ---------- MODALS & BUTTONS ---------- */
.bottom-ui-container {
    position: fixed; bottom: 35px; left: 0; right: 0;
    display: flex; justify-content: center; align-items: center; gap: 10px;
    z-index: 16000; pointer-events: none;
}
.collector-nav-container {
    pointer-events: auto; background: rgba(255, 255, 255, 0.95);
    padding: 6px; border-radius: 50px; border: 1px solid rgba(0,0,0,0.1);
    box-shadow: 0 10px 40px rgba(0,0,0,0.15); display: flex; align-items: center;
}
.add-btn { 
    background: var(--accent); color: white; border: none; 
    width: 38px; height: 38px; border-radius: 50%; display: flex; 
    align-items: center; justify-content: center; cursor: pointer;
}
.modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(8px); display: flex; align-items: center; justify-content: center; z-index: 20000; }
.modal-content { background: white; padding: 30px; border-radius: 20px; width: 90%; max-width: 400px; position: relative; }
    </style>
</head>
<body>

    <div class="header-info-mobile">
        <div class="user-pill" onclick="openProfileModal()">
            <span id="mobile-user-pill-text">Loading...</span>
        </div>
    </div>

    <div class="top-controls">
        <div class="control-group">
            <div class="control-btn" id="share-btn-desktop" onclick="shareProfile()">
                <span class="material-symbols-rounded">ios_share</span> <span>Share</span>
            </div>
        </div>
        
        <div class="control-group" id="user-controls">
             </div>
    </div>

    <div class="header">
        <h1 id="view-title">MassPort</h1>
        <p style="font-size:13px; opacity:0.6; letter-spacing: 1px;">TRAVEL ARCHIVE</p>
    </div>

    <div id="login-modal" class="modal-overlay hidden">
        <div class="auth-card">
            <h2 style="text-align:center; font-family: 'Yrsa'; font-size: 32px; margin-bottom: 20px;">Welcome Back</h2>
            <input type="text" id="login-input" placeholder="Email">
            <input type="password" id="login-password" placeholder="Password">
            <button class="primary-btn" onclick="handleLogin()">Log In</button>
            <div class="auth-switch" onclick="switchAuthMode('signup')">New here? Create Account</div>
            <p id="login-msg" style="font-size:11px; color:#c65265; text-align:center; margin-top:10px;"></p>
        </div>
    </div>

    <div id="signup-modal" class="modal-overlay hidden">
        <div class="auth-card">
            <h2 style="text-align:center; font-family: 'Yrsa'; font-size: 32px; margin-bottom: 20px;">Create Passport</h2>
            <input type="email" id="signup-email" placeholder="Email Address">
            <input type="text" id="signup-username" placeholder="Username (Unique)">
            <input type="text" id="signup-displayname" placeholder="Display Name">
            <input type="password" id="signup-password" placeholder="Password">
            <label style="font-size:11px; font-weight:700; color:#555; margin-top:10px; display:block;">PROFILE PHOTO</label>
            <input type="file" id="signup-photo" accept="image/*">
            <button class="primary-btn" onclick="handleSignUp()">Create Account</button>
            <div class="auth-switch" onclick="switchAuthMode('login')">Already have a passport? Log In</div>
            <p id="signup-msg" style="font-size:11px; color:#c65265; text-align:center; margin-top:10px;"></p>
        </div>
    </div>

    <div id="profile-modal" class="modal-overlay hidden">
        <div class="auth-card">
            <h2 style="text-align:center; font-family: 'Yrsa'; font-size: 28px; margin-bottom: 15px;">Edit Profile</h2>
            <label style="font-size:11px; font-weight:700; color:#555;">DISPLAY NAME</label>
            <input type="text" id="edit-displayname">
            <label style="font-size:11px; font-weight:700; color:#555;">USERNAME</label>
            <input type="text" id="edit-username">
            <label style="font-size:11px; font-weight:700; color:#555; margin-top:10px; display:block;">NEW PHOTO</label>
            <input type="file" id="edit-photo-file" accept="image/*">
            <button class="primary-btn" id="save-profile-btn" onclick="saveProfile()">Save Changes</button>
            <button class="primary-btn secondary-btn" onclick="closeProfileModal()">Cancel</button>
            <button class="primary-btn" style="background:transparent; color:#c65265; border:1px solid #c65265; margin-top:15px;" onclick="handleLogout()">Logout</button>
        </div>
    </div>

    <div id="main-grid"></div>

    <div class="nav-zone-left" onclick="scrollGrid(-1)"></div>
    <div class="nav-zone-right" onclick="scrollGrid(1)"></div>

    <div class="bottom-ui-container">
        <div id="mobile-share-btn" class="mobile-share-trigger" onclick="shareProfile()">
             <span class="material-symbols-rounded" style="font-size:18px;">ios_share</span>
        </div>

        <div id="nav-bar" class="collector-nav-container">
            <div class="collector-nav" id="filter-nav"></div>
            <button class="add-btn hidden" id="add-stamp-btn" onclick="openAddModal()">+</button>
        </div>
    </div>

    <div id="modal-overlay" class="modal-overlay hidden">
        <input type="hidden" id="geo-city">
        <input type="hidden" id="geo-state-code">
         <input type="hidden" id="geo-state-name">
        <input type="hidden" id="geo-country">
        <div class="modal-content">
            <div id="map-preview" style="height: 100px; width: 100%; border-radius: 12px; margin-bottom: 15px; background: #eee;"></div>
            
            <div class="modal-header">
                <button onclick="closeModal()" class="close-btn">
    <span class="material-symbols-rounded">close</span>
</button>
            </div>
    
            <div class="form-group">
                <label class="add-label">Search for Holy Site</label>
                <input id="s-address" type="text" placeholder="Search for a church, chapel, or holy site...">
            </div>
    
            <div class="form-group">
                <label class="add-label">Holy Site Name</label>
                <input id="s-name" type="text" placeholder="e.g. St. Anthony of Padua">
            </div>
    
            <div class="form-group">
                <label class="add-label">Notes (Optional)</label>
                <textarea id="s-notes" rows="2" placeholder="What makes this holy site special to you?"></textarea>
            </div>
    
            <input type="hidden" id="edit-id">
            <input type="hidden" id="current-img-url">
            <input type="hidden" id="geo-city">
            <input type="hidden" id="geo-state-code">
            <input type="hidden" id="geo-state-name">
            <input type="hidden" id="geo-country">
    
            <div class="form-group">
                <div id="preview-box" onclick="document.getElementById('s-image-input').click()">
                    <img id="img-preview" src="">
                    <div class="upload-placeholder add-label">
                        <span class="material-symbols-rounded">add_a_photo</span> Add Photo
                    </div>
                </div>
                <input style="height: 100px" type="file" id="s-image-input" hidden accept="image/*" onchange="previewImage()">
            </div>
    
            <button id="save-btn" class="primary-btn" onclick="saveStamp()">Save Stamp</button>
        </div>
    </div>

    <div id="img-modal" class="modal-overlay hidden" onclick="this.classList.add('hidden')">
        <div style="position:relative; width:100%; height:100%; display:flex; flex-direction:column; align-items:center; justify-content:center; pointer-events:none;">
            <img id="modal-img" style="max-width:90%; max-height:80vh; border:10px solid white; box-shadow:0 0 50px black; pointer-events:auto;">
            <h2 id="modal-caption" style="color:white; font-family:'Yrsa'; margin-top:20px; text-shadow:0 2px 4px black; text-align:center;"></h2>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://ujyoxnrfchzyduhtcpaz.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVqeW94bnJmY2h6eWR1aHRjcGF6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcyNzQ3MzUsImV4cCI6MjA4Mjg1MDczNX0.AWdu8ScAz8MqfzqKlcuxtNUncYq3m5pu59EMhef0-9M';
        const LOCATIONIQ_KEY = 'pk.7fb90bfc2abb6e9b7ac921233aa0d0ce';
        const IMGBB_API_KEY = '7dd3553ba2a58dca14721122d652e484';
        
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const themes = ['#4478A2','#C65265','#D78143','#297381','#89974F','#DAAD60','#757498','#AA7876','#D7A995','#6E917A'];
        // Note: Ink stamps are now gray, these colors are used for Nav Tabs
        const stateIcons = { "AZ": "brightness_7", "CA": "beach_access", "PA": "notifications_active", "EU": "public", "NY": "apartment", "FL": "sunny", "TX": "star", "NV": "playing_cards", "WA": "coffee", "HI": "surfing", "CO": "mountain_flag", "MA": "history_edu", "IL": "location_city", "LA": "music_note", "TN": "music_note", "GA": "agriculture", "OR": "forest", "ME": "sailing", "DC": "gavel", "UT": "hiking", "NM": "light_mode", "OH": "flight", "MI": "kayaking", "AK": "ac_unit", "WI": "forest", "VT": "ac_unit", "MT":"landscape", "NE":"psychiatry", "INTL": "public" };
        const defaultIcons = ['explore', 'place', 'map', 'flag', 'travel_explore'];
        const abbrToState = { 
            "AL":"ALABAMA","AK":"ALASKA","AZ":"ARIZONA","AR":"ARKANSAS","CA":"CALIFORNIA","CO":"COLORADO","CT":"CONNECTICUT","DE":"DELAWARE","FL":"FLORIDA","GA":"GEORGIA","HI":"HAWAII","ID":"IDAHO","IL":"ILLINOIS","IN":"INDIANA","IA":"IOWA","KS":"KANSAS","KY":"KENTUCKY","LA":"LOUISIANA","ME":"MAINE","MD":"MARYLAND","MA":"MASSACHUSETTS","MI":"MICHIGAN","MN":"MINNESOTA","MS":"MISSISSIPPI","MO":"MISSOURI","MT":"MONTANA","NE":"NEBRASKA","NV":"NEVADA","NH":"NEW HAMPSHIRE","NJ":"NEW JERSEY","NM":"NEW MEXICO","NY":"NEW YORK","NC":"NORTH CAROLINA","ND":"NORTH DAKOTA","OH":"OHIO","OK":"OKLAHOMA","OR":"OREGON","PA":"PENNSYLVANIA","RI":"RHODE ISLAND","SC":"SOUTH CAROLINA","SD":"SOUTH DAKOTA","TN":"TENNESSEE","TX":"TEXAS","UT":"UTAH","VT":"VERMONT","VA":"VIRGINIA","WA":"WASHINGTON","WV":"WEST VIRGINIA","WI":"WISCONSIN","WY":"WYOMING", "DC": "DISTRICT OF COLUMBIA"
        };
        const stateToAbbr = Object.fromEntries(Object.entries(abbrToState).map(a => a.reverse()));

        let currentUser = null;
        let userProfile = null;
        let publicViewUser = null; 
        let globalStamps = [];
        let globalGroups = {};
        let initialLoadComplete = false;
        let currentFilter = 'ALL';

        window.addEventListener('load', () => {
            const hash = window.location.hash;
            if (hash && hash.includes('access_token')) {
                supabaseClient.auth.getSession().then(({ data: { session } }) => {
                    handleAuthState(session);
                    history.replaceState(null, null, ' ');
                });
            } else {
                checkRoute();
            }
        });

        window.addEventListener('hashchange', checkRoute);

        function checkRoute() {
            const hash = window.location.hash.replace('#', '').trim();
            if (hash && !hash.includes('access_token')) {
                publicViewUser = hash;
                document.getElementById('add-stamp-btn').classList.add('hidden');
                document.getElementById('login-modal').classList.add('hidden');
                document.getElementById('signup-modal').classList.add('hidden');
                document.getElementById('mobile-share-btn').classList.remove('hidden'); 
                
                fetchPublicStamps(hash);
                
                supabaseClient.auth.getSession().then(({ data: { session } }) => {
                    renderHeader(session?.user || null);
                });
            } else {
                publicViewUser = null;
                initAuth();
            }
        }

        async function initAuth() {
            const { data: { session } } = await supabaseClient.auth.getSession();
            handleAuthState(session);
        }

        async function handleAuthState(session) {
            if (session?.user) {
                currentUser = session.user;
                
                const { data: profile, error } = await supabaseClient
                    .from('profiles')
                    .select('*')
                    .eq('id', currentUser.id)
                    .single();

                if (error || !profile) {
                    const { data: newProfile } = await supabaseClient
                        .from('profiles')
                        .upsert({ 
                            id: currentUser.id, 
                            display_name: currentUser.email.split('@')[0],
                            username: 'user_' + Math.floor(Math.random() * 10000),
                            updated_at: new Date()
                        }, { onConflict: 'id' })
                        .select()
                        .single();
                    userProfile = newProfile;
                } else {
                    userProfile = profile;
                }

                document.getElementById('login-modal').classList.add('hidden');
                document.getElementById('signup-modal').classList.add('hidden');
                
                if (!publicViewUser) {
                    renderHeader(currentUser);
                    document.getElementById('add-stamp-btn').classList.remove('hidden');
                    document.getElementById('mobile-share-btn').classList.remove('hidden');
                    document.getElementById('view-title').innerText = "MassPort";
                    document.getElementById('mobile-user-pill-text').innerText = `@${userProfile?.username || 'me'}`;
                    fetchMyStamps();
                } else {
                    renderHeader(currentUser); 
                }
            } else {
                currentUser = null;
                userProfile = null;
                renderHeader(null);
                if (!publicViewUser) {
                    document.getElementById('login-modal').classList.remove('hidden');
                }
            }
        }

        function renderHeader(user) {
            const container = document.getElementById('user-controls');
            container.innerHTML = '';
            
            if(user && userProfile) {
                const btn = document.createElement('div');
                btn.className = 'control-btn profile-pic-btn';
                btn.onclick = openProfileModal;
                btn.innerHTML = `
                    <img src="${userProfile.avatar_url || 'https://via.placeholder.com/150'}" class="profile-thumb">
                    <span class="desktop-only" style="margin-left:5px;">Logout / Edit</span>
                `;
                container.appendChild(btn);
            } else if (!publicViewUser) {
                // Login flow in modal
            } else {
                 const btn = document.createElement('div');
                 btn.className = 'control-btn';
                 btn.innerText = "Log In";
                 btn.onclick = () => { window.location.hash = ''; location.reload(); };
                 container.appendChild(btn);
            }
        }

        function switchAuthMode(mode) {
            document.getElementById('login-modal').classList.add('hidden');
            document.getElementById('signup-modal').classList.add('hidden');
            document.getElementById(`${mode}-modal`).classList.remove('hidden');
        }

        async function handleLogin() {
            const input = document.getElementById('login-input').value;
            const password = document.getElementById('login-password').value;
            const msg = document.getElementById('login-msg');
            msg.innerText = "Logging in...";

            const { error } = await supabaseClient.auth.signInWithPassword({ email: input, password });
            if (error) msg.innerText = error.message;
            else location.reload();
        }

        async function handleSignUp() {
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            const username = document.getElementById('signup-username').value;
            const displayName = document.getElementById('signup-displayname').value;
            const file = document.getElementById('signup-photo').files[0];
            const msg = document.getElementById('signup-msg');

            if(!username || !email || !password) { msg.innerText = "All fields required"; return; }
            msg.innerText = "Creating account...";

            let avatarUrl = '';
            if (file) {
                const fd = new FormData(); fd.append('image', file);
                try {
                    const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { method: 'POST', body: fd });
                    const json = await res.json();
                    if(json.data) avatarUrl = json.data.url;
                } catch(e) { console.error(e); }
            }

            const { data: authData, error: authError } = await supabaseClient.auth.signUp({ email, password });

            if (authError) {
                msg.innerText = authError.message;
                return;
            }

            if (authData.user) {
                const { error: profileError } = await supabaseClient.from('profiles').upsert({
                    id: authData.user.id,
                    username: username,
                    display_name: displayName,
                    avatar_url: avatarUrl,
                    updated_at: new Date()
                }, { onConflict: 'id' });

                if (profileError) msg.innerText = "Profile error: " + profileError.message;
                else msg.innerText = "Success! Please check email.";
            }
        }
        
async function handleLogout() {
    try {
        await supabaseClient.auth.signOut();
    } catch (e) {
        console.error("Logout error", e);
    } finally {
        localStorage.clear();
        window.location.hash = '';
        window.location.reload(); // Forces the page to reset
    }
}
        function openProfileModal() {
            // Works for both desktop button and mobile pill
            if(currentUser && userProfile) {
                document.getElementById('edit-displayname').value = userProfile.display_name || '';
                document.getElementById('edit-username').value = userProfile.username || '';
                document.getElementById('profile-modal').classList.remove('hidden');
            } else if (!currentUser) {
                document.getElementById('login-modal').classList.remove('hidden');
            }
        }
        function closeProfileModal() { document.getElementById('profile-modal').classList.add('hidden'); }

        async function saveProfile() {
            const btn = document.getElementById('save-profile-btn');
            btn.innerText = "Saving...";
            const newName = document.getElementById('edit-displayname').value;
            const newUser = document.getElementById('edit-username').value;
            const file = document.getElementById('edit-photo-file').files[0];
            let updates = { display_name: newName, username: newUser, updated_at: new Date() };
            if(file) {
                 const fd = new FormData(); fd.append('image', file);
                 const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { method: 'POST', body: fd });
                 const json = await res.json();
                 if(json.data) updates.avatar_url = json.data.url;
            }
            const { error } = await supabaseClient.from('profiles').update(updates).eq('id', currentUser.id);
            if(error) alert(error.message);
            else location.reload();
        }

        async function fetchMyStamps() {
            const { data } = await supabaseClient.from('stamps').select('*').eq('user_id', currentUser.id).order('created_at', {ascending: true});
            processStamps(data);
        }

        async function fetchPublicStamps(username) {
            document.getElementById('view-title').innerText = `@${username}`;
            const { data: profile } = await supabaseClient.from('profiles').select('*').eq('username', username).single();
            if (profile) {
                document.getElementById('mobile-user-pill-text').innerText = `@${profile.username}`;
                const { data } = await supabaseClient.from('stamps').select('*').eq('user_id', profile.id).order('created_at', {ascending: true});
                processStamps(data);
            } else {
                alert("User not found: " + username);
            }
        }

        function processStamps(data) {
            globalStamps = [];
            globalGroups = {};

            data.forEach(s => {
                let groupKey = "INTL";
                if (s.country_code === 'US' || s.country_code === 'USA' || s.country_code === 'us') {
                    if (s.state_code && s.state_code.length === 2) groupKey = s.state_code;
                    else if (stateToAbbr[s.full_state_name]) groupKey = stateToAbbr[s.full_state_name];
                    else groupKey = "USA";
                }
                s._groupKey = groupKey;
                globalGroups[groupKey] = (globalGroups[groupKey] || 0) + 1;
            });

            data.sort((a, b) => {
                if (a._groupKey === "INTL" && b._groupKey !== "INTL") return 1;
                if (a._groupKey !== "INTL" && b._groupKey === "INTL") return -1;
                if (a._groupKey === b._groupKey) return 0;
                return a._groupKey.localeCompare(b._groupKey);
            });

            globalStamps = data;
            renderGrid(globalStamps); 
            renderNav(globalGroups);
            setTimeout(() => { initialLoadComplete = true; }, 1000);
        }

        function renderGrid(items, animate = false) {
            const grid = document.getElementById('main-grid');
            grid.innerHTML = '';
            
            let displayList = [];
            let lastGroup = null;

            items.forEach(s => {
                if (s._groupKey !== lastGroup) {
                    displayList.push({ 
                        type: 'ink', 
                        code: s._groupKey, 
                        full: abbrToState[s._groupKey] || (s._groupKey === 'INTL' ? 'INTERNATIONAL' : s._groupKey)
                    });
                    lastGroup = s._groupKey;
                }
                displayList.push({ ...s, type: 'paper' });
            });

            displayList.forEach((item, i) => {
                const shouldAnimate = !initialLoadComplete || animate;
                const delay = shouldAnimate ? i * 0.05 : 0;
                const animClass = shouldAnimate ? 'stagger-in' : '';

                if (item.type === 'ink') {
                    const wrap = document.createElement('div');
                    wrap.className = `stamp-wrapper state-ink-wrapper ${animClass}`;
                    if(shouldAnimate) wrap.style.animationDelay = `${delay}s`;
                    wrap.id = `group-${item.code}`;

                    const borderStyles = ['solid', 'double', 'dashed', 'dotted'];
                    const bStyle = borderStyles[Math.floor(Math.random() * borderStyles.length)];
                    
                    const shapes = ['4px', '20px', '0 20px 0 20px', '20px 0 20px 0', '5px 20px 5px 20px'];
                    const bRadius = shapes[Math.floor(Math.random() * shapes.length)];

                    const isMobile = window.innerWidth <= 600;
                    const rot = 0; //isMobile ? 0 : (Math.random() * 10 - 5).toFixed(1);
                    let iconName = stateIcons[item.code] || defaultIcons[i % defaultIcons.length];

const hasNotes = item.notes && item.notes.trim() !== "";

wrap.innerHTML = `
    <div class="stamp-wrapper" style="--theme-color: ${theme}; --r_deg: ${rot}deg">
        
        ${item.img_url ? `
            <div class="stamp">
                <div class="stamp-image">
                    <img src="${item.img_url}" loading="lazy">
                </div>
            </div>
        ` : `
            <div class="info-card">
                <div>
                    <div class="add-label" style="color: var(--theme-color)">Log Entry</div>
                    <div class="stamp-name" style="text-align: left; margin-top: 5px;">${item.name}</div>
                </div>
                <div style="font-size: 10px; opacity: 0.5; font-family: 'Special Elite'; letter-spacing: 1px;">
                    EST. 2026 / NO-IMG-DATA
                </div>
            </div>
        `}

        <a href="https://www.google.com/maps/search/${encodeURIComponent(item.city)}" 
           target="_blank" 
           class="postmark-seal" 
           style="--seal-rot: ${sealRot}deg">
            <div class="pm-line"></div>
            <div class="pm-city">${item.city || 'Unknown'}</div>
            <div class="pm-line"></div>
        </a>

        <div class="stamp-details">
            ${item.img_url ? `<div class="stamp-name">${item.name}</div>` : ''}
            ${hasNotes ? `<div class="stamp-note">${item.notes}</div>` : ''}
        </div>
    </div>`;
                    grid.appendChild(wrap);

                } else {
                    const wrap = document.createElement('div');
                    wrap.className = `stamp-wrapper ${animClass}`;
                    if(shouldAnimate) wrap.style.animationDelay = `${delay}s`;

                    const isMobile = window.innerWidth <= 600;
                    const rot = 0; //isMobile ? 0 : (Math.random() * 6 - 3).toFixed(1);
                    const sealRot = 0; //isMobile ? 0 : (Math.random() * 30 - 15).toFixed(1);
                    const theme = themes[i % themes.length];
                    const cityText = item.city.split(',')[0].trim();
                    const hasNotes = item.notes && item.notes.trim().length > 0;
                    
                    wrap.innerHTML = `
                        <div class="stamp" style="--theme-color: ${theme}; --r_deg: ${rot}deg">
                            <div class="stamp-image">
                                ${item.img_url ? `<img src="${item.img_url}">` : `<div class="placeholder pattern-${(i%2)+1}" style="--theme-color: ${theme}"></div>`}
                            </div>
                        </div>
                            <div class="stamp-title-overlay">
                                <div class="stamp-name">${item.name}</div>
                                ${hasNotes ? `<div class="stamp-note">${item.notes}</div>` : ''}
                            </div>
                        <a href="https://maps.google.com/?q=${encodeURIComponent(item.city)}" target="_blank" class="postmark-seal" style="--seal-rot: ${sealRot}deg">
                            <div class="pm-line"></div>
                            <div class="pm-city">${cityText}</div>
                            <div class="pm-line"></div>
                        </a>`;
                    
                    const stampEl = wrap.querySelector('.stamp');
                    addPressHandlers(stampEl, item);
                    grid.appendChild(wrap);
                }
            });
            setupMobileScroll();
        }

        function addPressHandlers(element, item) {
            let pressTimer;
            const start = (e) => {
                if (e.type === 'click' && e.button !== 0) return;
                pressTimer = setTimeout(() => {
                    if (currentUser && currentUser.id === item.user_id) openAddModal(item);
                }, 800);
            };
            const cancel = (e) => clearTimeout(pressTimer);
            const click = (e) => {
                if(e.target.closest('a')) return;
                if(item.img_url) {
                   document.getElementById('modal-img').src = item.img_url;
                   document.getElementById('modal-caption').innerText = item.name;
                   document.getElementById('img-modal').classList.remove('hidden');
                }
            }
            element.addEventListener('mousedown', start);
            element.addEventListener('touchstart', start);
            element.addEventListener('mouseup', cancel);
            element.addEventListener('mouseleave', cancel);
            element.addEventListener('touchend', cancel);
            element.addEventListener('click', click);
        }

        function renderNav(groups) {
            const nav = document.getElementById('filter-nav');
            nav.innerHTML = '';
            const allBtn = document.createElement('div');
            allBtn.className = 'nav-tag active';
            allBtn.innerHTML = `ALL`;
            allBtn.style.background = '#333';
            allBtn.onclick = () => filterOrScroll('ALL', allBtn);
            nav.appendChild(allBtn);

            const keys = Object.keys(groups).sort((a,b) => {
                if(a==='INTL') return 1; if(b==='INTL') return -1;
                return a.localeCompare(b);
            });

            keys.forEach((k, idx) => {
                const btn = document.createElement('div');
                btn.className = 'nav-tag';
                btn.dataset.code = k;
                // Assign Random Accent Color from Themes
                const color = themes[idx % themes.length];
                btn.dataset.color = color; // Store color
                
                btn.innerHTML = `${k} <span style="opacity:0.6; font-size:9px; margin-left:2px;">${groups[k]}</span>`;
                btn.onclick = () => filterOrScroll(k, btn);
                nav.appendChild(btn);
            });
        }

        function filterOrScroll(code, btnEl) {
            const isMobile = window.innerWidth <= 600;
            document.querySelectorAll('.nav-tag').forEach(t => {
                t.classList.remove('active');
                t.style.background = '#f4f4f4'; // Reset to default
                t.style.color = '#666';
                
                const tCode = t.dataset.code;
                if(tCode) t.innerHTML = `${tCode} <span style="opacity:0.6; font-size:9px; margin-left:2px;">${globalGroups[tCode]}</span>`;
                else t.innerHTML = `ALL`;
            });

            // Set Active Styling
            btnEl.classList.add('active');
            if (code !== 'ALL') {
                btnEl.style.background = btnEl.dataset.color; // Use stored color
                const full = abbrToState[code] || (code === 'INTL' ? 'INTERNATIONAL' : code);
                btnEl.innerText = full + ` (${globalGroups[code]})`;
            } else {
                btnEl.style.background = '#333';
            }

            if (isMobile) {
                if(currentFilter !== 'ALL') {
                     renderGrid(globalStamps, false);
                     currentFilter = 'ALL';
                     setTimeout(() => {
                         const target = document.getElementById(`group-${code}`);
                         if(target) target.scrollIntoView({ behavior: 'smooth', inline: 'center' });
                     }, 100);
                } else {
                    const target = document.getElementById(`group-${code}`);
                    if(target) target.scrollIntoView({ behavior: 'smooth', inline: 'center' });
                }
            } else {
                currentFilter = code;
                if (code === 'ALL') renderGrid(globalStamps, true);
                else {
                    const filtered = globalStamps.filter(s => s._groupKey === code);
                    renderGrid(filtered, true);
                }
            }
        }

        function scrollGrid(dir) {
            const grid = document.getElementById('main-grid');
            const cardWidth = window.innerWidth * 0.8; 
            const gap = 20;
            const scrollAmount = cardWidth + gap;
            grid.scrollBy({ left: dir * scrollAmount, behavior: 'smooth' });
        }

        function shareProfile() {
            if(!userProfile && !publicViewUser) return alert("Please log in first.");
            const usernameToShare = publicViewUser || userProfile.username;
            const baseUrl = window.location.origin + window.location.pathname;
            const url = `${baseUrl}#${usernameToShare}`;
            
            if (navigator.share) {
                navigator.share({ title: 'MassPort', url: url }).catch(console.error);
            } else {
                navigator.clipboard.writeText(url);
                alert("Profile link copied to clipboard!");
            }
        }

        // --- ADD/EDIT LOGIC ---
        // --- ADD/EDIT LOGIC ---
let autocomplete;
let googleMap;
let googleMarker;

// Initialize Google Places & Map Preview
function initGoogleTools() {
    const input = document.getElementById('s-address');
    if (!input) return;

    autocomplete = new google.maps.places.Autocomplete(input);
    
    // Default map view
    const mapEl = document.getElementById('map-preview');
    if (mapEl) {
        googleMap = new google.maps.Map(mapEl, {
            center: { lat: 39.82, lng: -98.57 }, 
            zoom: 3,
            disableDefaultUI: true,
            styles: [{ featureType: "poi", elementType: "labels", stylers: [{ visibility: "off" }] }]
        });
        googleMarker = new google.maps.Marker({ map: googleMap });
    }

    autocomplete.addListener('place_changed', () => {
        const place = autocomplete.getPlace();
        if (!place.geometry) return;

        // Auto-fill Name field
        document.getElementById('s-name').value = place.name;
        
        // Update Map Preview
        googleMap.setCenter(place.geometry.location);
        googleMap.setZoom(13);
        googleMarker.setPosition(place.geometry.location);

        // Parse Address Components for Supabase
        let city = '', stateCode = '', stateName = '', country = 'INTL';
        
        if (place.address_components) {
            place.address_components.forEach(c => {
                if (c.types.includes('locality')) city = c.long_name;
                else if (c.types.includes('administrative_area_level_1')) {
                    stateCode = c.short_name;
                    stateName = c.long_name;
                }
                else if (c.types.includes('country')) country = c.short_name;
            });
        }

        // Store in hidden fields for saveStamp to use
        document.getElementById('geo-city').value = city || place.name;
        document.getElementById('geo-state-code').value = stateCode;
        document.getElementById('geo-state-name').value = stateName;
        document.getElementById('geo-country').value = country;
    });
}

// Call this once on page load
window.addEventListener('load', initGoogleTools);

function openAddModal(existing = null) {
    document.getElementById('modal-overlay').classList.remove('hidden');
    clearImage();
    
    // Reset Map View
    if (googleMap) {
        googleMap.setCenter({ lat: 39.82, lng: -98.57 });
        googleMap.setZoom(3);
        googleMarker.setPosition(null);
    }

    if(existing) {
        document.getElementById('edit-id').value = existing.id;
        document.getElementById('s-name').value = existing.name;
        document.getElementById('s-address').value = existing.city; 
        document.getElementById('s-notes').value = existing.notes;
        document.getElementById('current-img-url').value = existing.img_url || '';
        
        // Populate hidden fields from existing data to allow updates without re-searching
        document.getElementById('geo-city').value = existing.city.split(',')[0];
        document.getElementById('geo-state-code').value = existing.state_code || '';
        document.getElementById('geo-state-name').value = existing.full_state_name || '';
        document.getElementById('geo-country').value = existing.country_code || 'US';

        if(existing.img_url) {
            document.getElementById('img-preview').src = existing.img_url;
            document.getElementById('preview-box').classList.add('has-image');
        }
        document.getElementById('save-btn').innerText = "Update Stamp";
    } else {
        document.getElementById('edit-id').value = '';
        document.getElementById('s-name').value = '';
        document.getElementById('s-address').value = '';
        document.getElementById('s-notes').value = '';
        document.getElementById('save-btn').innerText = "Save Stamp";
    }
}

function closeModal() {
    // 1. Hide the modal
    document.getElementById('modal-overlay').classList.add('hidden');

    // 2. CLEAR THE IMAGE (The Fix)
    const preview = document.getElementById('img-preview');
    preview.src = ""; // This empties the image
    
    // 3. Clear the hidden input value so the same file can be re-selected
    document.getElementById('s-image-input').value = "";

    // 4. (Optional) Make sure the "Add Photo" text is visible again
    document.querySelector('.upload-placeholder').style.display = 'block';
}

function previewImage() {
    const file = document.getElementById('s-image-input').files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('img-preview').src = e.target.result;
            document.getElementById('preview-box').classList.add('has-image');
        }
        reader.readAsDataURL(file);
    }
}

function clearImage() {
    document.getElementById('s-image-input').value = '';
    document.getElementById('preview-box').classList.remove('has-image');
    document.getElementById('img-preview').src = '';
}

async function saveStamp() {
    const btn = document.getElementById('save-btn');
    const nameInput = document.getElementById('s-name').value;
    
    if (!nameInput) return alert("Location name is required!");
    
    btn.innerText = "Processing...";

    // 1. IMAGE HANDLING (Canvas Compression)
    let imgUrl = document.getElementById('current-img-url').value;
    const file = document.getElementById('s-image-input').files[0];

    if (file) {
        btn.innerText = "Compressing...";
        const compressImage = (imgFile) => {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.readAsDataURL(imgFile);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_WIDTH = 1200;
                        let width = img.width;
                        let height = img.height;
                        if (width > MAX_WIDTH) {
                            height *= MAX_WIDTH / width;
                            width = MAX_WIDTH;
                        }
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        canvas.toBlob((blob) => { resolve(blob); }, 'image/jpeg', 0.7); 
                    };
                };
            });
        };

        try {
            const compressedBlob = await compressImage(file);
            btn.innerText = "Uploading...";
            const fd = new FormData();
            fd.append('image', compressedBlob, "upload.jpg");
            const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { method: 'POST', body: fd });
            const json = await res.json();
            if (json.data) imgUrl = json.data.url;
        } catch (e) {
            console.error("Image failed", e);
        }
    }

    // 2. SUPABASE SAVE LOGIC (Using Google Data)
    const city = document.getElementById('geo-city').value;
    const stateCode = document.getElementById('geo-state-code').value;
    
    const payload = {
        name: nameInput,
        city: stateCode ? `${city}, ${stateCode}` : city,
        country_code: document.getElementById('geo-country').value || 'US',
        state_code: stateCode,
        full_state_name: document.getElementById('geo-state-name').value,
        notes: document.getElementById('s-notes').value,
        user_id: currentUser.id,
        img_url: imgUrl
    };

    const editId = document.getElementById('edit-id').value;
    if (editId) {
        await supabaseClient.from('stamps').update(payload).eq('id', editId);
    } else {
        await supabaseClient.from('stamps').insert([payload]);
    }

    closeModal();
    fetchMyStamps();
}

function setupMobileScroll() {
    if(window.innerWidth > 600) return;
    const grid = document.getElementById('main-grid');
    grid.addEventListener('scroll', () => {
        const center = window.innerWidth / 2;
        document.querySelectorAll('.stamp-wrapper').forEach(card => {
            const rect = card.getBoundingClientRect();
            const cardCenter = rect.left + rect.width/2;
            const dist = Math.abs(center - cardCenter);
            if(dist < 120) {
                card.classList.add('is-centered');
                card.style.transform = `scale(1)`;
            } else {
                card.classList.remove('is-centered');
                card.style.transform = 'scale(0.9)';
            }
        });
    });
}
    </script>
</body>
</html>
