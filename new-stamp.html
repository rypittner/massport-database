<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MassPort</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        heading: ['Yrsa', 'serif'],
                    }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=Yrsa:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDhkXIYU0gQZA8yYcCOWlfyjgfS33SISrg&libraries=places"></script>

    <style>
        /* Custom Utilities */
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .masonry-grid {
            column-count: 2;
            column-gap: 1rem;
        }
        @media (min-width: 1024px) {
            .masonry-grid { column-count: 3; }
        }
        .masonry-item {
            break-inside: avoid;
            margin-bottom: 1.5rem;
            width: 100%; /* Fix for invisible items */
            display: inline-block; /* Fix for layout */
        }

        /* Stamps */
        .stamp {
            background: white;
            padding: 0.75rem;
            padding-bottom: 2.5rem; /* Instant photo style */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border-radius: 2px;
            transition: transform 0.2s;
            position: relative;
            overflow: hidden;
        }
        .stamp:hover { transform: scale(1.02); z-index: 10; }
        .stamp-image {
            width: 100%;
            aspect-ratio: 1/1; /* Square by default for grid */
            background-color: var(--theme-color, #e5e7eb);
            position: relative;
            overflow: hidden;
        }
        .stamp-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            filter: contrast(1.1) saturate(0.9);
        }
        .stamp-overlay-text {
            position: absolute;
            bottom: 0.5rem;
            left: 0.75rem;
            right: 0.75rem;
            text-align: center;
        }

        /* Journal Card (Text Only) */
        .journal-card {
            background: white;
            padding: 1.5rem;
            border-radius: 4px;
            border-left: 4px solid var(--theme-color, #10b981);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: transform 0.2s;
        }
        .journal-card:active { transform: scale(0.98); }

        /* Decorative Ink Stamp */
        .ink-stamp-deco {
            border: 3px double currentColor;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            text-transform: uppercase;
            color: #d6d3d1; /* stone-300 */
            transform: rotate(-15deg);
            opacity: 0.6;
        }

        /* Navigation */
        .nav-btn.active { color: #064e3b; }
        .nav-btn.active svg { stroke-width: 3px; }

        /* Feed */
        .feed-container-card {
            background: white;
            border: 1px solid #f5f5f4;
            border-radius: 12px;
            overflow: hidden;
            display: flex;
            margin-bottom: 1.5rem;
            height: 180px; /* Fixed height for feed items */
            cursor: pointer;
        }
        .feed-left-visual {
            width: 120px;
            flex-shrink: 0;
            background: #fafaf9;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .feed-left-visual .stamp { transform: scale(0.7) rotate(-5deg); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }

        /* Animation */
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-stone-50 text-stone-800 antialiased h-screen flex flex-col overflow-hidden">

    <div id="auth-screen" class="fixed inset-0 bg-stone-100 z-[100] flex flex-col items-center justify-center p-6 hidden">
        <div class="text-center max-w-sm">
            <div class="flex justify-center mb-6">
                <i data-lucide="plane" class="w-12 h-12 text-emerald-800"></i>
            </div>
            <h1 class="font-heading text-4xl mb-2 text-stone-900">Passport</h1>
            <p class="text-stone-500 mb-8">Your digital travel journal. Collect stamps, share memories.</p>
            <button onclick="signInWithGoogle()" class="w-full py-3 bg-white border border-stone-300 rounded-full font-bold text-stone-700 shadow-sm hover:bg-stone-50 flex items-center justify-center gap-2">
                <img src="https://www.svgrepo.com/show/475656/google-color.svg" class="w-5 h-5">
                Continue with Google
            </button>
            <p id="auth-error" class="text-red-500 text-xs mt-4 hidden"></p>
        </div>
    </div>

    <div id="app-container" class="flex-1 flex overflow-hidden relative opacity-0 transition-opacity duration-500">
        
        <aside class="hidden lg:flex w-64 border-r border-stone-200 bg-white flex-col p-6 z-20">
            <div class="flex items-center gap-2 mb-10">
                <i data-lucide="plane" class="w-6 h-6 text-emerald-900"></i>
                <span class="font-heading text-xl font-bold tracking-tight">Passport</span>
            </div>
            
            <nav class="flex-1 space-y-2">
                <button onclick="switchView('journal')" id="btn-d-journal" class="w-full text-left px-4 py-3 rounded-xl font-bold text-stone-600 hover:bg-stone-50 flex items-center gap-3 transition">
                    <i data-lucide="book" class="w-5 h-5"></i> My Journal
                </button>
                <button onclick="switchView('feed')" id="btn-d-feed" class="w-full text-left px-4 py-3 rounded-xl font-bold text-stone-600 hover:bg-stone-50 flex items-center gap-3 transition">
                    <i data-lucide="compass" class="w-5 h-5"></i> Explore Feed
                </button>
                <button onclick="switchView('find')" id="btn-d-find" class="w-full text-left px-4 py-3 rounded-xl font-bold text-stone-600 hover:bg-stone-50 flex items-center gap-3 transition">
                    <i data-lucide="users" class="w-5 h-5"></i> Find Travelers
                </button>
            </nav>

            <div id="desktop-profile-foot" onclick="openUserProfile(currentUser.id)" class="pt-6 border-t border-stone-100 flex items-center gap-3 cursor-pointer hover:opacity-70 transition">
                </div>
        </aside>

        <main class="flex-1 relative overflow-y-auto overflow-x-hidden hide-scrollbar scroll-smooth" id="main-scroll">
            
            <header class="lg:hidden sticky top-0 bg-stone-50/90 backdrop-blur-md z-30 px-6 py-4 flex items-center justify-between border-b border-stone-100">
                <div class="font-heading text-2xl text-emerald-900">Passport</div>
                <div class="flex gap-4">
                    <button onclick="openUserProfile(currentUser.id)" id="mob-profile-btn"><i data-lucide="user" class="text-stone-600"></i></button>
                </div>
            </header>

            <div id="page-journal" class="page-view px-6 pb-32 lg:p-12 max-w-5xl mx-auto fade-in">
                <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-8 mt-4">
                    <div>
                        <h1 class="font-heading text-4xl mb-1">My Travels</h1>
                        <p class="text-stone-400 text-sm"> <span id="journal-count">0</span> stamps collected</p>
                    </div>
                    <div class="flex gap-2 overflow-x-auto pb-2 hide-scrollbar">
                        <select id="filter-location" onchange="applyJournalFilters()" class="bg-white border border-stone-200 rounded-full px-4 py-2 text-xs font-bold shadow-sm focus:outline-none focus:border-emerald-500">
                            </select>
                        <select id="filter-year" onchange="applyJournalFilters()" class="bg-white border border-stone-200 rounded-full px-4 py-2 text-xs font-bold shadow-sm focus:outline-none">
                            <option value="ALL">All Years</option>
                        </select>
                        <select id="filter-sort" onchange="applyJournalFilters()" class="bg-white border border-stone-200 rounded-full px-4 py-2 text-xs font-bold shadow-sm focus:outline-none">
                            <option value="newest">Newest Added</option>
                            <option value="oldest">Oldest Added</option>
                            <option value="date_desc">Visit Date (Recent)</option>
                            <option value="date_asc">Visit Date (Oldest)</option>
                            <option value="location_asc">Location (A-Z)</option>
                        </select>
                    </div>
                </div>

                <div id="journal-grid" class="masonry-grid w-full">
                    </div>
                
                <div id="journal-empty" class="hidden text-center mt-20">
                    <div class="inline-block p-4 rounded-full bg-stone-100 mb-4"><i data-lucide="stamp" class="w-8 h-8 text-stone-300"></i></div>
                    <h3 class="text-stone-600 font-bold">No stamps found</h3>
                    <p class="text-stone-400 text-sm">Try adjusting your filters or add a new stamp.</p>
                </div>
            </div>

            <div id="page-feed" class="page-view hidden px-6 pb-32 lg:p-12 max-w-3xl mx-auto fade-in">
                <h1 class="font-heading text-4xl mb-8 mt-4">Travel Feed</h1>
                <div id="feed-items" class="space-y-6">
                    </div>
                <button id="feed-load-more" onclick="fetchFeed(true)" class="w-full py-4 mt-8 text-stone-400 font-bold text-xs uppercase tracking-widest hover:text-emerald-700 hidden">Load More</button>
            </div>

            <div id="page-find" class="page-view hidden px-6 pb-32 lg:p-12 max-w-3xl mx-auto fade-in">
                <h1 class="font-heading text-4xl mb-6 mt-4">Find Travelers</h1>
                <div class="relative mb-8">
                    <input type="text" id="user-search-input" onkeyup="debounceSearchUsers()" placeholder="Search by username..." class="w-full pl-12 pr-4 py-4 rounded-2xl bg-white border border-stone-200 shadow-sm focus:outline-none focus:ring-2 focus:ring-emerald-500/20">
                    <i data-lucide="search" class="absolute left-4 top-4 text-stone-400"></i>
                </div>
                
                <div id="following-section" class="mb-8 hidden">
                    <h3 class="text-xs font-bold text-stone-400 uppercase tracking-widest mb-4">People You Follow</h3>
                    <div id="following-list" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                </div>

                <div id="followers-list" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    </div>
            </div>

        </main>

        <button id="fab-add" onclick="openAddModal()" class="fixed bottom-24 right-6 lg:bottom-12 lg:right-12 bg-emerald-900 text-white w-14 h-14 rounded-full shadow-xl flex items-center justify-center hover:bg-emerald-800 transition z-40">
            <i data-lucide="plus" class="w-6 h-6"></i>
        </button>

        <nav id="mobile-nav" class="lg:hidden fixed bottom-0 inset-x-0 bg-white border-t border-stone-200 pb-safe pt-2 px-6 flex justify-between items-center z-40 h-20">
            <button onclick="switchView('journal')" id="btn-journal" class="nav-btn flex flex-col items-center gap-1 text-stone-400 active">
                <i data-lucide="book" class="w-6 h-6"></i>
                <span class="text-[10px] font-bold">Journal</span>
            </button>
            <button onclick="switchView('feed')" id="btn-feed" class="nav-btn flex flex-col items-center gap-1 text-stone-400">
                <i data-lucide="compass" class="w-6 h-6"></i>
                <span class="text-[10px] font-bold">Feed</span>
            </button>
            <button onclick="switchView('find')" id="btn-find" class="nav-btn flex flex-col items-center gap-1 text-stone-400">
                <i data-lucide="users" class="w-6 h-6"></i>
                <span class="text-[10px] font-bold">Find</span>
            </button>
        </nav>
    </div>

    <div id="add-modal-overlay" class="fixed inset-0 bg-stone-900/40 backdrop-blur-sm z-[60] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto shadow-2xl flex flex-col md:flex-row overflow-hidden">
            <div class="p-6 md:p-8 flex-1">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="font-heading text-2xl">New Stamp</h2>
                    <button onclick="closeAddModal()" class="text-stone-400 hover:text-red-500"><i data-lucide="x"></i></button>
                </div>
                
                <div class="space-y-4">
                    <div>
                        <label class="text-[10px] font-bold uppercase tracking-widest text-stone-400">Location</label>
                        <input id="s-address-search" type="text" placeholder="Search city or place..." class="w-full border-b border-stone-200 py-2 text-lg font-bold focus:outline-none focus:border-emerald-500 bg-transparent">
                    </div>
                    
                    <div>
                        <label class="text-[10px] font-bold uppercase tracking-widest text-stone-400">Place Name (Title)</label>
                        <input id="s-name" type="text" placeholder="e.g. Eiffel Tower" class="w-full border-b border-stone-200 py-2 font-heading text-xl focus:outline-none focus:border-emerald-500 bg-transparent">
                    </div>

                    <div class="flex gap-2">
                        <div class="flex-1">
                            <label class="text-[10px] font-bold uppercase tracking-widest text-stone-400">Date</label>
                            <div class="flex gap-2 mt-1">
                                <select id="s-date-month" class="bg-stone-50 rounded p-2 text-xs font-bold w-1/3"><option value="">Month</option><option value="Jan">Jan</option><option value="Feb">Feb</option><option value="Mar">Mar</option><option value="Apr">Apr</option><option value="May">May</option><option value="Jun">Jun</option><option value="Jul">Jul</option><option value="Aug">Aug</option><option value="Sep">Sep</option><option value="Oct">Oct</option><option value="Nov">Nov</option><option value="Dec">Dec</option></select>
                                <input id="s-date-day" type="number" placeholder="DD" class="bg-stone-50 rounded p-2 text-xs font-bold w-1/4">
                                <input id="s-date-year" type="number" placeholder="YYYY" class="bg-stone-50 rounded p-2 text-xs font-bold w-1/3">
                            </div>
                        </div>
                    </div>

                    <div>
                        <label class="text-[10px] font-bold uppercase tracking-widest text-stone-400">Notes</label>
                        <textarea id="s-notes" rows="3" class="w-full bg-stone-50 rounded-xl p-3 mt-1 text-sm focus:outline-none" placeholder="What did you do?"></textarea>
                    </div>

                    <div>
                        <label class="block w-full py-3 border-2 border-dashed border-stone-200 rounded-xl text-center text-xs font-bold text-stone-400 cursor-pointer hover:border-emerald-500 hover:text-emerald-500 transition">
                            <i data-lucide="image" class="inline w-4 h-4 mr-1"></i> Add Photo
                            <input type="file" id="s-image-input" class="hidden" accept="image/*" onchange="previewImage()">
                        </label>
                    </div>
                    
                    <input type="hidden" id="geo-city">
                    <input type="hidden" id="geo-state-code">
                    <input type="hidden" id="geo-state-name">
                    <input type="hidden" id="geo-country">
                    <input type="hidden" id="geo-lat">
                    <input type="hidden" id="geo-lng">

                    <button id="save-btn" onclick="saveStamp()" class="w-full bg-emerald-900 text-white font-bold py-3 rounded-xl hover:bg-emerald-800 transition">Save Stamp</button>
                </div>
            </div>

            <div class="hidden md:block w-64 bg-stone-100 border-l border-stone-200 relative">
                <div id="map-preview" class="w-full h-full opacity-50 mix-blend-multiply grayscale"></div>
                <div id="preview-box" class="absolute inset-0 p-6 flex items-center justify-center hidden z-10 bg-black/50 backdrop-blur-sm">
                    <div class="bg-white p-2 pb-8 shadow-2xl rotate-3 relative max-w-full">
                        <img id="img-preview" class="w-full h-auto max-h-40 object-cover border border-stone-100">
                        <button onclick="clearImage()" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-1"><i data-lucide="x" class="w-3 h-3"></i></button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="view-modal-overlay" class="fixed inset-0 bg-stone-900/60 backdrop-blur-sm z-[70] hidden flex items-center justify-center p-4 transition-opacity duration-300">
        <div id="view-modal-container" class="bg-white rounded-sm w-full max-w-3xl shadow-2xl flex flex-col md:flex-row overflow-hidden relative transform scale-95 transition-transform duration-300 max-h-[90vh]">
            
             <button onclick="closeViewModal()" class="absolute top-4 right-4 z-50 bg-white/80 p-2 rounded-full hover:bg-white text-stone-800 shadow-sm backdrop-blur">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>

            <div class="md:w-1/2 bg-stone-100 relative flex items-center justify-center min-h-[200px]" id="view-visual-side">
                </div>
            
            <div class="p-8 md:w-1/2 flex flex-col overflow-y-auto">
                <div class="flex items-center gap-3 mb-6">
                    <div class="w-10 h-10 rounded-full bg-stone-200 overflow-hidden" id="v-avatar"></div>
                    <div>
                        <div class="text-xs font-bold text-stone-900" id="v-user"></div>
                        <div id="v-date" class="text-[10px] text-stone-400 uppercase tracking-widest"></div>
                    </div>
                </div>

                <div class="mb-auto">
                    <a id="v-map-link" target="_blank" class="text-[10px] font-bold uppercase tracking-widest hover:underline mb-1 block cursor-pointer"></a>
                    <h2 id="v-title" class="font-heading text-3xl md:text-4xl text-stone-800 leading-tight mb-4"></h2>
                    <p id="v-notes" class="text-stone-600 font-serif italic text-lg leading-relaxed"></p>
                </div>
            </div>
        </div>
    </div>

    <div id="profile-modal" class="fixed inset-0 bg-stone-50 z-[50] hidden overflow-y-auto">
        <div class="max-w-5xl mx-auto px-6 py-12">
            <button onclick="closeProfileModal()" class="fixed top-6 right-6 md:top-12 md:right-12 bg-white p-3 rounded-full shadow-md text-stone-500 hover:text-stone-900 z-50">
                <i data-lucide="x"></i>
            </button>

            <div class="text-center mb-12">
                <div class="w-32 h-32 mx-auto rounded-full bg-stone-200 border-4 border-white shadow-lg overflow-hidden mb-4 relative group" id="p-avatar-lg"></div>
                <h1 id="p-name" class="font-heading text-4xl mb-2"></h1>
                <p id="p-username" class="text-stone-400 font-bold text-sm tracking-wide"></p>
                <div id="p-actions" class="mt-6 flex justify-center gap-4"></div>
            </div>
            
            <div class="flex justify-center gap-2 mb-8">
                <select id="p-filter-loc" onchange="renderProfileMasonry()" class="bg-white border border-stone-200 rounded-full px-4 py-2 text-xs font-bold shadow-sm focus:outline-none"></select>
                <select id="p-filter-year" onchange="renderProfileMasonry()" class="bg-white border border-stone-200 rounded-full px-4 py-2 text-xs font-bold shadow-sm focus:outline-none"></select>
                <select id="p-filter-sort" onchange="renderProfileMasonry()" class="bg-white border border-stone-200 rounded-full px-4 py-2 text-xs font-bold shadow-sm focus:outline-none">
                    <option value="newest">Newest</option>
                    <option value="oldest">Oldest</option>
                </select>
            </div>

            <div id="profile-grid" class="masonry-grid w-full pb-20">
                </div>
        </div>
    </div>

    <div id="edit-profile-modal" class="fixed inset-0 bg-stone-900/40 backdrop-blur-sm z-[80] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl p-8 max-w-md w-full">
            <h2 class="font-heading text-2xl mb-4">Edit Profile</h2>
            <div class="space-y-4">
                <input id="ep-name" type="text" placeholder="Display Name" class="w-full border p-2 rounded">
                <input id="ep-avatar" type="text" placeholder="Avatar URL" class="w-full border p-2 rounded">
                <button onclick="saveProfile()" class="w-full bg-emerald-900 text-white font-bold py-2 rounded">Save Changes</button>
                <button onclick="document.getElementById('edit-profile-modal').classList.add('hidden')" class="w-full text-stone-400 py-2 text-xs">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // CONFIG
        const SUPABASE_URL = 'https://ujyoxnrfchzyduhtcpaz.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVqeW94bnJmY2h6eWR1aHRjcGF6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcyNzQ3MzUsImV4cCI6MjA4Mjg1MDczNX0.AWdu8ScAz8MqfzqKlcuxtNUncYq3m5pu59EMhef0-9M';
        const IMGBB_API_KEY = '7dd3553ba2a58dca14721122d652e484';

        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        let currentUser = null;
        let userProfile = null;
        
        let myStamps = [];
        let feedStamps = [];
        let followingIds = [];
        let viewingProfileStamps = []; // For profile view
        
        let feedPage = 0;

        // Theme Colors
        const themes = [
            '#059669', // Emerald
            '#b91c1c', // Red
            '#d97706', // Amber
            '#4338ca', // Indigo
            '#be185d', // Pink
            '#0f766e', // Teal
        ];

        // --- INIT ---
        window.onload = async () => {
            initGoogleTools();
            
            // Check for Public Profile Hash (#@username)
            if(window.location.hash.startsWith('#@')) {
                const username = window.location.hash.substring(2); // remove #@
                // Bypass auth for public view
                document.getElementById('app-container').classList.remove('opacity-0');
                
                // Hide Nav Elements for public viewer
                document.getElementById('mobile-nav').classList.add('hidden');
                document.querySelector('aside').classList.add('hidden');
                document.getElementById('fab-add').classList.add('hidden');
                
                // Try to find that user
                const { data } = await supabaseClient.from('profiles').select('id').eq('username', username).single();
                if(data) {
                    await openUserProfile(data.id);
                } else {
                    alert('User not found');
                }
                
                // Show a small login button in corner
                const loginBtn = document.createElement('button');
                loginBtn.className = "fixed top-4 right-4 z-[100] bg-emerald-900 text-white px-4 py-2 rounded-full text-xs font-bold shadow-lg";
                loginBtn.innerText = "Log In / Sign Up";
                loginBtn.onclick = () => { window.location.hash = ''; location.reload(); };
                document.body.appendChild(loginBtn);
                
                return;
            }

            await checkSession();
        };

        async function checkSession() {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session) {
                document.getElementById('auth-screen').classList.remove('hidden');
            } else {
                currentUser = session.user;
                await fetchUserProfile();
                document.getElementById('app-container').classList.remove('opacity-0');
                document.getElementById('auth-screen').classList.add('hidden');
                
                fetchMyStamps();
                fetchFollowing(); // Prefetch
            }
        }

        async function signInWithGoogle() {
            const { error } = await supabaseClient.auth.signInWithOAuth({ provider: 'google' });
            if (error) document.getElementById('auth-error').innerText = error.message;
        }

        async function handleLogout() {
            await supabaseClient.auth.signOut();
            window.location.reload();
        }

        async function fetchUserProfile() {
            let { data, error } = await supabaseClient.from('profiles').select('*').eq('id', currentUser.id).single();
            // Create profile if first time
            if(!data) {
                const { data: newProfile } = await supabaseClient.from('profiles').insert([
                    { id: currentUser.id, username: currentUser.email.split('@')[0], display_name: currentUser.user_metadata.full_name, avatar_url: currentUser.user_metadata.avatar_url }
                ]).select().single();
                data = newProfile;
            }
            userProfile = data;
            renderDesktopProfile();
        }

        // --- DATA ---
        async function fetchMyStamps() {
            const { data, error } = await supabaseClient.from('stamps').select('*').eq('user_id', currentUser.id).order('created_at', { ascending: false });
            if (data) {
                myStamps = data;
                document.getElementById('journal-count').innerText = myStamps.length;
                populateFilters(myStamps, 'filter-location', 'filter-year');
                applyJournalFilters(); // Renders grid
            }
        }

        async function fetchFollowing() {
            if(!currentUser) return;
            const { data } = await supabaseClient.from('followers').select('following_id').eq('follower_id', currentUser.id);
            followingIds = data ? data.map(r => r.following_id) : [];
            followingIds.push(currentUser.id); // Follow self
        }

        async function fetchFeed(loadMore = false) {
            await fetchFollowing(); // Wait for IDs
            
            if(!currentUser || followingIds.length === 0) return;
            if(!loadMore) { feedStamps = []; feedPage = 0; }
            else feedPage++;

            const PAGE_SIZE = 10;
            const from = feedPage * PAGE_SIZE;
            const to = from + PAGE_SIZE - 1;

            const { data } = await supabaseClient
                .from('stamps')
                .select(`*, profiles(username, display_name, avatar_url, id)`)
                .in('user_id', followingIds)
                .order('created_at', { ascending: false })
                .range(from, to);

            if(data && data.length > 0) {
                feedStamps = [...feedStamps, ...data];
                renderFeedHTML(feedStamps);
                document.getElementById('feed-load-more').classList.remove('hidden');
            } else {
                document.getElementById('feed-load-more').classList.add('hidden');
                if(feedPage === 0) document.getElementById('feed-items').innerHTML = `<p class="text-center text-stone-400 mt-10">Your feed is quiet. Follow others or add a stamp.</p>`;
            }
        }

        // --- FILTERING & GROUPING LOGIC ---
        function populateFilters(stamps, locId, yearId) {
            const locSelect = document.getElementById(locId);
            const yearSelect = document.getElementById(yearId);
            
            const states = new Set();
            const international = new Set();
            
            stamps.forEach(s => {
                // Use state_code/full_state_name logic
                if(!s.state_code) return; // skip nulls
                if(s.state_code === 'INTL') international.add(s.full_state_name || s.country_code); 
                else states.add(s.full_state_name);
            });

            locSelect.innerHTML = '<option value="ALL">All Locations</option>';
            
            // Add Group Options
            if(states.size > 0) locSelect.appendChild(new Option("All United States", "US_ALL"));
            if(international.size > 0) locSelect.appendChild(new Option("All International", "INTL_ALL"));

            if(states.size > 0) {
                const grp = document.createElement('optgroup'); grp.label = "United States";
                [...states].sort().forEach(st => grp.appendChild(new Option(st, st)));
                locSelect.appendChild(grp);
            }
            if(international.size > 0) {
                const grp = document.createElement('optgroup'); grp.label = "International";
                [...international].sort().forEach(c => grp.appendChild(new Option(c, c)));
                locSelect.appendChild(grp);
            }

            // Years logic
            const years = [...new Set(stamps.map(s => {
                if(s.visit_year) return s.visit_year;
                if(s.visit_date && s.visit_date.length >= 4) return s.visit_date.slice(-4);
                return 'Unknown';
            }))].sort().reverse();
            
            yearSelect.innerHTML = '<option value="ALL">All Years</option>';
            years.forEach(y => yearSelect.add(new Option(y, y)));
        }

        function applyJournalFilters() {
            const loc = document.getElementById('filter-location').value;
            const year = document.getElementById('filter-year').value;
            const sort = document.getElementById('filter-sort').value;
            
            renderGrid(myStamps, 'journal-grid', loc, year, sort, 'local');
        }

        function getThemeForId(id) {
            // Hash string to number for deterministic color
            let hash = 0;
            for (let i = 0; i < id.length; i++) {
                hash = id.charCodeAt(i) + ((hash << 5) - hash);
            }
            return themes[Math.abs(hash) % themes.length];
        }

        // Helper to mix Text and Images evenly
        function interleaveStamps(arr) {
            const withImg = arr.filter(s => s.img_url);
            const noImg = arr.filter(s => !s.img_url);
            const result = [];
            let i = 0, j = 0;
            while(i < withImg.length || j < noImg.length) {
                if(i < withImg.length) result.push(withImg[i++]);
                if(j < noImg.length) result.push(noImg[j++]);
            }
            return result;
        }

        function renderGrid(dataset, containerId, filterLoc, filterYear, sortMode, source) {
            const container = document.getElementById(containerId);
            
            // Filter
            let filtered = dataset.filter(s => {
                const sYear = s.visit_year || (s.visit_date ? s.visit_date.slice(-4) : 'Unknown');
                const sLoc = s.state_code === 'INTL' ? (s.full_state_name || s.country_code) : s.full_state_name;
                
                let locMatch = false;
                if(filterLoc === 'ALL') locMatch = true;
                else if(filterLoc === 'US_ALL') locMatch = s.country_code === 'US';
                else if(filterLoc === 'INTL_ALL') locMatch = s.country_code !== 'US';
                else locMatch = sLoc === filterLoc;

                const yearMatch = filterYear === 'ALL' || sYear == filterYear;
                return locMatch && yearMatch;
            });

            // If empty
            if(filtered.length === 0) {
                container.innerHTML = ''; 
                if(containerId === 'journal-grid') document.getElementById('journal-empty').classList.remove('hidden');
                return;
            }
            if(containerId === 'journal-grid') document.getElementById('journal-empty').classList.add('hidden');

            // Sorting
            let grouped = false;

            if(sortMode === 'location_asc') {
                // Sort by Location Code first
                filtered.sort((a, b) => {
                    const locA = a.state_code === 'INTL' ? (a.full_state_name || 'ZZ') : a.state_code;
                    const locB = b.state_code === 'INTL' ? (b.full_state_name || 'ZZ') : b.state_code;
                    return locA.localeCompare(locB);
                });
                grouped = true;
            } else if (sortMode === 'newest') {
                filtered.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            } else if (sortMode === 'oldest') {
                filtered.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
            } else if (sortMode.includes('date')) {
                filtered.sort((a, b) => {
                     const dateA = a.visit_year || 0; 
                     const dateB = b.visit_year || 0;
                     return sortMode === 'date_desc' ? dateB - dateA : dateA - dateB;
                });
            }

            // Render logic
            let html = '';
            let currentGroup = null;
            let groupSubset = [];

            // If grouped, we need to process chunk by chunk to interleave
            if(grouped) {
                // Collect unique groups
                const groups = [...new Set(filtered.map(s => s.state_code))];
                groups.forEach(grp => {
                    let subset = filtered.filter(s => s.state_code === grp);
                    subset = interleaveStamps(subset); // Mix images/text
                    
                    const groupTitle = grp === 'INTL' ? 'INTL' : grp;
                    html += `<div class="masonry-item w-full flex justify-center pt-4 pb-2"><div class="ink-stamp-deco">${groupTitle}</div></div>`;
                    
                    subset.forEach(s => {
                        html += generateStampCard(s, source);
                    });
                });
            } else {
                // Just render standard list
                if(filterLoc === 'ALL' && filterYear === 'ALL') {
                    html += `<div class="masonry-item w-full flex justify-center pt-4 pb-2"><div class="ink-stamp-deco"><i data-lucide="stamp" class="w-10 h-10"></i></div></div>`;
                }
                filtered.forEach(s => {
                    html += generateStampCard(s, source);
                });
            }
            
            container.innerHTML = html;
            lucide.createIcons();
        }

        function generateStampCard(s, source) {
            // Pass ID, source, and isDirectObj based on source type
            return `<div class="masonry-item" onclick="openViewModal('${s.id}', '${source}')">
                    ${createStampCardHTML(s)}
                </div>`;
        }

        function createStampCardHTML(s) {
            const theme = getThemeForId(s.id);
            const cityColor = `style="color: ${theme}"`;
            
            // Format Date String
            let dateStr = "";
            if(s.visit_month && s.visit_day && s.visit_year) dateStr = `${s.visit_month} ${s.visit_day}, ${s.visit_year}`;
            else if(s.visit_month && s.visit_year) dateStr = `${s.visit_month} ${s.visit_year}`;
            else if(s.visit_year) dateStr = `${s.visit_year}`;
            else dateStr = s.visit_date || ''; 

             if (s.img_url) {
                return `
                <div class="stamp w-full" style="--theme-color: ${theme}">
                    <div class="stamp-content-wrapper">
                        <div class="stamp-image">
                            <img src="${s.img_url}">
                        </div>
                        <div class="stamp-overlay-text">
                             <p class="text-[9px] font-bold uppercase tracking-widest opacity-90">${s.city}</p>
                             <h4 class="font-heading text-2xl leading-none">${s.name}</h4>
                        </div>
                    </div>
                </div>`;
            } else {
                return `
                <div class="journal-card w-full inline-block" style="--theme-color: ${theme}">
                    <p class="text-[9px] font-bold uppercase tracking-widest" ${cityColor}>${s.city}</p>
                    <h4 class="font-heading text-2xl leading-tight text-stone-800 ${!s.notes && !dateStr ? 'mb-0' : ''}">${s.name}</h4>
                    ${s.notes ? `<p class="text-[13px] text-stone-500 italic line-clamp-4 leading-relaxed my-1">${s.notes}</p>` : ''}
                    ${dateStr ? `
                    <div class="flex items-center justify-between pt-2 mt-auto">
                        <span class="text-[9px] text-stone-300 font-bold">${dateStr}</span>
                        <i data-lucide="feather" class="w-3 h-3 text-stone-200"></i>
                    </div>` : ''}
                </div>`;
            }
        }

        // --- FEED ---
        function renderFeedHTML(stamps) {
            const container = document.getElementById('feed-items');
            container.innerHTML = stamps.map((s) => {
                const theme = getThemeForId(s.id);
                const u = s.profiles;
                const initials = u.username.substring(0,2).toUpperCase();
                
                // Visual
                const visual = s.img_url 
                    ? `<div class="stamp w-full h-full" style="--theme-color: ${theme}"><div class="stamp-image"><img src="${s.img_url}"></div></div>`
                    : `<div class="w-20 h-20 rounded-full border-2 border-[${theme}] flex items-center justify-center bg-white"><i data-lucide="map-pin" class="text-stone-300"></i></div>`;

                return `
                <div class="feed-container-card" onclick="openViewModal('${s.id}', 'feed')">
                    <div class="feed-left-visual">
                        ${visual}
                    </div>
                    <div class="p-4 md:p-6 flex-1 flex flex-col justify-center border-l border-stone-50">
                        <div class="flex items-center gap-2 mb-2 cursor-pointer group" onclick="event.stopPropagation(); openUserProfile('${s.user_id}')">
                            <div class="w-8 h-8 rounded-full bg-stone-100 flex items-center justify-center text-[10px] font-bold text-stone-500 overflow-hidden border border-white shadow-sm">
                                ${u.avatar_url ? `<img src="${u.avatar_url}" class="w-full h-full object-cover">` : initials}
                            </div>
                            <div>
                                <div class="text-[11px] font-bold text-stone-800 group-hover:text-emerald-700 transition">${u.username}</div>
                                <div class="text-[9px] text-stone-400">added a memory</div>
                            </div>
                        </div>
                        <h3 class="font-heading text-xl text-stone-800 mb-1 leading-none">${s.name}</h3>
                        <p class="text-[10px] font-bold uppercase tracking-widest mb-2" style="color: ${theme}">${s.city}</p>
                        ${s.notes ? `<p class="text-stone-500 text-xs italic line-clamp-2">"${s.notes}"</p>` : ''}
                    </div>
                </div>`;
            }).join('');
            lucide.createIcons();
        }

        // --- SEARCH ---
        async function fetchFindPage() {
            // Populate Following List
            if(!currentUser) return;
            const followingSection = document.getElementById('following-section');
            const followingList = document.getElementById('following-list');
            
            if(followingIds.length > 1) { // >1 because it includes self
                const { data } = await supabaseClient.from('profiles').select('*').in('id', followingIds.filter(id => id !== currentUser.id));
                if(data && data.length > 0) {
                    followingSection.classList.remove('hidden');
                    followingList.innerHTML = renderProfileCards(data);
                }
            } else {
                followingSection.classList.add('hidden');
            }
        }

        async function searchUsers() {
            const query = document.getElementById('user-search-input').value;
            if(query.length < 3) return;
            const { data } = await supabaseClient.from('profiles').select('*').ilike('username', `%${query}%`).limit(10);
            renderSearchResults(data || []);
        }
        let debounceTimer;
        function debounceSearchUsers() { clearTimeout(debounceTimer); debounceTimer = setTimeout(searchUsers, 500); }

        function renderSearchResults(profiles) {
            const list = document.getElementById('followers-list');
            list.innerHTML = renderProfileCards(profiles);
        }

        function renderProfileCards(profiles) {
            return profiles.map(p => {
                const isMe = currentUser && p.id === currentUser.id;
                const isFollowing = followingIds.includes(p.id);
                return `
                <div class="bg-white p-4 rounded-xl flex items-center justify-between border border-stone-100 shadow-sm hover:shadow-md transition cursor-pointer" onclick="openUserProfile('${p.id}')">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-stone-100 overflow-hidden">
                             ${p.avatar_url ? `<img src="${p.avatar_url}" class="w-full h-full object-cover">` : ''}
                        </div>
                        <div>
                            <h4 class="font-bold text-stone-800 text-sm">${p.display_name || p.username}</h4>
                            <p class="text-[10px] text-stone-400 uppercase tracking-widest">@${p.username}</p>
                        </div>
                    </div>
                    ${!isMe && currentUser ? `<button onclick="event.stopPropagation(); toggleFollow('${p.id}', this)" class="${isFollowing ? 'bg-stone-100 text-stone-400' : 'bg-emerald-900 text-white'} px-4 py-1.5 rounded-full text-xs font-bold transition">${isFollowing ? 'Following' : 'Follow'}</button>` : ''}
                </div>`;
            }).join('');
        }

        async function toggleFollow(targetId, btn) {
            const isFollowing = followingIds.includes(targetId);
            if (isFollowing) {
                await supabaseClient.from('followers').delete().match({ follower_id: currentUser.id, following_id: targetId });
                followingIds = followingIds.filter(id => id !== targetId);
                btn.innerText = "Follow"; btn.className = "bg-emerald-900 text-white px-4 py-1.5 rounded-full text-xs font-bold transition";
            } else {
                await supabaseClient.from('followers').insert([{ follower_id: currentUser.id, following_id: targetId }]);
                followingIds.push(targetId);
                btn.innerText = "Following"; btn.className = "bg-stone-100 text-stone-400 px-4 py-1.5 rounded-full text-xs font-bold transition";
            }
            fetchFeed(false);
        }

        // --- PROFILE VIEW ---
        async function openUserProfile(userId) {
            document.getElementById('profile-modal').classList.remove('hidden');
            const isMe = currentUser && userId === currentUser.id;

            const { data: profile } = await supabaseClient.from('profiles').select('*').eq('id', userId).single();
            const { data: stamps } = await supabaseClient.from('stamps').select('*').eq('user_id', userId).order('created_at', {ascending:false});
            viewingProfileStamps = stamps || [];

            // Header
            const initials = profile.username.substring(0,2).toUpperCase();
            document.getElementById('p-avatar-lg').innerHTML = profile.avatar_url ? `<img src="${profile.avatar_url}" class="w-full h-full object-cover">` : `<div class="w-full h-full flex items-center justify-center text-4xl text-stone-400 font-heading">${initials}</div>`;
            document.getElementById('p-name').innerText = profile.display_name;
            document.getElementById('p-username').innerText = `@${profile.username} â€¢ ${viewingProfileStamps.length} Stamps`;

            // Actions
            const actionDiv = document.getElementById('p-actions');
            if(isMe) {
                actionDiv.innerHTML = `
                    <button onclick="document.getElementById('edit-profile-modal').classList.remove('hidden')" class="px-6 py-2 rounded-full border border-stone-200 text-stone-600 font-bold text-xs hover:bg-stone-50">Edit Profile</button>
                    <button onclick="handleLogout()" class="px-6 py-2 rounded-full border border-stone-200 text-red-400 font-bold text-xs hover:bg-stone-50">Log Out</button>
                `;
                document.getElementById('ep-name').value = profile.display_name;
                document.getElementById('ep-avatar').value = profile.avatar_url || '';
            } else if (currentUser) {
                const isFollowing = followingIds.includes(userId);
                actionDiv.innerHTML = `<button onclick="toggleFollow('${userId}', this)" class="${isFollowing ? 'text-stone-400 bg-stone-100' : 'bg-emerald-900 text-white'} px-8 py-2 rounded-full font-bold text-xs transition">${isFollowing ? 'Following' : 'Follow'}</button>`;
            } else {
                actionDiv.innerHTML = '';
            }

            // Populate Filters
            populateFilters(viewingProfileStamps, 'p-filter-loc', 'p-filter-year');
            renderProfileMasonry();
        }

        function renderProfileMasonry() {
            const loc = document.getElementById('p-filter-loc').value;
            const year = document.getElementById('p-filter-year').value;
            const sort = document.getElementById('p-filter-sort').value;
            
            // Pass 'profile' source to direct correct stamps
            renderGrid(viewingProfileStamps, 'profile-grid', loc, year, sort, 'profile');
        }

        async function saveProfile() {
            const name = document.getElementById('ep-name').value;
            const av = document.getElementById('ep-avatar').value;
            await supabaseClient.from('profiles').update({ display_name: name, avatar_url: av }).eq('id', currentUser.id);
            location.reload();
        }
        function closeProfileModal() { document.getElementById('profile-modal').classList.add('hidden'); }

        // --- VIEW MODAL ---
        function openViewModal(id, source) {
            // Find stamp based on ID in specific arrays
            let stamp;
            if(source === 'local') stamp = myStamps.find(s => s.id === id);
            else if(source === 'feed') stamp = feedStamps.find(s => s.id === id);
            else if(source === 'profile') stamp = viewingProfileStamps.find(s => s.id === id);
            else stamp = myStamps.find(s => s.id === id); // Fallback

            if (!stamp) return;

            // Content
            document.getElementById('v-title').innerText = stamp.name;
            const cityLink = document.getElementById('v-map-link');
            cityLink.innerText = stamp.city;
            cityLink.href = `http://maps.google.com/?q=${encodeURIComponent(stamp.name + ', ' + stamp.city)}`;
            
            // Color Logic
            const theme = getThemeForId(stamp.id);
            cityLink.style.color = theme;

            document.getElementById('v-notes').innerText = stamp.notes || ""; 
            
            // Date logic
            let dateStr = "";
            if(stamp.visit_month && stamp.visit_day && stamp.visit_year) dateStr = `${stamp.visit_month} ${stamp.visit_day}, ${stamp.visit_year}`;
            else if(stamp.visit_month && stamp.visit_year) dateStr = `${stamp.visit_month} ${stamp.visit_year}`;
            else if(stamp.visit_year) dateStr = `${stamp.visit_year}`;
            else dateStr = stamp.visit_date || '';

            if(dateStr) {
                document.getElementById('v-date').innerText = dateStr;
                document.getElementById('v-date').classList.remove('hidden');
            } else {
                document.getElementById('v-date').classList.add('hidden');
            }

            // User Info
            let uName, uAv;
            if(currentUser && stamp.user_id === currentUser.id) {
                uName = userProfile.username;
                uAv = userProfile.avatar_url;
            } else if(stamp.profiles) {
                uName = stamp.profiles.username;
                uAv = stamp.profiles.avatar_url;
            } else {
                uName = "Traveler"; uAv = null;
            }
            document.getElementById('v-user').innerText = uName;
            document.getElementById('v-avatar').innerHTML = uAv ? `<img src="${uAv}" class="w-full h-full object-cover">` : "";

            // Visual Side Logic
            const visual = document.getElementById('view-visual-side');
            if(stamp.img_url) {
                // Remove absolute positioning logic that cropped images. Let height grow.
                visual.innerHTML = `<img src="${stamp.img_url}" class="w-full h-auto object-contain max-h-[70vh]">`;
                visual.classList.remove('h-32'); 
            } else {
                // Ink Stamp Background
                const abbrev = stamp.state_code === 'INTL' ? 'INTL' : stamp.state_code;
                visual.innerHTML = `
                    <div class="ink-stamp-deco" style="transform: scale(2.5) rotate(-10deg); opacity: 0.15;">${abbrev}</div>
                `;
                visual.classList.add('h-32'); // Fixed height for text only
            }

            document.getElementById('view-modal-overlay').classList.remove('hidden');
            setTimeout(() => document.getElementById('view-modal-container').classList.remove('scale-95'), 10);
        }

        function closeViewModal() {
            document.getElementById('view-modal-container').classList.add('scale-95');
            setTimeout(() => document.getElementById('view-modal-overlay').classList.add('hidden'), 150);
        }

        // --- ADD MODAL & GOOGLE MAPS ---
        let googleMap, googleMarker, autocomplete;
        function initGoogleTools() {
            if(!google.maps.places) return;
            autocomplete = new google.maps.places.Autocomplete(document.getElementById('s-address-search'));
            autocomplete.addListener('place_changed', () => {
                const place = autocomplete.getPlace();
                if (!place.geometry) return;
                
                document.getElementById('s-name').value = place.name;
                
                // Parsing Address
                let city = '', stateFull = '', stateShort = '', country = 'INTL';
                let streetNum = '', route = '';

                if (place.address_components) {
                    place.address_components.forEach(c => {
                        if (c.types.includes('street_number')) streetNum = c.long_name;
                        if (c.types.includes('route')) route = c.long_name;
                        if (c.types.includes('locality')) city = c.long_name;
                        if (c.types.includes('administrative_area_level_1')) {
                            stateFull = c.long_name;
                            stateShort = c.short_name;
                        }
                        if (c.types.includes('country')) {
                            if(c.short_name === 'US') country = 'US';
                            else { country = c.long_name; stateShort = 'INTL'; } // If intl, code is INTL
                        }
                    });
                }
                
                // Format: City, ST
                const displayCity = (country === 'US') ? `${city}, ${stateShort}` : `${city}, ${country}`;
                
                document.getElementById('geo-city').value = displayCity; 
                document.getElementById('geo-state-code').value = stateShort;
                document.getElementById('geo-state-name').value = stateFull;
                document.getElementById('geo-country').value = country;
                document.getElementById('geo-lat').value = place.geometry.location.lat();
                document.getElementById('geo-lng').value = place.geometry.location.lng();
                
                // Map Preview
                if(googleMap) {
                    googleMap.setCenter(place.geometry.location);
                    googleMap.setZoom(15);
                    googleMarker.setPosition(place.geometry.location);
                }
            });
            googleMap = new google.maps.Map(document.getElementById('map-preview'), { center: { lat: 0, lng: 0 }, zoom: 2, disableDefaultUI: true });
            googleMarker = new google.maps.Marker({ map: googleMap });
        }

        function openAddModal() {
            document.getElementById('add-modal-overlay').classList.remove('hidden');
            document.getElementById('s-name').value = '';
            document.getElementById('s-address-search').value = '';
            document.getElementById('s-date-month').value = '';
            document.getElementById('s-date-day').value = '';
            document.getElementById('s-date-year').value = '';
            document.getElementById('s-notes').value = '';
            document.getElementById('s-image-input').value = '';
            document.getElementById('preview-box').classList.add('hidden');
        }
        function closeAddModal() { document.getElementById('add-modal-overlay').classList.add('hidden'); }

        function previewImage() {
            const file = document.getElementById('s-image-input').files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('img-preview').src = e.target.result;
                    document.getElementById('preview-box').classList.remove('hidden');
                }
                reader.readAsDataURL(file);
            }
        }
        function clearImage() {
            document.getElementById('s-image-input').value = '';
            document.getElementById('preview-box').classList.add('hidden');
        }

        // --- COMPRESSION & SAVE ---
        async function compressImage(file) {
            return new Promise((resolve) => {
                const blobURL = URL.createObjectURL(file);
                const img = new Image();
                img.src = blobURL;
                img.onload = () => {
                    URL.revokeObjectURL(blobURL);
                    const canvas = document.createElement('canvas');
                    const MAX_WIDTH = 1000; 
                    let width = img.width;
                    let height = img.height;
                    if (width > MAX_WIDTH) {
                        height = Math.round((height * MAX_WIDTH) / width);
                        width = MAX_WIDTH;
                    }
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.imageSmoothingEnabled = true;
                    ctx.imageSmoothingQuality = 'high';
                    ctx.drawImage(img, 0, 0, width, height);
                    canvas.toBlob((blob) => { resolve(blob); }, 'image/jpeg', 0.7);
                };
                img.onerror = () => { URL.revokeObjectURL(blobURL); resolve(file); };
            });
        }

        async function saveStamp() {
            const btn = document.getElementById('save-btn');
            const originalText = btn.innerText;
            btn.innerText = "Compressing & Uploading...";
            btn.disabled = true;

            let imgUrl = null;
            const file = document.getElementById('s-image-input').files[0];

            if(file) {
                try {
                    const compressed = await compressImage(file);
                    const fd = new FormData(); fd.append('image', compressed);
                    const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { method: 'POST', body: fd });
                    const json = await res.json();
                    if(json.data) imgUrl = json.data.url;
                } catch(e) { console.error(e); }
            }

            const payload = {
                user_id: currentUser.id,
                name: document.getElementById('s-name').value,
                address: document.getElementById('s-address-search').value, 
                city: document.getElementById('geo-city').value || document.getElementById('s-address-search').value,
                visit_month: document.getElementById('s-date-month').value || null,
                visit_day: document.getElementById('s-date-day').value || null,
                visit_year: document.getElementById('s-date-year').value || null,
                notes: document.getElementById('s-notes').value || null,
                img_url: imgUrl,
                state_code: document.getElementById('geo-state-code').value || 'INTL',
                full_state_name: (document.getElementById('geo-country').value === 'US') 
                    ? (document.getElementById('geo-state-name').value || '') 
                    : (document.getElementById('geo-country').value || 'International'),
                country_code: document.getElementById('geo-country').value || 'INTL',
                lat: document.getElementById('geo-lat').value || null,
                lng: document.getElementById('geo-lng').value || null
            };

            const { error } = await supabaseClient.from('stamps').insert([payload]);
            if(error) { alert("Error: " + error.message); btn.innerText = originalText; btn.disabled = false; }
            else {
                closeAddModal();
                fetchMyStamps();
                btn.innerText = "Save Stamp";
                btn.disabled = false;
            }
        }

        function renderDesktopProfile() {
            if(!userProfile) return;
            document.getElementById('desktop-profile-foot').innerHTML = `
                <div class="w-8 h-8 rounded-full bg-emerald-100 text-emerald-800 flex items-center justify-center font-bold text-xs overflow-hidden">
                    ${userProfile.avatar_url ? `<img src="${userProfile.avatar_url}" class="w-full h-full object-cover">` : userProfile.username.substring(0,2).toUpperCase()}
                </div>
                <div class="flex-1">
                    <div class="text-xs font-bold text-stone-700">@${userProfile.username}</div>
                    <div class="text-[9px] text-stone-400">View Profile</div>
                </div>
            `;
        }

        function switchView(viewName) {
            document.querySelectorAll('.page-view').forEach(p => p.classList.add('hidden'));
            document.getElementById(`page-${viewName}`).classList.remove('hidden');
            
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            const btn = document.getElementById(`btn-${viewName}`);
            if(btn) btn.classList.add('active');

            // Desktop Nav
            const dBtn = document.getElementById(`btn-d-${viewName}`);
            if(dBtn) {
                 // Clear others
                 document.querySelectorAll('aside button').forEach(b => b.classList.remove('bg-stone-100', 'text-emerald-800'));
                 dBtn.classList.add('bg-stone-100', 'text-emerald-800');
            }

            window.scrollTo({top: 0, behavior: 'smooth'});
            if(viewName === 'feed') fetchFeed(false);
            if(viewName === 'find') fetchFindPage();
        }

    </script>
</body>
</html>
