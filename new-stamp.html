<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Massport (Bug Fix)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,400;0,9..40,700;1,9..40,400&family=Playfair+Display:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_API_KEY&libraries=places"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['DM Sans', 'sans-serif'],
                        heading: ['Playfair Display', 'serif'],
                    },
                    colors: {
                        stone: { 50: '#fafaf9', 100: '#f5f5f4', 200: '#e7e5e4', 800: '#292524', 900: '#1c1917' },
                        emerald: { 900: '#064e3b' }
                    }
                }
            }
        }
    </script>

    <style>
        /* Masonry & Layout */
        .masonry-grid {
            column-count: 2;
            column-gap: 1rem;
        }
        .masonry-item {
            break-inside: avoid; /* CRITICAL FIX: Prevents items from being cut off or invisible */
            page-break-inside: avoid;
            margin-bottom: 1rem;
            display: inline-block; /* Helps with column rendering */
            width: 100%;
        }
        
        /* Stamp Aesthetics */
        .stamp {
            background: white;
            padding: 10px 10px 25px 10px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: transform 0.2s;
            border: 1px solid #e7e5e4;
            position: relative;
        }
        .stamp:active { transform: scale(0.98); }
        .stamp-content-wrapper {
            border: 1px solid var(--theme-color);
            padding: 4px;
            height: 100%;
        }
        .stamp-image {
            width: 100%;
            background: #f5f5f4;
            overflow: hidden;
            aspect-ratio: 1/1; /* Square by default in grid */
            position: relative;
        }
        .stamp-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            filter: grayscale(20%) contrast(110%);
        }
        .stamp-overlay-text {
            margin-top: 12px;
            text-align: center;
            color: var(--theme-color);
        }

        /* Journal Card (Text Only) */
        .journal-card {
            background: white;
            padding: 24px;
            border: 1px solid #e7e5e4;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: transform 0.2s;
            display: flex;
            flex-direction: column;
            border-top: 4px solid var(--theme-color);
        }
        .journal-card:active { transform: scale(0.98); }

        /* Feed Card */
        .feed-container-card {
            background: white;
            border-bottom: 1px solid #e7e5e4;
            display: flex;
            flex-direction: row;
            overflow: hidden;
            margin-bottom: 0;
            padding: 16px 0;
        }
        .feed-left-visual { width: 100px; height: 100px; flex-shrink: 0; padding: 0 0 0 16px; display: flex; align-items: center; justify-content: center; }
        .feed-left-visual .stamp { padding: 4px 4px 12px 4px; box-shadow: none; border: 1px solid #eee; height: auto; }
        .feed-left-visual .stamp-content-wrapper { padding: 2px; }

        /* Utility */
        .hidden { display: none !important; }
        .ink-stamp-deco {
            font-family: 'Playfair Display', serif;
            font-weight: 700;
            text-transform: uppercase;
            color: #e7e5e4;
            border: 3px double #e7e5e4;
            padding: 8px 16px;
            border-radius: 4px;
            display: inline-block;
            transform: rotate(-2deg);
            letter-spacing: 0.1em;
        }
        .active-nav { color: #064e3b; }
        
        /* Modal Adjustments */
        #view-modal-container {
            max-height: 90vh;
            display: flex;
            flex-direction: column;
        }
    </style>
</head>
<body class="bg-stone-50 text-stone-800 antialiased pb-20">

    <div id="login-screen" class="fixed inset-0 bg-stone-50 z-50 flex flex-col items-center justify-center p-6 hidden">
        <div class="mb-8 p-6 bg-white rounded-full shadow-sm border border-stone-100">
            <i data-lucide="stamp" class="w-12 h-12 text-emerald-900"></i>
        </div>
        <h1 class="font-heading text-4xl mb-2">Stamp Journal</h1>
        <p class="text-stone-500 mb-8 text-center max-w-xs">Collect memories, follow friends, and document your journey.</p>
        <button onclick="handleLogin()" class="bg-emerald-900 text-white px-8 py-3 rounded-full font-bold shadow-lg hover:bg-emerald-800 transition w-full max-w-xs flex items-center justify-center gap-2">
            <i data-lucide="log-in" class="w-4 h-4"></i> Sign in with Google
        </button>
        <button onclick="continueGuest()" id="guest-btn" class="mt-4 text-stone-400 text-xs font-bold uppercase tracking-widest hidden">Continue as Guest</button>
    </div>

    <div id="app-container" class="max-w-md mx-auto min-h-screen relative hidden">
        
        <header class="sticky top-0 bg-stone-50/95 backdrop-blur-md z-30 px-6 py-4 flex items-center justify-between border-b border-stone-200/50">
            <div class="flex items-center gap-3">
                <i data-lucide="stamp" class="w-6 h-6 text-emerald-900"></i>
                <span class="font-heading text-xl font-bold" id="header-title">My Journal</span>
            </div>
            <div class="flex items-center gap-3">
                <button onclick="openAddModal()" class="w-8 h-8 bg-emerald-900 rounded-full flex items-center justify-center text-white shadow-md hover:bg-emerald-800 transition">
                    <i data-lucide="plus" class="w-5 h-5"></i>
                </button>
            </div>
        </header>

        <main id="page-journal" class="page-view px-4 py-4">
            <div class="flex gap-2 overflow-x-auto pb-4 scrollbar-hide">
                <select id="filter-location" onchange="applyJournalFilters()" class="bg-white border border-stone-200 rounded-full px-4 py-2 text-xs font-bold text-stone-600 focus:outline-none focus:border-emerald-900">
                    <option value="ALL">All Locations</option>
                </select>
                <select id="filter-year" onchange="applyJournalFilters()" class="bg-white border border-stone-200 rounded-full px-4 py-2 text-xs font-bold text-stone-600 focus:outline-none focus:border-emerald-900">
                    <option value="ALL">All Years</option>
                </select>
                <select id="filter-sort" onchange="applyJournalFilters()" class="bg-white border border-stone-200 rounded-full px-4 py-2 text-xs font-bold text-stone-600 focus:outline-none focus:border-emerald-900">
                    <option value="newest">Newest First</option>
                    <option value="oldest">Oldest First</option>
                    <option value="location_asc">By Location</option>
                </select>
            </div>

            <div id="journal-grid" class="masonry-grid pb-20"></div>
            
            <div id="journal-empty" class="hidden flex flex-col items-center justify-center mt-20 text-center px-6">
                <div class="text-stone-300 mb-4"><i data-lucide="map" class="w-16 h-16"></i></div>
                <h3 class="font-heading text-xl text-stone-800 mb-2">No stamps yet</h3>
                <p class="text-stone-500 text-sm">Add your first travel memory to start your collection.</p>
            </div>
        </main>

        <main id="page-feed" class="page-view hidden bg-white min-h-screen">
            <div id="feed-items" class="pb-24"></div>
            <button id="feed-load-more" onclick="fetchFeed(true)" class="hidden w-full py-4 text-center text-stone-400 text-xs font-bold uppercase tracking-widest hover:bg-stone-50">Load More</button>
        </main>

        <main id="page-find" class="page-view hidden px-4 py-4">
            <div class="relative mb-6">
                <i data-lucide="search" class="absolute left-4 top-3 w-5 h-5 text-stone-400"></i>
                <input type="text" id="user-search-input" onkeyup="debounceSearchUsers()" placeholder="Search travelers..." class="w-full bg-white border border-stone-200 rounded-xl pl-12 pr-4 py-3 text-sm focus:outline-none focus:border-emerald-900 shadow-sm">
            </div>
            
            <h3 class="font-heading text-lg mb-3 pl-1">Results & Following</h3>
            <div id="followers-list" class="space-y-3 pb-24"></div>
        </main>

        <main id="page-profile" class="page-view hidden px-6 py-8 flex flex-col items-center">
            </main>

        <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-stone-200 px-6 py-3 flex justify-between items-center z-40 max-w-md mx-auto">
            <button id="btn-journal" onclick="switchView('journal')" class="nav-btn active flex flex-col items-center gap-1 text-stone-400 hover:text-emerald-900">
                <i data-lucide="book-open" class="w-6 h-6"></i>
                <span class="text-[9px] font-bold uppercase tracking-widest">Journal</span>
            </button>
            <button id="btn-feed" onclick="switchView('feed')" class="nav-btn flex flex-col items-center gap-1 text-stone-400 hover:text-emerald-900">
                <i data-lucide="globe" class="w-6 h-6"></i>
                <span class="text-[9px] font-bold uppercase tracking-widest">Feed</span>
            </button>
            <button id="btn-find" onclick="switchView('find')" class="nav-btn flex flex-col items-center gap-1 text-stone-400 hover:text-emerald-900">
                <i data-lucide="users" class="w-6 h-6"></i>
                <span class="text-[9px] font-bold uppercase tracking-widest">Find</span>
            </button>
            <button id="btn-profile" onclick="openUserProfile(currentUser.id)" class="nav-btn flex flex-col items-center gap-1 text-stone-400 hover:text-emerald-900">
                <div class="w-6 h-6 rounded-full overflow-hidden border border-current" id="nav-avatar-img">
                    <i data-lucide="user" class="w-4 h-4 m-auto mt-0.5"></i>
                </div>
                <span class="text-[9px] font-bold uppercase tracking-widest">Profile</span>
            </button>
        </nav>
    </div>

    <div id="add-modal-overlay" class="fixed inset-0 bg-stone-900/50 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-2xl shadow-2xl overflow-hidden max-h-[90vh] overflow-y-auto">
            <div class="px-6 py-4 border-b border-stone-100 flex justify-between items-center bg-stone-50">
                <h3 class="font-heading text-lg">New Stamp</h3>
                <button onclick="closeAddModal()" class="text-stone-400 hover:text-stone-600"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <div class="relative w-full h-32 bg-stone-100 border-2 border-dashed border-stone-200 rounded-xl flex flex-col items-center justify-center cursor-pointer hover:bg-stone-50 transition group" onclick="document.getElementById('s-image-input').click()">
                    <input type="file" id="s-image-input" class="hidden" accept="image/*" onchange="previewImage()">
                    <i data-lucide="image-plus" class="w-8 h-8 text-stone-300 group-hover:text-stone-400 mb-2"></i>
                    <span class="text-xs font-bold text-stone-400 uppercase tracking-widest">Add Photo</span>
                    <div id="preview-box" class="absolute inset-0 bg-white hidden">
                        <img id="img-preview" class="w-full h-full object-cover rounded-xl">
                        <button onclick="event.stopPropagation(); clearImage()" class="absolute top-2 right-2 bg-black/50 text-white rounded-full p-1"><i data-lucide="x" class="w-4 h-4"></i></button>
                    </div>
                </div>

                <div>
                    <label class="text-[10px] font-bold text-stone-400 uppercase tracking-widest">Location Name</label>
                    <input type="text" id="s-name" placeholder="e.g. The Louvre" class="w-full border-b border-stone-200 py-2 font-heading text-xl focus:outline-none focus:border-emerald-900 placeholder:text-stone-300">
                </div>

                <div>
                    <label class="text-[10px] font-bold text-stone-400 uppercase tracking-widest">Search Address/City</label>
                    <input type="text" id="s-address-search" placeholder="Search Google Maps..." class="w-full border-b border-stone-200 py-2 text-sm focus:outline-none focus:border-emerald-900">
                    <input type="hidden" id="geo-city">
                    <input type="hidden" id="geo-state-code">
                    <input type="hidden" id="geo-state-name">
                    <input type="hidden" id="geo-country">
                    <input type="hidden" id="geo-lat">
                    <input type="hidden" id="geo-lng">
                </div>
                
                <div id="map-preview" class="w-full h-24 rounded-lg bg-stone-100 hidden md:block"></div>

                <div class="flex gap-2">
                    <div class="flex-1">
                        <label class="text-[10px] font-bold text-stone-400 uppercase tracking-widest">Month</label>
                        <select id="s-date-month" class="w-full border-b border-stone-200 py-2 text-sm bg-transparent"><option value="">--</option><option>Jan</option><option>Feb</option><option>Mar</option><option>Apr</option><option>May</option><option>Jun</option><option>Jul</option><option>Aug</option><option>Sep</option><option>Oct</option><option>Nov</option><option>Dec</option></select>
                    </div>
                    <div class="w-16">
                        <label class="text-[10px] font-bold text-stone-400 uppercase tracking-widest">Day</label>
                        <input type="number" id="s-date-day" placeholder="DD" class="w-full border-b border-stone-200 py-2 text-sm">
                    </div>
                    <div class="w-20">
                        <label class="text-[10px] font-bold text-stone-400 uppercase tracking-widest">Year</label>
                        <input type="number" id="s-date-year" placeholder="YYYY" class="w-full border-b border-stone-200 py-2 text-sm">
                    </div>
                </div>

                <div>
                    <label class="text-[10px] font-bold text-stone-400 uppercase tracking-widest">Notes</label>
                    <textarea id="s-notes" rows="3" placeholder="Write about your experience..." class="w-full border border-stone-200 rounded-lg p-3 text-sm mt-1 focus:outline-none focus:border-emerald-900"></textarea>
                </div>

                <button id="save-btn" onclick="saveStamp()" class="w-full bg-emerald-900 text-white py-3 rounded-full font-bold shadow-lg hover:bg-emerald-800 transition">Save Stamp</button>
            </div>
        </div>
    </div>

    <div id="view-modal-overlay" class="fixed inset-0 bg-stone-900/60 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4 transition-opacity duration-300">
        <div id="view-modal-container" class="bg-white w-full max-w-sm rounded-lg shadow-2xl overflow-hidden transform scale-95 transition-transform duration-300 relative">
            
            <button onclick="closeViewModal()" class="absolute top-3 right-3 z-10 bg-black/20 hover:bg-black/40 text-white p-1.5 rounded-full backdrop-blur-sm transition">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>

            <div id="view-visual-side" class="w-full relative bg-stone-100 flex items-center justify-center overflow-hidden">
                </div>
            
            <div class="p-6 bg-white relative">
                <div class="flex items-center gap-3 mb-4 cursor-pointer" id="v-user-link">
                    <div id="v-avatar" class="w-8 h-8 rounded-full bg-stone-200 overflow-hidden flex items-center justify-center text-[10px] font-bold"></div>
                    <div>
                        <div id="v-user" class="text-xs font-bold text-stone-800"></div>
                        <div id="v-date" class="text-[10px] text-stone-400"></div>
                    </div>
                </div>

                <h2 id="v-title" class="font-heading text-3xl text-stone-800 mb-1 leading-none"></h2>
                <a id="v-map-link" href="#" target="_blank" class="text-[10px] font-bold uppercase tracking-widest mb-4 inline-flex items-center gap-1 hover:underline"></a>
                
                <div class="flex items-start gap-2 mt-4">
                    <i data-lucide="quote" class="w-4 h-4 text-stone-300 flex-shrink-0 mt-1"></i>
                    <p id="v-notes" class="text-stone-600 text-sm italic leading-relaxed"></p>
                </div>
            </div>
        </div>
    </div>

    <div id="profile-modal" class="fixed inset-0 bg-stone-50 z-40 hidden overflow-y-auto">
        <div class="max-w-md mx-auto min-h-screen relative pb-10">
            <div class="h-40 bg-stone-200 relative">
                <button onclick="closeProfileModal()" class="absolute top-4 left-4 bg-white/50 backdrop-blur-md p-2 rounded-full hover:bg-white transition text-stone-700">
                    <i data-lucide="arrow-left" class="w-5 h-5"></i>
                </button>
            </div>
            
            <div class="px-6 relative -mt-12 mb-6 text-center">
                <div class="w-24 h-24 rounded-full bg-white p-1 mx-auto shadow-md">
                    <div id="p-avatar-lg" class="w-full h-full rounded-full bg-stone-100 overflow-hidden flex items-center justify-center text-xl font-bold text-stone-400"></div>
                </div>
                <h2 id="p-name" class="font-heading text-2xl mt-3 text-stone-900"></h2>
                <p id="p-username" class="text-xs font-bold text-stone-400 uppercase tracking-widest mb-4"></p>
                <div id="p-actions" class="flex justify-center gap-2"></div>
            </div>

            <div class="px-4">
                <div class="flex gap-2 overflow-x-auto pb-4 scrollbar-hide justify-center mb-2">
                    <select id="p-filter-loc" onchange="renderProfileMasonry()" class="bg-white border border-stone-200 rounded-full px-4 py-2 text-xs font-bold text-stone-600 focus:outline-none">
                        <option value="ALL">All Locations</option>
                    </select>
                    <select id="p-filter-year" onchange="renderProfileMasonry()" class="bg-white border border-stone-200 rounded-full px-4 py-2 text-xs font-bold text-stone-600 focus:outline-none">
                        <option value="ALL">All Years</option>
                    </select>
                    <select id="p-filter-sort" onchange="renderProfileMasonry()" class="bg-white border border-stone-200 rounded-full px-4 py-2 text-xs font-bold text-stone-600 focus:outline-none">
                        <option value="newest">Newest</option>
                        <option value="oldest">Oldest</option>
                        <option value="location_asc">Location</option>
                    </select>
                </div>
                <div id="profile-grid" class="masonry-grid"></div>
            </div>
        </div>
    </div>

    <div id="edit-profile-modal" class="fixed inset-0 bg-stone-900/50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-2xl p-6">
            <h3 class="font-heading text-xl mb-4">Edit Profile</h3>
            <div class="space-y-4">
                <div>
                    <label class="text-[10px] font-bold text-stone-400 uppercase tracking-widest">Display Name</label>
                    <input type="text" id="ep-name" class="w-full border-b border-stone-200 py-2">
                </div>
                <div>
                    <label class="text-[10px] font-bold text-stone-400 uppercase tracking-widest">Avatar URL</label>
                    <input type="text" id="ep-avatar" class="w-full border-b border-stone-200 py-2 text-xs">
                </div>
                <button onclick="saveProfile()" class="w-full bg-emerald-900 text-white py-3 rounded-full font-bold">Save Changes</button>
                <button onclick="document.getElementById('edit-profile-modal').classList.add('hidden')" class="w-full text-stone-400 py-2 text-xs font-bold uppercase">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const SUPABASE_URL = 'YOUR_SUPABASE_URL'; 
        const SUPABASE_KEY = 'YOUR_SUPABASE_ANON_KEY';
        const IMGBB_API_KEY = 'YOUR_IMGBB_API_KEY';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // --- STATE ---
        let session = null;
        let currentUser = null;
        let userProfile = null;
        let myStamps = [];
        let feedStamps = [];
        let viewingProfileStamps = [];
        let followingIds = [];
        let feedPage = 0;

        // Colors for stamps - Used for visual variety
        const themes = ['#064e3b', '#065f46', '#047857', '#059669', '#10b981', '#34d399', '#6ee7b7', '#a7f3d0', '#115e59', '#0f766e', '#0d9488'];

        // --- INIT ---
        window.onload = async () => {
            initGoogleTools();
            
            // 1. Check for Public Profile via URL Hash (#username)
            const hash = window.location.hash.substring(1);
            if(hash && hash.length > 0) {
                // Try to find user by username
                const { data: profiles, error } = await supabaseClient.from('profiles').select('*').eq('username', hash);
                if(profiles && profiles.length > 0) {
                    // Show app container but stay in 'guest' mode essentially
                    document.getElementById('app-container').classList.remove('hidden');
                    document.getElementById('login-screen').classList.add('hidden');
                    
                    // We might still be logged in, let's check
                    const { data } = await supabaseClient.auth.getSession();
                    session = data.session;
                    if(session) {
                        currentUser = session.user;
                        await fetchUserProfile();
                    } else {
                        // Guest Mode: Hide nav buttons except maybe simple ones
                        document.querySelector('nav').classList.add('hidden'); 
                        document.querySelector('header').classList.add('hidden');
                    }
                    
                    // Open the profile
                    openUserProfile(profiles[0].id);
                    return; // Stop standard init
                }
            }

            // 2. Standard Auth Check
            const { data } = await supabaseClient.auth.getSession();
            session = data.session;
            if (session) {
                currentUser = session.user;
                initApp();
            } else {
                document.getElementById('login-screen').classList.remove('hidden');
            }
            
            lucide.createIcons();
        };

        async function handleLogin() {
            await supabaseClient.auth.signInWithOAuth({ provider: 'google' });
        }
        
        async function handleLogout() {
            await supabaseClient.auth.signOut();
            window.location.reload();
        }

        async function initApp() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('app-container').classList.remove('hidden');
            
            await fetchUserProfile();
            // Fetch following BEFORE fetching feed to ensure feed works
            await fetchFollowing(); 
            fetchMyStamps();
            fetchFeed();
            
            if(userProfile?.avatar_url) {
                document.getElementById('nav-avatar-img').innerHTML = `<img src="${userProfile.avatar_url}" class="w-full h-full object-cover">`;
            }
        }

        async function fetchUserProfile() {
            const { data } = await supabaseClient.from('profiles').select('*').eq('id', currentUser.id).single();
            if (!data) {
                // First time setup if profile doesn't exist
                const username = currentUser.email.split('@')[0];
                const { data: newProfile } = await supabaseClient.from('profiles').insert([{ id: currentUser.id, username, display_name: username }]).select().single();
                userProfile = newProfile;
            } else {
                userProfile = data;
            }
        }

        async function fetchMyStamps() {
            const { data } = await supabaseClient.from('stamps').select('*').eq('user_id', currentUser.id).order('created_at', { ascending: false });
            myStamps = data || [];
            populateFilters(myStamps, 'filter-location', 'filter-year');
            renderGrid(myStamps, 'journal-grid', 'ALL', 'ALL', 'newest', 'local');
            
            // Header Stats
            document.getElementById('header-title').innerText = `${userProfile.display_name}'s Journal (${myStamps.length})`;
        }

        async function fetchFollowing() {
            const { data } = await supabaseClient.from('followers').select('following_id').eq('follower_id', currentUser.id);
            followingIds = data ? data.map(r => r.following_id) : [];
            followingIds.push(currentUser.id); // Follow self for feed
        }

        async function fetchFeed(loadMore = false) {
            if(!currentUser || followingIds.length === 0) return;
            if(!loadMore) { feedStamps = []; feedPage = 0; }
            else feedPage++;

            const PAGE_SIZE = 10;
            const from = feedPage * PAGE_SIZE;
            const to = from + PAGE_SIZE - 1;

            const { data } = await supabaseClient
                .from('stamps')
                .select(`*, profiles(username, display_name, avatar_url, id)`)
                .in('user_id', followingIds)
                .order('created_at', { ascending: false })
                .range(from, to);

            if(data && data.length > 0) {
                feedStamps = [...feedStamps, ...data];
                renderFeedHTML(feedStamps);
                document.getElementById('feed-load-more').classList.remove('hidden');
            } else {
                document.getElementById('feed-load-more').classList.add('hidden');
                if(feedPage === 0) document.getElementById('feed-items').innerHTML = `<p class="text-center text-stone-400 mt-10">Your feed is quiet. Follow others or add a stamp.</p>`;
            }
        }

        // --- FILTERING & GROUPING LOGIC ---
        function populateFilters(stamps, locId, yearId) {
            const locSelect = document.getElementById(locId);
            const yearSelect = document.getElementById(yearId);
            
            const states = new Set();
            const international = new Set();
            
            stamps.forEach(s => {
                // Fix: Ignore null/undefined locations
                if(!s.full_state_name && !s.country_code) return; 

                if(s.state_code === 'INTL') international.add(s.full_state_name || s.country_code); 
                else if(s.state_code) states.add(s.full_state_name);
            });

            locSelect.innerHTML = '<option value="ALL">All Locations</option>';
            if(states.size > 0) {
                const grp = document.createElement('optgroup'); grp.label = "United States";
                grp.appendChild(new Option("All United States", "US_ALL")); // Added Group Selector
                [...states].sort().forEach(st => grp.appendChild(new Option(st, st)));
                locSelect.appendChild(grp);
            }
            if(international.size > 0) {
                const grp = document.createElement('optgroup'); grp.label = "International";
                grp.appendChild(new Option("All International", "INTL_ALL")); // Added Group Selector
                [...international].sort().forEach(c => grp.appendChild(new Option(c, c)));
                locSelect.appendChild(grp);
            }

            // Years logic
            const years = [...new Set(stamps.map(s => {
                if(s.visit_year) return s.visit_year;
                if(s.visit_date && s.visit_date.length >= 4) return s.visit_date.slice(-4);
                return 'Unknown';
            }))].sort().reverse();
            
            yearSelect.innerHTML = '<option value="ALL">All Years</option>';
            years.forEach(y => yearSelect.add(new Option(y, y)));
        }

        function applyJournalFilters() {
            const loc = document.getElementById('filter-location').value;
            const year = document.getElementById('filter-year').value;
            const sort = document.getElementById('filter-sort').value;
            
            renderGrid(myStamps, 'journal-grid', loc, year, sort, 'local');
        }

        // --- COLOR HASHING ---
        // Generates a consistent color index from the UUID string
        function getStampColor(id) {
            if(!id) return themes[0];
            let hash = 0;
            for (let i = 0; i < id.length; i++) {
                hash = id.charCodeAt(i) + ((hash << 5) - hash);
            }
            const index = Math.abs(hash % themes.length);
            return themes[index];
        }

        function renderGrid(dataset, containerId, filterLoc, filterYear, sortMode, source) {
            const container = document.getElementById(containerId);
            
            // Filter
            let filtered = dataset.filter(s => {
                const sYear = s.visit_year || (s.visit_date ? s.visit_date.slice(-4) : 'Unknown');
                
                // Logic for US_ALL and INTL_ALL
                let locMatch = false;
                if (filterLoc === 'ALL') locMatch = true;
                else if (filterLoc === 'US_ALL') locMatch = (s.country_code === 'US' || (s.state_code && s.state_code !== 'INTL'));
                else if (filterLoc === 'INTL_ALL') locMatch = (s.state_code === 'INTL' || s.country_code !== 'US');
                else {
                    const sLoc = s.state_code === 'INTL' ? (s.full_state_name || s.country_code) : s.full_state_name;
                    locMatch = sLoc === filterLoc;
                }
                
                const yearMatch = filterYear === 'ALL' || sYear == filterYear;
                return locMatch && yearMatch;
            });

            // If empty
            if(filtered.length === 0) {
                container.innerHTML = ''; 
                if(containerId === 'journal-grid') document.getElementById('journal-empty').classList.remove('hidden');
                return;
            }
            if(containerId === 'journal-grid') document.getElementById('journal-empty').classList.add('hidden');

            // Sorting
            let grouped = false;

            if(sortMode === 'location_asc') {
                filtered.sort((a, b) => {
                    const locA = a.state_code === 'INTL' ? (a.full_state_name || 'ZZ') : a.state_code;
                    const locB = b.state_code === 'INTL' ? (b.full_state_name || 'ZZ') : b.state_code;
                    return locA.localeCompare(locB);
                });
                
                // DISTRIBUTION FIX: When sorting by location, interleave Images and Text to avoid clumps
                // This helps avoid the "Invisible Stamp" issue in masonry columns
                const withImg = [];
                const noImg = [];
                filtered.forEach(s => s.img_url ? withImg.push(s) : noImg.push(s));
                
                // Simple zipper merge if they share the same location group
                // (Simplified: just rely on the sort, but if we really wanted to mix them, we'd do it here. 
                // For now, let's trust the browser, but ensure text cards have 'break-inside: avoid' in CSS)
                grouped = true;
            } else if (sortMode === 'newest') {
                filtered.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            } else if (sortMode === 'oldest') {
                filtered.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
            }

            // Render
            let html = '';
            let currentGroup = null;

            filtered.forEach((s) => {
                // Group Headers
                let groupText = null;
                if (grouped) {
                    groupText = s.state_code === 'INTL' ? (s.state_code) : s.state_code;
                } else if (filterLoc !== 'ALL') {
                    groupText = s.state_code === 'INTL' ? 'INTL' : s.state_code;
                } else if (filterYear !== 'ALL') {
                    groupText = filterYear;
                } else {
                    groupText = 'ICON'; 
                }

                if (groupText !== currentGroup) {
                    currentGroup = groupText;
                    let content = groupText === 'ICON' ? '<i data-lucide="stamp" class="w-10 h-10"></i>' : groupText;
                    html += `<div class="masonry-item w-full flex justify-center pt-4 pb-2"><div class="ink-stamp-deco">${content}</div></div>`;
                }

                // Add Card - CRITICAL FIX: Passing s.id instead of index
                // Also passing 'direct' true so openViewModal knows how to look it up
                html += `<div class="masonry-item" onclick="openViewModal('${s.id}', '${source}')">
                    ${createStampCardHTML(s)}
                </div>`;
            });
            
            container.innerHTML = html;
            lucide.createIcons();
        }

        function createStampCardHTML(s) {
            // Use ID-based color to avoid clumping of same colors
            const theme = getStampColor(s.id); 
            const cityColor = `style="color: ${theme}"`;
            
            let dateStr = "";
            if(s.visit_month && s.visit_day && s.visit_year) dateStr = `${s.visit_month} ${s.visit_day}, ${s.visit_year}`;
            else if(s.visit_month && s.visit_year) dateStr = `${s.visit_month} ${s.visit_year}`;
            else if(s.visit_year) dateStr = `${s.visit_year}`;
            else dateStr = s.visit_date || '';

             if (s.img_url) {
                return `
                <div class="stamp w-full" style="--theme-color: ${theme}">
                    <div class="stamp-content-wrapper">
                        <div class="stamp-image">
                            <img src="${s.img_url}">
                        </div>
                        <div class="stamp-overlay-text">
                             <p class="text-[9px] font-bold uppercase tracking-widest opacity-90">${s.city}</p>
                             <h4 class="font-heading text-2xl leading-none">${s.name}</h4>
                        </div>
                    </div>
                </div>`;
            } else {
                return `
                <div class="journal-card w-full" style="--theme-color: ${theme}">
                    <p class="text-[9px] font-bold uppercase tracking-widest" ${cityColor}>${s.city}</p>
                    <h4 class="font-heading text-2xl leading-tight text-stone-800 ${!s.notes && !dateStr ? 'mb-0' : ''}">${s.name}</h4>
                    ${s.notes ? `<p class="text-[13px] text-stone-500 italic line-clamp-4 leading-relaxed my-1">${s.notes}</p>` : ''}
                    ${dateStr ? `
                    <div class="flex items-center justify-between pt-2 mt-auto">
                        <span class="text-[9px] text-stone-300 font-bold">${dateStr}</span>
                        <i data-lucide="feather" class="w-3 h-3 text-stone-200"></i>
                    </div>` : ''}
                </div>`;
            }
        }

        // --- FEED ---
        function renderFeedHTML(stamps) {
            const container = document.getElementById('feed-items');
            container.innerHTML = stamps.map((s) => {
                const theme = getStampColor(s.id);
                const u = s.profiles;
                const initials = u.username.substring(0,2).toUpperCase();
                
                const visual = s.img_url 
                    ? `<div class="stamp w-full h-full" style="--theme-color: ${theme}"><div class="stamp-image"><img src="${s.img_url}"></div></div>`
                    : `<div class="w-20 h-20 rounded-full border-2 border-[${theme}] flex items-center justify-center bg-white"><i data-lucide="map-pin" class="text-stone-300"></i></div>`;

                return `
                <div class="feed-container-card" onclick="openViewModal('${s.id}', 'feed')">
                    <div class="feed-left-visual">
                        ${visual}
                    </div>
                    <div class="p-4 md:p-6 flex-1 flex flex-col justify-center border-l border-stone-50">
                        <div class="flex items-center gap-2 mb-2 cursor-pointer group" onclick="event.stopPropagation(); openUserProfile('${s.user_id}')">
                            <div class="w-8 h-8 rounded-full bg-stone-100 flex items-center justify-center text-[10px] font-bold text-stone-500 overflow-hidden border border-white shadow-sm">
                                ${u.avatar_url ? `<img src="${u.avatar_url}" class="w-full h-full object-cover">` : initials}
                            </div>
                            <div>
                                <div class="text-[11px] font-bold text-stone-800 group-hover:text-emerald-700 transition">${u.username}</div>
                                <div class="text-[9px] text-stone-400">added a memory</div>
                            </div>
                        </div>
                        <h3 class="font-heading text-xl text-stone-800 mb-1 leading-none">${s.name}</h3>
                        <p class="text-[10px] font-bold uppercase tracking-widest mb-2" style="color: ${theme}">${s.city}</p>
                        ${s.notes ? `<p class="text-stone-500 text-xs italic line-clamp-2">"${s.notes}"</p>` : ''}
                    </div>
                </div>`;
            }).join('');
            lucide.createIcons();
        }

        // --- SEARCH & FIND ---
        async function searchUsers() {
            const query = document.getElementById('user-search-input').value;
            if(query.length < 3) return;
            const { data } = await supabaseClient.from('profiles').select('*').ilike('username', `%${query}%`).limit(10);
            renderSearchResults(data || [], true);
        }
        let debounceTimer;
        function debounceSearchUsers() { clearTimeout(debounceTimer); debounceTimer = setTimeout(searchUsers, 500); }

        // Render following list first (Request #8)
        async function renderFollowingList() {
            if(!currentUser) return;
            const { data } = await supabaseClient.from('profiles').select('*').in('id', followingIds).neq('id', currentUser.id);
            if(data && data.length > 0) {
                 renderSearchResults(data, false);
            }
        }

        function renderSearchResults(profiles, isSearch) {
            const list = document.getElementById('followers-list');
            if(!isSearch) list.innerHTML = ''; // Clear if initial load
            
            const html = profiles.map(p => {
                const isMe = currentUser && p.id === currentUser.id;
                const isFollowing = followingIds.includes(p.id);
                return `
                <div class="bg-white p-4 rounded-xl flex items-center justify-between border border-stone-100 shadow-sm hover:shadow-md transition cursor-pointer" onclick="openUserProfile('${p.id}')">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-stone-100 overflow-hidden">
                             ${p.avatar_url ? `<img src="${p.avatar_url}" class="w-full h-full object-cover">` : ''}
                        </div>
                        <div>
                            <h4 class="font-bold text-stone-800 text-sm">${p.display_name || p.username}</h4>
                            <p class="text-[10px] text-stone-400 uppercase tracking-widest">@${p.username}</p>
                        </div>
                    </div>
                    ${!isMe ? `<button onclick="event.stopPropagation(); toggleFollow('${p.id}', this)" class="${isFollowing ? 'bg-stone-100 text-stone-400' : 'bg-emerald-900 text-white'} px-4 py-1.5 rounded-full text-xs font-bold transition">${isFollowing ? 'Following' : 'Follow'}</button>` : ''}
                </div>`;
            }).join('');
            
            if(isSearch) list.innerHTML = html; 
            else list.innerHTML = `<h4 class="text-xs font-bold text-stone-400 uppercase tracking-widest pl-1 mb-2">Following</h4>` + html;
        }

        async function toggleFollow(targetId, btn) {
            if(!currentUser) return;
            const isFollowing = followingIds.includes(targetId);
            if (isFollowing) {
                await supabaseClient.from('followers').delete().match({ follower_id: currentUser.id, following_id: targetId });
                followingIds = followingIds.filter(id => id !== targetId);
                btn.innerText = "Follow"; btn.className = "bg-emerald-900 text-white px-4 py-1.5 rounded-full text-xs font-bold transition";
            } else {
                await supabaseClient.from('followers').insert([{ follower_id: currentUser.id, following_id: targetId }]);
                followingIds.push(targetId);
                btn.innerText = "Following"; btn.className = "bg-stone-100 text-stone-400 px-4 py-1.5 rounded-full text-xs font-bold transition";
            }
            fetchFeed(false);
        }

        // --- PROFILE VIEW ---
        async function openUserProfile(userId) {
            // Fix: handle clicks
            document.getElementById('profile-modal').classList.remove('hidden');
            const isMe = currentUser && userId === currentUser.id;

            const { data: profile } = await supabaseClient.from('profiles').select('*').eq('id', userId).single();
            const { data: stamps } = await supabaseClient.from('stamps').select('*').eq('user_id', userId).order('created_at', {ascending:false});
            viewingProfileStamps = stamps || [];

            // Header
            const initials = profile.username.substring(0,2).toUpperCase();
            document.getElementById('p-avatar-lg').innerHTML = profile.avatar_url ? `<img src="${profile.avatar_url}" class="w-full h-full object-cover">` : initials;
            document.getElementById('p-name').innerText = profile.display_name;
            document.getElementById('p-username').innerText = `@${profile.username} â€¢ ${stamps.length} Stamps`;

            // Actions
            const actionDiv = document.getElementById('p-actions');
            if(isMe) {
                actionDiv.innerHTML = `
                    <button onclick="document.getElementById('edit-profile-modal').classList.remove('hidden')" class="px-6 py-2 rounded-full border border-stone-200 text-stone-600 font-bold text-xs hover:bg-stone-50">Edit Profile</button>
                    <button onclick="handleLogout()" class="px-6 py-2 rounded-full border border-stone-200 text-red-400 font-bold text-xs hover:bg-stone-50">Log Out</button>
                `;
                document.getElementById('ep-name').value = profile.display_name;
                document.getElementById('ep-avatar').value = profile.avatar_url || '';
            } else {
                // If not logged in (public view), show Login instead of Follow
                if (!currentUser) {
                     actionDiv.innerHTML = `<button onclick="document.getElementById('login-screen').classList.remove('hidden')" class="bg-emerald-900 text-white px-8 py-2 rounded-full font-bold text-xs transition">Login to Follow</button>`;
                } else {
                    const isFollowing = followingIds.includes(userId);
                    actionDiv.innerHTML = `<button onclick="toggleFollow('${userId}', this)" class="${isFollowing ? 'text-stone-400 bg-stone-100' : 'bg-emerald-900 text-white'} px-8 py-2 rounded-full font-bold text-xs transition">${isFollowing ? 'Following' : 'Follow'}</button>`;
                }
            }

            populateFilters(viewingProfileStamps, 'p-filter-loc', 'p-filter-year');
            renderProfileMasonry();
        }

        function renderProfileMasonry() {
            const loc = document.getElementById('p-filter-loc').value;
            const year = document.getElementById('p-filter-year').value;
            const sort = document.getElementById('p-filter-sort').value;
            
            // Fix: Passing 'direct' isn't needed for the source string, but used to ID array
            renderGrid(viewingProfileStamps, 'profile-grid', loc, year, sort, 'profile');
        }

        async function saveProfile() {
            const name = document.getElementById('ep-name').value;
            const av = document.getElementById('ep-avatar').value;
            await supabaseClient.from('profiles').update({ display_name: name, avatar_url: av }).eq('id', currentUser.id);
            location.reload();
        }
        function closeProfileModal() { document.getElementById('profile-modal').classList.add('hidden'); }

        // --- VIEW MODAL ---
        // Fixed: Look up by ID instead of Index
        function openViewModal(stampId, source) {
            let stamp;
            // Find stamp in specific array based on source
            if (source === 'local') stamp = myStamps.find(s => s.id === stampId);
            else if (source === 'feed') stamp = feedStamps.find(s => s.id === stampId);
            else if (source === 'profile') stamp = viewingProfileStamps.find(s => s.id === stampId);
            
            if (!stamp) return;

            // Content
            document.getElementById('v-title').innerText = stamp.name;
            const cityLink = document.getElementById('v-map-link');
            cityLink.innerText = stamp.city;
            cityLink.href = `http://maps.google.com/?q=${encodeURIComponent(stamp.name + ', ' + stamp.city)}`;
            
            const theme = getStampColor(stamp.id);
            cityLink.style.color = theme;

            document.getElementById('v-notes').innerText = stamp.notes || ""; 
            
            // Date logic
            let dateStr = "";
            if(stamp.visit_month && stamp.visit_day && stamp.visit_year) dateStr = `${stamp.visit_month} ${stamp.visit_day}, ${stamp.visit_year}`;
            else if(stamp.visit_month && stamp.visit_year) dateStr = `${stamp.visit_month} ${stamp.visit_year}`;
            else if(stamp.visit_year) dateStr = `${stamp.visit_year}`;
            else dateStr = stamp.visit_date || '';

            if(dateStr) {
                document.getElementById('v-date').innerText = dateStr;
                document.getElementById('v-date').classList.remove('hidden');
            } else {
                document.getElementById('v-date').classList.add('hidden');
            }

            // User Info
            let uName, uAv;
            const isMe = currentUser && stamp.user_id === currentUser.id;
            
            if(isMe && userProfile) {
                uName = userProfile.username;
                uAv = userProfile.avatar_url;
            } else if(stamp.profiles) {
                uName = stamp.profiles.username;
                uAv = stamp.profiles.avatar_url;
            } else {
                uName = "Traveler"; uAv = null;
            }
            
            document.getElementById('v-user').innerText = uName;
            document.getElementById('v-avatar').innerHTML = uAv ? `<img src="${uAv}" class="w-full h-full object-cover">` : uName.substring(0,2).toUpperCase();
            
            // Allow clicking modal user to view their profile
            document.getElementById('v-user-link').onclick = () => {
                closeViewModal();
                openUserProfile(stamp.user_id);
            };

            // Visual Side Logic
            const visual = document.getElementById('view-visual-side');
            if(stamp.img_url) {
                // Fix for cropping: Use max-h logic instead of absolute inset
                visual.innerHTML = `<img src="${stamp.img_url}" class="w-auto max-h-[70vh] object-contain">`;
                visual.classList.remove('h-32'); 
                visual.style.minHeight = "200px"; 
                visual.style.backgroundColor = '#000'; // Dark bg for photos
            } else {
                const abbrev = stamp.state_code === 'INTL' ? 'INTL' : stamp.state_code;
                visual.innerHTML = `
                    <div class="ink-stamp-deco" style="transform: scale(2) rotate(-10deg); opacity: 0.2;">${abbrev}</div>
                `;
                visual.classList.add('h-32'); 
                visual.style.minHeight = ""; 
                visual.style.backgroundColor = '#f5f5f4';
            }

            document.getElementById('view-modal-overlay').classList.remove('hidden');
            setTimeout(() => document.getElementById('view-modal-container').classList.remove('scale-95'), 10);
        }

        function closeViewModal() {
            document.getElementById('view-modal-container').classList.add('scale-95');
            setTimeout(() => document.getElementById('view-modal-overlay').classList.add('hidden'), 150);
        }

        // --- ADD MODAL & GOOGLE MAPS ---
        let googleMap, googleMarker, autocomplete;
        function initGoogleTools() {
            if(!google || !google.maps || !google.maps.places) return;
            autocomplete = new google.maps.places.Autocomplete(document.getElementById('s-address-search'));
            autocomplete.addListener('place_changed', () => {
                const place = autocomplete.getPlace();
                if (!place.geometry) return;
                
                document.getElementById('s-name').value = place.name;
                
                let city = '', stateFull = '', stateShort = '', country = 'INTL';
                let streetNum = '', route = '';

                if (place.address_components) {
                    place.address_components.forEach(c => {
                        if (c.types.includes('street_number')) streetNum = c.long_name;
                        if (c.types.includes('route')) route = c.long_name;
                        if (c.types.includes('locality')) city = c.long_name;
                        if (c.types.includes('administrative_area_level_1')) {
                            stateFull = c.long_name;
                            stateShort = c.short_name;
                        }
                        if (c.types.includes('country')) {
                            if(c.short_name === 'US') country = 'US';
                            else { country = c.long_name; stateShort = 'INTL'; }
                        }
                    });
                }
                
                const displayCity = (country === 'US') ? `${city}, ${stateShort}` : `${city}, ${country}`;
                
                document.getElementById('geo-city').value = displayCity;
                document.getElementById('geo-state-code').value = stateShort;
                document.getElementById('geo-state-name').value = stateFull;
                document.getElementById('geo-country').value = country;
                document.getElementById('geo-lat').value = place.geometry.location.lat();
                document.getElementById('geo-lng').value = place.geometry.location.lng();
                
                if(googleMap) {
                    googleMap.setCenter(place.geometry.location);
                    googleMap.setZoom(15);
                    googleMarker.setPosition(place.geometry.location);
                }
            });
            googleMap = new google.maps.Map(document.getElementById('map-preview'), { center: { lat: 0, lng: 0 }, zoom: 2, disableDefaultUI: true });
            googleMarker = new google.maps.Marker({ map: googleMap });
        }

        function openAddModal() {
            document.getElementById('add-modal-overlay').classList.remove('hidden');
            // Clear fields...
            document.getElementById('s-name').value = '';
            document.getElementById('s-address-search').value = '';
            document.getElementById('s-notes').value = '';
            document.getElementById('s-image-input').value = '';
            document.getElementById('preview-box').classList.add('hidden');
        }
        function closeAddModal() { document.getElementById('add-modal-overlay').classList.add('hidden'); }

        function previewImage() {
            const file = document.getElementById('s-image-input').files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('img-preview').src = e.target.result;
                    document.getElementById('preview-box').classList.remove('hidden');
                }
                reader.readAsDataURL(file);
            }
        }
        function clearImage() {
            document.getElementById('s-image-input').value = '';
            document.getElementById('preview-box').classList.add('hidden');
        }

        async function compressImage(file) {
            return new Promise((resolve) => {
                const blobURL = URL.createObjectURL(file);
                const img = new Image();
                img.src = blobURL;
                img.onload = () => {
                    URL.revokeObjectURL(blobURL);
                    const canvas = document.createElement('canvas');
                    const MAX_WIDTH = 1000; 
                    let width = img.width;
                    let height = img.height;
                    if (width > MAX_WIDTH) {
                        height = Math.round((height * MAX_WIDTH) / width);
                        width = MAX_WIDTH;
                    }
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    canvas.toBlob((blob) => { resolve(blob); }, 'image/jpeg', 0.7);
                };
            });
        }

        async function saveStamp() {
            const btn = document.getElementById('save-btn');
            const originalText = btn.innerText;
            btn.innerText = "Compressing & Uploading...";
            btn.disabled = true;

            let imgUrl = null;
            const file = document.getElementById('s-image-input').files[0];

            if(file) {
                try {
                    const compressed = await compressImage(file);
                    const fd = new FormData(); fd.append('image', compressed);
                    const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { method: 'POST', body: fd });
                    const json = await res.json();
                    if(json.data) imgUrl = json.data.url;
                } catch(e) { console.error(e); }
            }

            const payload = {
                user_id: currentUser.id,
                name: document.getElementById('s-name').value,
                address: document.getElementById('s-address-search').value, 
                city: document.getElementById('geo-city').value || document.getElementById('s-address-search').value,
                visit_month: document.getElementById('s-date-month').value || null,
                visit_day: document.getElementById('s-date-day').value || null,
                visit_year: document.getElementById('s-date-year').value || null,
                notes: document.getElementById('s-notes').value || null,
                img_url: imgUrl,
                state_code: document.getElementById('geo-state-code').value || 'INTL',
                full_state_name: (document.getElementById('geo-country').value === 'US') 
                    ? (document.getElementById('geo-state-name').value || '') 
                    : (document.getElementById('geo-country').value || 'International'),
                country_code: document.getElementById('geo-country').value || 'INTL',
                lat: document.getElementById('geo-lat').value || null,
                lng: document.getElementById('geo-lng').value || null
            };

            const { error } = await supabaseClient.from('stamps').insert([payload]);
            if(error) { alert("Error: " + error.message); btn.innerText = originalText; btn.disabled = false; }
            else {
                closeAddModal();
                fetchMyStamps();
                btn.innerText = "Save Stamp";
                btn.disabled = false;
            }
        }

        function switchView(viewName) {
            document.querySelectorAll('.page-view').forEach(p => p.classList.add('hidden'));
            document.getElementById(`page-${viewName}`).classList.remove('hidden');
            
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active-nav')); // Fix class name
            const btn = document.getElementById(`btn-${viewName}`);
            if(btn) btn.classList.add('active-nav');

            window.scrollTo({top: 0, behavior: 'smooth'});
            if(viewName === 'feed') fetchFeed(false);
            if(viewName === 'find') renderFollowingList(); // Update logic for Find view
        }

        function continueGuest() {
            // Placeholder for limited access if needed
        }

    </script>
</body>
</html>
