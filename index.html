<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>MassPort App</title>

    <link href="https://fonts.googleapis.com/css2?family=Special+Elite&family=Yrsa:wght@500;600&family=Inter:wght@400;600;800&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        :root {
            --bg: #FCF1E7; --grid-max: 1100px; 
            --btn-bg: #FFFFFF; --accent: #4478A2; --r: 12px; 
            --ease-out-quint: cubic-bezier(0.23, 1, 0.32, 1);
            --ease-smooth: cubic-bezier(0.2, 0.8, 0.2, 1);
            --stamp-red: #C65265; --inner-padding: 16px; 
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        html, body {
            margin: 0; padding: 0;
            font-family: 'Inter', sans-serif; 
            background: var(--bg) url("https://www.transparenttextures.com/patterns/cardboard-flat.png"); 
            color: #333; 
            height: 100%;
            width: 100%;
        }

        /* Prevent vertical scroll bounce on mobile, allow internal scrolling */
        body { 
            overflow-x: hidden; 
            overflow-y: auto;
            display: flex; flex-direction: column;
        }

        /* ---------- GLOBAL LAYOUT ---------- */
        .top-controls {
            position: fixed; top: 0; left: 0; right: 0; padding: 20px;
            display: flex; justify-content: flex-end; align-items: center;
            pointer-events: none; z-index: 15000;
        }

        .control-group { display: flex; gap: 10px; pointer-events: auto; }
        
        .control-btn {
            background: rgba(255,255,255,0.9);
            backdrop-filter: blur(5px); border: 1px solid rgba(0,0,0,0.1);
            padding: 8px 16px; border-radius: 30px; font-size: 13px; font-weight: 600;
            color: #333; cursor: pointer; transition: 0.2s;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08); display: flex; align-items: center; gap: 5px;
        }
        .control-btn:hover { transform: translateY(-2px); }
        .control-btn.profile-pic-btn { padding: 4px; padding-right: 12px; }
        .profile-thumb { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; background: #ddd; }

        /* Mobile Header */
        .header-info-mobile { display: none; }
        
        @media (max-width: 600px) {
            body { position: fixed; overflow: hidden; } /* Lock Body on Mobile */
            
            .top-controls { display: none; } /* Hide top controls on mobile */
            
            .header-info-mobile {
                display: flex; justify-content: space-between; width: 100%; align-items: center; 
                pointer-events: auto; position: fixed; top: 0; left: 0; z-index: 14000;
                padding: 15px 20px;
                /* Removed gradient overlay */
            }
            .user-pill {
                background: rgba(255,255,255,0.9); backdrop-filter: blur(5px);
                padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 700;
                color: var(--accent); border: 1px solid rgba(0,0,0,0.1);
                box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            }
            .display-name-mobile {
                font-family: 'Yrsa', serif; font-size: 20px; font-weight: 600; color: #333;
            }
            .header { display: none !important; }
        }

        @media (min-width: 601px) {
            .header-info-mobile { display: none; }
            /* Desktop Share Button handled in top-controls */
            #mobile-share-btn { display: none; } 
        }

        .header { max-width: var(--grid-max); margin: 60px auto 20px; text-align: center; position: relative; z-index: 10; }
        .header h1 { font-family: 'Yrsa', serif; font-size: 48px; margin: 0; letter-spacing: -1px; }

        /* ---------- NAVIGATION (BOTTOM) ---------- */
        .bottom-ui-container {
            position: fixed; bottom: 25px; left: 0; right: 0;
            display: flex; justify-content: center; align-items: center; gap: 10px;
            z-index: 16000; pointer-events: none;
        }

        /* Share button on mobile sits to the left of nav */
        .mobile-share-trigger {
            pointer-events: auto;
            background: white; width: 36px; height: 36px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); color: #333;
            cursor: pointer;
        }

        .collector-nav-container {
            pointer-events: auto;
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(15px);
            padding: 5px 6px; border-radius: 50px; border: 1px solid rgba(0,0,0,0.1);
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            display: flex; align-items: center;
            max-width: 90vw; width: max-content;
        }
        .collector-nav { 
            display: flex; gap: 4px; padding: 4px 8px; overflow-x: auto; 
            scrollbar-width: none; max-width: 60vw; 
        }
        .collector-nav::-webkit-scrollbar { display: none; }
        
        .nav-tag { 
            font-family: 'Inter'; font-size: 11px; font-weight: 700; color: #666; 
            cursor: pointer; padding: 8px 14px; border-radius: 20px; white-space: nowrap; 
            transition: 0.3s var(--ease-smooth); background: #f4f4f4;
        }
        .nav-tag.active { background: var(--accent); color: white; }
        
        .add-btn { 
            background: var(--accent); color: white; border: none; 
            width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
            cursor: pointer; font-size: 20px; margin-left: 8px; flex-shrink: 0; box-shadow: 0 4px 10px rgba(68, 120, 162, 0.3);
        }

        /* ---------- GRID & ANIMATIONS ---------- */
        #main-grid { 
            display: grid; 
            max-width: var(--grid-max); 
            margin: 0 auto; padding: 20px 40px 140px; width: 100%;
        }

        /* Desktop: 4 Columns */
        @media (min-width: 901px) {
            #main-grid { grid-template-columns: repeat(4, 1fr); gap: 40px 30px; }
        }

        /* Tablet: 3 Columns */
        @media (min-width: 601px) and (max-width: 900px) {
            #main-grid { grid-template-columns: repeat(3, 1fr); gap: 30px 20px; }
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .stagger-in { opacity: 0; animation: fadeInUp 0.6s var(--ease-out-quint) forwards; }

        /* ---------- STAMP VISUALS ---------- */
        .stamp-wrapper { 
            position: relative; 
            transition: transform 0.4s var(--ease-smooth);
            filter: drop-shadow(2px 3px 2px rgba(0,0,0,0.1));
            /* Ensure wrapper has size for layout */
            min-height: 100px; 
        }

        /* Desktop Hover Effects */
        @media (min-width: 601px) {
            .stamp-wrapper:hover {
                transform: translateY(-8px) scale(1.1); z-index: 1000;
                filter: drop-shadow(5px 10px 20px rgba(0,0,0,0.15));
            }
            .stamp-wrapper:hover .stamp { transform: rotate(var(--r_deg, 0deg)); }
            .stamp-wrapper:hover .postmark-seal { opacity: 1; transform: scale(1) rotate(var(--seal-rot, 15deg)); }
            
            /* Logic for revealing notes on hover */
            .stamp-wrapper:hover .stamp-image.has-notes .stamp-title-overlay { 
                transform: translateY(0); 
            }
            .stamp-wrapper:hover .stamp-image.has-notes .stamp-name {
                /* No margin change to prevent jump, just allow content below to be seen */
            }
        }

        /* Ink Stamp Hover (Desktop) */
        @media (min-width: 601px) {
            .state-ink-wrapper:hover {
                transform: translateY(-5px) scale(1.05) !important;
                filter: none !important; /* No shadow request */
            }
        }

        .stamp {
            aspect-ratio: 7 / 9; 
            padding: var(--r); 
            background: #fff;
            cursor: pointer; 
            position: relative; 
            transform: rotate(var(--r_deg, 0deg));
            transition: transform 0.4s var(--ease-smooth);

            mask: 
                radial-gradient(50% 50%, #0000 66%, #000 67%) round var(--r) var(--r) / calc(2*var(--r)) calc(2*var(--r)), 
                conic-gradient(#000 0 0) content-box;

            -webkit-mask-image: 
                radial-gradient(50% 50%, #0000 66%, #000 67%), 
                conic-gradient(#000 0 0);
            -webkit-mask-position: var(--r) var(--r), 0 0;
            -webkit-mask-size: calc(2*var(--r)) calc(2*var(--r)), auto;
            -webkit-mask-repeat: round, no-repeat;
            -webkit-mask-origin: border-box, content-box;
            -webkit-mask-composite: source-over; 
            mask-composite: add;
        }

        .stamp-image { 
            position: absolute; inset: var(--inner-padding); 
            overflow: hidden; border: 4pt solid var(--theme-color); background: var(--theme-color);
            display: flex; flex-direction: column; justify-content: flex-end;
        }
        .stamp-image img { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; }
        
        .placeholder { position: absolute; inset: -1px; --light: rgba(255,255,255,0.3); }
        .pattern-1 { background-image: repeating-linear-gradient(45deg, var(--light), var(--light) 14px, transparent 14px, transparent 18px); }
        .pattern-2 { background-image: repeating-linear-gradient(135deg, transparent, transparent 14px, var(--light) 14px, var(--light) 18px); }

        /* Smoother Animation & Positioning */
        .stamp-title-overlay { 
            position: absolute; bottom: 0; left: -1px; width: calc(100% + 2px); 
            padding: 12px 10px; background: var(--theme-color); color: white; z-index: 5;
            transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1);
            /* Default state: showing title, hiding notes */
            transform: translateY(var(--slide-dist, 0px));
            max-height: 100%;
            display: flex; flex-direction: column;
            justify-content: flex-end;
        }
        
        /* If no notes, force it to stay at bottom (0 translation) */
        .stamp-image:not(.has-notes) .stamp-title-overlay {
            transform: translateY(0) !important;
        }

        .stamp-name { 
            font-family: 'Yrsa', serif; font-size: 18px; font-weight: 600; line-height: 1.1; 
            margin-bottom: 4px; flex-shrink: 0;
            display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
        }
        .stamp-note { 
            font-size: 10px; line-height: 1.3; 
            opacity: 0.8; 
            /* Notes take up remaining space when revealed */
            display: -webkit-box; -webkit-line-clamp: 4; -webkit-box-orient: vertical; overflow: hidden;
            margin-top: 5px;
        }
        
        /* ---------- REVISED POSTMARK ---------- */
        .postmark-seal {
            position: absolute; top: -15px; right: -25px; width: 110px; height: 110px;
            /* Thicker outer stroke */
            border: 4px solid var(--stamp-red); 
            border-radius: 50%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-family: 'Special Elite'; color: var(--stamp-red);
            background: rgba(255,255,255,0.95); z-index: 2000;
            transform: scale(0.6) rotate(var(--seal-rot, 15deg)); 
            opacity: 0; transition: transform 0.4s var(--ease-out-quint), opacity 0.2s ease;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1); 
            padding: 10px; text-align: center;
        }
        /* Thicker inner stroke (matches outer now) */
        .postmark-seal::after {
            content: ""; position: absolute; inset: 4px; 
            border: 2px solid var(--stamp-red); /* Thicker inner stroke */
            border-radius: 50%; pointer-events: none;
        }

        /* Thinner lines */
        .pm-line { width: 80%; height: 1px; background: var(--stamp-red); margin: 4px 0; }
        
        .pm-city { 
            font-size: 13px; font-weight: 900; text-transform: uppercase; letter-spacing: 0.5px; line-height: 1.1; 
            color: var(--stamp-red); text-decoration: none; pointer-events: auto; z-index: 2001;
        }
        .pm-city:hover { text-decoration: underline; }

        /* ---------- INK STAMP (SEPARATOR) ---------- */
        .state-ink-wrapper { 
            z-index: 5; scroll-margin-left: 20px; scroll-margin-top: 100px;
            filter: none !important; /* No shadow */
        }
        .ink-stamp { 
            aspect-ratio: 7/9; width: 100%; mix-blend-mode: multiply; opacity: 0.8;
            font-family: 'Special Elite'; color: var(--ink-color); text-align: center;
            display: flex; align-items: center; justify-content: center;
            transform: rotate(var(--ink-rot));
        }
        .ink-stamp-inner { 
            width: 85%; height: 85%; display: flex; flex-direction: column; 
            align-items: center; justify-content: center; padding: 20px;
            border-width: 4px; border-color: var(--ink-color);
            /* Border style and radius set dynamically via inline style */
        }
        .ink-abbr { font-size: 68px; line-height: 0.85; margin: 10px 0 5px; font-weight: 900; letter-spacing: -3px; }
        
        /* Dashed separator look using text */
        .ink-sep { font-size: 16px; letter-spacing: -2px; font-weight: bold; margin: 5px 0; line-height: 10px; overflow: hidden; white-space: nowrap; max-width: 100%;}
        
        .ink-full { font-size: 14px; margin-top: 5px; letter-spacing: 2px; width: 100%; text-transform: uppercase; line-height: 1.1;}

        /* ---------- MOBILE SCROLL VIEW ---------- */
        @media (max-width: 600px) {
            #main-grid { 
                display: flex; flex-wrap: nowrap; overflow-x: auto; 
                /* Lock vertical scrolling within grid */
                overflow-y: hidden;
                scroll-snap-type: x mandatory; 
                height: 75vh; align-items: center; 
                padding: 0 40px 80px; gap: 20px; scrollbar-width: none;
                overscroll-behavior-x: contain;
                margin-top: 60px; /* Space for header */
            }
            .stamp-wrapper { 
                flex: 0 0 80vw; 
                scroll-snap-align: center; 
            }
            
            /* Mobile "Focused" State */
            .is-centered .postmark-seal { opacity: 1; transform: scale(1) rotate(var(--seal-rot)); pointer-events: auto; }
            .is-centered .stamp-title-overlay { transform: translateY(0); } /* Show notes on mobile focus */
            
            /* Tap Zones for Navigation */
            .nav-zone-left, .nav-zone-right {
                position: fixed; top: 15%; bottom: 20%; width: 15vw; z-index: 14000;
            }
            .nav-zone-left { left: 0; }
            .nav-zone-right { right: 0; }
        }

        /* UTILS & MODALS */
        .hidden { display: none !important; }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(8px); display: flex; align-items: center; z-index: 20000; justify-content: center; animation: fadeIn 0.2s ease; }
        .auth-card, .modal-content { background: white; padding: 30px; border-radius: 20px; max-width: 380px; width: 90%; box-shadow: 0 20px 50px rgba(0,0,0,0.2); position: relative; max-height: 90vh; overflow-y: auto; }
        
        input, textarea { width: 100%; padding: 14px; margin: 8px 0; border: 1px solid #ddd; border-radius: 12px; font-family: 'Inter'; font-size: 14px; background: #fafafa; }
        .primary-btn { width: 100%; padding: 14px; background: var(--accent); color: white; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; margin-top: 12px; font-size: 15px; transition: 0.2s;}
        .primary-btn:hover { opacity: 0.9; }
        .secondary-btn { background: #f1f5f9; color: #333; }
        
        .image-preview-container { position: relative; margin-top: 10px; display: none; }
        .image-preview-container.has-image { display: block; }
        .remove-img-btn { position: absolute; top: -8px; right: -8px; background: red; color: white; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }

        .auth-switch { font-size: 12px; text-align: center; margin-top: 15px; color: #666; cursor: pointer; text-decoration: underline; }

        @keyframes fadeIn { from{opacity:0} to{opacity:1} }
    </style>
</head>
<body>

    <div class="header-info-mobile">
        <div class="user-pill" id="mobile-user-pill">@MassPort</div>
        <div class="display-name-mobile" id="mobile-display-name">MassPort</div>
    </div>

    <div class="top-controls">
        <div class="control-group">
            <div class="control-btn" id="share-btn-desktop" onclick="shareProfile()">
                <span class="material-symbols-rounded">ios_share</span> <span>Share</span>
            </div>
        </div>
        
        <div class="control-group" id="user-controls">
             </div>
    </div>

    <div class="header">
        <h1 id="view-title">MassPort</h1>
        <p style="font-size:13px; opacity:0.6; letter-spacing: 1px;">TRAVEL ARCHIVE</p>
    </div>

    <div id="login-modal" class="modal-overlay hidden">
        <div class="auth-card">
            <h2 style="text-align:center; font-family: 'Yrsa'; font-size: 32px; margin-bottom: 20px;">Welcome Back</h2>
            <input type="text" id="login-input" placeholder="Email">
            <input type="password" id="login-password" placeholder="Password">
            <button class="primary-btn" onclick="handleLogin()">Log In</button>
            <div class="auth-switch" onclick="switchAuthMode('signup')">New here? Create Account</div>
            <p id="login-msg" style="font-size:11px; color:#c65265; text-align:center; margin-top:10px;"></p>
        </div>
    </div>

    <div id="signup-modal" class="modal-overlay hidden">
        <div class="auth-card">
            <h2 style="text-align:center; font-family: 'Yrsa'; font-size: 32px; margin-bottom: 20px;">Create Passport</h2>
            <input type="email" id="signup-email" placeholder="Email Address">
            <input type="text" id="signup-username" placeholder="Username (Unique)">
            <input type="text" id="signup-displayname" placeholder="Display Name">
            <input type="password" id="signup-password" placeholder="Password">
            <label style="font-size:11px; font-weight:700; color:#555; margin-top:10px; display:block;">PROFILE PHOTO</label>
            <input type="file" id="signup-photo" accept="image/*">
            <button class="primary-btn" onclick="handleSignUp()">Create Account</button>
            <div class="auth-switch" onclick="switchAuthMode('login')">Already have a passport? Log In</div>
            <p id="signup-msg" style="font-size:11px; color:#c65265; text-align:center; margin-top:10px;"></p>
        </div>
    </div>

    <div id="profile-modal" class="modal-overlay hidden">
        <div class="auth-card">
            <h2 style="text-align:center; font-family: 'Yrsa'; font-size: 28px; margin-bottom: 15px;">Edit Profile</h2>
            <label style="font-size:11px; font-weight:700; color:#555;">DISPLAY NAME</label>
            <input type="text" id="edit-displayname">
            <label style="font-size:11px; font-weight:700; color:#555;">USERNAME</label>
            <input type="text" id="edit-username">
            <label style="font-size:11px; font-weight:700; color:#555; margin-top:10px; display:block;">NEW PHOTO</label>
            <input type="file" id="edit-photo-file" accept="image/*">
            <button class="primary-btn" id="save-profile-btn" onclick="saveProfile()">Save Changes</button>
            <button class="primary-btn secondary-btn" onclick="closeProfileModal()">Cancel</button>
            <button class="primary-btn" style="background:transparent; color:#c65265; border:1px solid #c65265; margin-top:15px;" onclick="handleLogout()">Logout</button>
        </div>
    </div>

    <div id="main-grid"></div>

    <div class="nav-zone-left" onclick="scrollGrid(-1)"></div>
    <div class="nav-zone-right" onclick="scrollGrid(1)"></div>

    <div class="bottom-ui-container">
        <div id="mobile-share-btn" class="mobile-share-trigger" onclick="shareProfile()">
             <span class="material-symbols-rounded" style="font-size:18px;">ios_share</span>
        </div>

        <div id="nav-bar" class="collector-nav-container">
            <div class="collector-nav" id="filter-nav"></div>
            <button class="add-btn hidden" id="add-stamp-btn" onclick="openAddModal()">+</button>
        </div>
    </div>

    <div id="modal-overlay" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 id="modal-title" style="margin:0 0 15px; font-family:'Yrsa'; font-size:24px;">New Stamp</h3>
            <label style="font-size:11px; font-weight:700; color:#555;">TITLE</label>
            <input type="text" id="s-name" placeholder="e.g. The Louvre">
            <label style="font-size:11px; font-weight:700; color:#555; margin-top:10px; display:block;">LOCATION (Search)</label>
            <input type="text" id="s-address" placeholder="City, Country...">
            <label style="font-size:11px; font-weight:700; color:#555; margin-top:10px; display:block;">NOTES</label>
            <textarea id="s-notes" placeholder="Memories..." rows="3"></textarea>
            <label style="font-size:11px; font-weight:700; color:#555; margin-top:10px; display:block;">IMAGE</label>
            <input type="file" id="s-image-input" accept="image/*" onchange="previewImage()">
            <div id="preview-box" class="image-preview-container">
                <div class="remove-img-btn" onclick="clearImage()">Ã—</div>
                <img id="img-preview" style="width:100%; height:120px; object-fit:cover; border-radius:8px; border:1px solid #ddd;">
            </div>
            <input type="hidden" id="edit-id">
            <input type="hidden" id="current-img-url">
            <button class="primary-btn" id="save-btn" onclick="saveStamp()">Save Stamp</button>
            <button class="primary-btn secondary-btn" style="margin-top:0;" onclick="closeModal()">Cancel</button>
        </div>
    </div>

    <div id="img-modal" class="modal-overlay hidden" onclick="this.classList.add('hidden')">
        <div style="position:relative; width:100%; height:100%; display:flex; flex-direction:column; align-items:center; justify-content:center; pointer-events:none;">
            <img id="modal-img" style="max-width:90%; max-height:80vh; border:10px solid white; box-shadow:0 0 50px black; pointer-events:auto;">
            <h2 id="modal-caption" style="color:white; font-family:'Yrsa'; margin-top:20px; text-shadow:0 2px 4px black; text-align:center;"></h2>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://ujyoxnrfchzyduhtcpaz.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVqeW94bnJmY2h6eWR1aHRjcGF6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcyNzQ3MzUsImV4cCI6MjA4Mjg1MDczNX0.AWdu8ScAz8MqfzqKlcuxtNUncYq3m5pu59EMhef0-9M';
        const LOCATIONIQ_KEY = 'pk.7fb90bfc2abb6e9b7ac921233aa0d0ce';
        const IMGBB_API_KEY = '7dd3553ba2a58dca14721122d652e484';
        
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const themes = ['#4478A2','#C65265','#D78143','#297381','#89974F','#DAAD60','#757498','#AA7876','#D7A995','#6E917A'];
        const inkPalette = ['#1B4F72', '#78281F', '#186A3B', '#7E5109', '#512E5F', '#4A235A', '#0B5345'];
        const stateIcons = { "AZ": "brightness_7", "CA": "beach_access", "PA": "notifications_active", "EU": "public", "NY": "apartment", "FL": "sunny", "TX": "star", "NV": "playing_cards", "WA": "coffee", "HI": "surfing", "CO": "mountain_flag", "MA": "history_edu", "IL": "location_city", "LA": "music_note", "TN": "music_note", "GA": "agriculture", "OR": "forest", "ME": "sailing", "DC": "gavel", "UT": "hiking", "NM": "light_mode", "OH": "flight", "MI": "kayaking", "AK": "ac_unit", "WI": "forest", "VT": "ac_unit", "MT":"landscape", "NE":"psychiatry", "INTL": "public" };
        const defaultIcons = ['explore', 'place', 'map', 'flag', 'travel_explore'];
        const abbrToState = { 
            "AL":"ALABAMA","AK":"ALASKA","AZ":"ARIZONA","AR":"ARKANSAS","CA":"CALIFORNIA","CO":"COLORADO","CT":"CONNECTICUT","DE":"DELAWARE","FL":"FLORIDA","GA":"GEORGIA","HI":"HAWAII","ID":"IDAHO","IL":"ILLINOIS","IN":"INDIANA","IA":"IOWA","KS":"KANSAS","KY":"KENTUCKY","LA":"LOUISIANA","ME":"MAINE","MD":"MARYLAND","MA":"MASSACHUSETTS","MI":"MICHIGAN","MN":"MINNESOTA","MS":"MISSISSIPPI","MO":"MISSOURI","MT":"MONTANA","NE":"NEBRASKA","NV":"NEVADA","NH":"NEW HAMPSHIRE","NJ":"NEW JERSEY","NM":"NEW MEXICO","NY":"NEW YORK","NC":"NORTH CAROLINA","ND":"NORTH DAKOTA","OH":"OHIO","OK":"OKLAHOMA","OR":"OREGON","PA":"PENNSYLVANIA","RI":"RHODE ISLAND","SC":"SOUTH CAROLINA","SD":"SOUTH DAKOTA","TN":"TENNESSEE","TX":"TEXAS","UT":"UTAH","VT":"VERMONT","VA":"VIRGINIA","WA":"WASHINGTON","WV":"WEST VIRGINIA","WI":"WISCONSIN","WY":"WYOMING", "DC": "DISTRICT OF COLUMBIA"
        };
        const stateToAbbr = Object.fromEntries(Object.entries(abbrToState).map(a => a.reverse()));

        let currentUser = null;
        let userProfile = null;
        let publicViewUser = null; 
        let globalStamps = [];
        let globalGroups = {};
        let initialLoadComplete = false;
        let currentFilter = 'ALL';

        window.addEventListener('load', () => {
            const hash = window.location.hash;
            if (hash && hash.includes('access_token')) {
                supabaseClient.auth.getSession().then(({ data: { session } }) => {
                    handleAuthState(session);
                    history.replaceState(null, null, ' ');
                });
            } else {
                checkRoute();
            }
        });

        window.addEventListener('hashchange', checkRoute);

        function checkRoute() {
            const hash = window.location.hash.replace('#', '').trim();
            if (hash && !hash.includes('access_token')) {
                publicViewUser = hash;
                document.getElementById('add-stamp-btn').classList.add('hidden');
                document.getElementById('login-modal').classList.add('hidden');
                document.getElementById('signup-modal').classList.add('hidden');
                document.getElementById('mobile-share-btn').classList.remove('hidden'); // Show share on mobile
                
                fetchPublicStamps(hash);
                
                supabaseClient.auth.getSession().then(({ data: { session } }) => {
                    renderHeader(session?.user || null);
                });
            } else {
                publicViewUser = null;
                initAuth();
            }
        }

        async function initAuth() {
            const { data: { session } } = await supabaseClient.auth.getSession();
            handleAuthState(session);
        }

        async function handleAuthState(session) {
            if (session?.user) {
                currentUser = session.user;
                
                // --- ROBUST PROFILE CHECK ---
                // Try to find the profile.
                const { data: profile, error } = await supabaseClient
                    .from('profiles')
                    .select('*')
                    .eq('id', currentUser.id)
                    .single();

                if (error || !profile) {
                    console.log("Profile row missing. Auto-creating...");
                    // Upsert default profile so UI doesn't break
                    const { data: newProfile, error: createError } = await supabaseClient
                        .from('profiles')
                        .upsert({ 
                            id: currentUser.id, 
                            display_name: currentUser.email.split('@')[0],
                            username: 'user_' + Math.floor(Math.random() * 10000),
                            updated_at: new Date()
                        }, { onConflict: 'id' })
                        .select()
                        .single();
                    
                    if(newProfile) userProfile = newProfile;
                    else console.error("Critical: Could not create profile", createError);
                } else {
                    userProfile = profile;
                }

                // UI Updates
                document.getElementById('login-modal').classList.add('hidden');
                document.getElementById('signup-modal').classList.add('hidden');
                
                if (!publicViewUser) {
                    renderHeader(currentUser);
                    document.getElementById('add-stamp-btn').classList.remove('hidden');
                    document.getElementById('mobile-share-btn').classList.remove('hidden');
                    document.getElementById('view-title').innerText = "MassPort";
                    document.getElementById('mobile-display-name').innerText = userProfile?.display_name || "MassPort";
                    document.getElementById('mobile-user-pill').innerText = `@${userProfile?.username || 'me'}`;
                    fetchMyStamps();
                } else {
                    renderHeader(currentUser); 
                }
            } else {
                currentUser = null;
                userProfile = null;
                renderHeader(null);
                if (!publicViewUser) {
                    document.getElementById('login-modal').classList.remove('hidden');
                }
            }
        }

        function renderHeader(user) {
            const container = document.getElementById('user-controls');
            container.innerHTML = '';
            
            if(user && userProfile) {
                const btn = document.createElement('div');
                btn.className = 'control-btn profile-pic-btn';
                btn.onclick = openProfileModal;
                btn.innerHTML = `
                    <img src="${userProfile.avatar_url || 'https://via.placeholder.com/150'}" class="profile-thumb">
                    <span class="desktop-only" style="margin-left:5px;">Logout / Edit</span>
                `;
                container.appendChild(btn);
            } else if (!publicViewUser) {
                // Login flow in modal
            } else {
                 const btn = document.createElement('div');
                 btn.className = 'control-btn';
                 btn.innerText = "Log In";
                 btn.onclick = () => { window.location.hash = ''; location.reload(); };
                 container.appendChild(btn);
            }
        }

        function switchAuthMode(mode) {
            document.getElementById('login-modal').classList.add('hidden');
            document.getElementById('signup-modal').classList.add('hidden');
            document.getElementById(`${mode}-modal`).classList.remove('hidden');
        }

        async function handleLogin() {
            const input = document.getElementById('login-input').value;
            const password = document.getElementById('login-password').value;
            const msg = document.getElementById('login-msg');
            msg.innerText = "Logging in...";

            const { error } = await supabaseClient.auth.signInWithPassword({ email: input, password });
            if (error) msg.innerText = error.message;
            else location.reload();
        }

        async function handleSignUp() {
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            const username = document.getElementById('signup-username').value;
            const displayName = document.getElementById('signup-displayname').value;
            const file = document.getElementById('signup-photo').files[0];
            const msg = document.getElementById('signup-msg');

            if(!username || !email || !password) { msg.innerText = "All fields required"; return; }
            msg.innerText = "Creating account...";

            let avatarUrl = '';
            if (file) {
                const fd = new FormData(); fd.append('image', file);
                try {
                    const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { method: 'POST', body: fd });
                    const json = await res.json();
                    if(json.data) avatarUrl = json.data.url;
                } catch(e) { console.error(e); }
            }

            const { data: authData, error: authError } = await supabaseClient.auth.signUp({ email, password });

            if (authError) {
                msg.innerText = authError.message;
                return;
            }

            if (authData.user) {
                // UPSERT to prevent duplicate key errors
                const { error: profileError } = await supabaseClient.from('profiles').upsert({
                    id: authData.user.id,
                    username: username,
                    display_name: displayName,
                    avatar_url: avatarUrl,
                    updated_at: new Date()
                }, { onConflict: 'id' });

                if (profileError) msg.innerText = "Profile error: " + profileError.message;
                else msg.innerText = "Success! Please check email.";
            }
        }

        async function handleLogout() {
            await supabaseClient.auth.signOut();
            window.location.hash = '';
            location.reload();
        }

        function openProfileModal() {
            if(!userProfile) return;
            document.getElementById('edit-displayname').value = userProfile.display_name || '';
            document.getElementById('edit-username').value = userProfile.username || '';
            document.getElementById('profile-modal').classList.remove('hidden');
        }
        function closeProfileModal() { document.getElementById('profile-modal').classList.add('hidden'); }

        async function saveProfile() {
            const btn = document.getElementById('save-profile-btn');
            btn.innerText = "Saving...";
            const newName = document.getElementById('edit-displayname').value;
            const newUser = document.getElementById('edit-username').value;
            const file = document.getElementById('edit-photo-file').files[0];
            let updates = { display_name: newName, username: newUser, updated_at: new Date() };
            if(file) {
                 const fd = new FormData(); fd.append('image', file);
                 const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { method: 'POST', body: fd });
                 const json = await res.json();
                 if(json.data) updates.avatar_url = json.data.url;
            }
            const { error } = await supabaseClient.from('profiles').update(updates).eq('id', currentUser.id);
            if(error) alert(error.message);
            else location.reload();
        }

        async function fetchMyStamps() {
            const { data } = await supabaseClient.from('stamps').select('*').eq('user_id', currentUser.id).order('created_at', {ascending: true});
            processStamps(data);
        }

        async function fetchPublicStamps(username) {
            document.getElementById('view-title').innerText = `@${username}`;
            const { data: profile } = await supabaseClient.from('profiles').select('*').eq('username', username).single();
            if (profile) {
                document.getElementById('mobile-display-name').innerText = profile.display_name;
                document.getElementById('mobile-user-pill').innerText = `@${profile.username}`;
                const { data } = await supabaseClient.from('stamps').select('*').eq('user_id', profile.id).order('created_at', {ascending: true});
                processStamps(data);
            } else {
                alert("User not found: " + username);
            }
        }

        // --- HASH HELPER FOR CONSISTENT COLORS ---
        function getStringHash(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                hash = str.charCodeAt(i) + ((hash << 5) - hash);
            }
            return Math.abs(hash);
        }

        function processStamps(data) {
            globalStamps = [];
            globalGroups = {};

            data.forEach(s => {
                let groupKey = "INTL";
                if (s.country_code === 'US' || s.country_code === 'USA' || s.country_code === 'us') {
                    if (s.state_code && s.state_code.length === 2) groupKey = s.state_code;
                    else if (stateToAbbr[s.full_state_name]) groupKey = stateToAbbr[s.full_state_name];
                    else groupKey = "USA";
                }
                s._groupKey = groupKey;
                globalGroups[groupKey] = (globalGroups[groupKey] || 0) + 1;
            });

            data.sort((a, b) => {
                if (a._groupKey === "INTL" && b._groupKey !== "INTL") return 1;
                if (a._groupKey !== "INTL" && b._groupKey === "INTL") return -1;
                if (a._groupKey === b._groupKey) return 0;
                return a._groupKey.localeCompare(b._groupKey);
            });

            globalStamps = data;
            renderGrid(globalStamps); 
            renderNav(globalGroups);
            setTimeout(() => { initialLoadComplete = true; }, 1000);
        }

        function renderGrid(items, animate = false) {
            const grid = document.getElementById('main-grid');
            grid.innerHTML = '';
            
            let displayList = [];
            let lastGroup = null;

            items.forEach(s => {
                if (s._groupKey !== lastGroup) {
                    // Get color based on hash so it stays consistent
                    const colorIdx = getStringHash(s._groupKey) % inkPalette.length;
                    displayList.push({ 
                        type: 'ink', 
                        code: s._groupKey, 
                        color: inkPalette[colorIdx],
                        full: abbrToState[s._groupKey] || (s._groupKey === 'INTL' ? 'INTERNATIONAL' : s._groupKey)
                    });
                    lastGroup = s._groupKey;
                }
                displayList.push({ ...s, type: 'paper' });
            });

            displayList.forEach((item, i) => {
                const shouldAnimate = !initialLoadComplete || animate;
                const delay = shouldAnimate ? i * 0.05 : 0;
                const animClass = shouldAnimate ? 'stagger-in' : '';

                if (item.type === 'ink') {
                    const wrap = document.createElement('div');
                    wrap.className = `stamp-wrapper state-ink-wrapper ${animClass}`;
                    if(shouldAnimate) wrap.style.animationDelay = `${delay}s`;
                    wrap.id = `group-${item.code}`;

                    // Randomize Border Style & Shape
                    const borderStyles = ['solid', 'double', 'dashed', 'dotted'];
                    const bStyle = borderStyles[Math.floor(Math.random() * borderStyles.length)];
                    
                    // Random Shape (Border Radius)
                    const shapes = [
                        '4px', // Standard Box
                        '20px', // Rounded Box
                        '0 20px 0 20px', // Leaf
                        '20px 0 20px 0', // Reverse Leaf
                        '5px 20px 5px 20px' // Soft diagonal
                    ];
                    const bRadius = shapes[Math.floor(Math.random() * shapes.length)];

                    const rot = (Math.random() * 10 - 5).toFixed(1);
                    let iconName = stateIcons[item.code] || defaultIcons[i % defaultIcons.length];

                    wrap.innerHTML = `
                        <div class="ink-stamp" style="--ink-color: ${item.color}; --ink-rot: ${rot}deg">
                            <div class="ink-stamp-inner" style="border-style: ${bStyle}; border-radius: ${bRadius};">
                                <span class="material-symbols-rounded" style="font-size:36px;">${iconName}</span>
                                <div class="ink-abbr">${item.code}</div>
                                <div class="ink-sep">- - - - - -</div>
                                <div class="ink-full">${item.full}</div>
                            </div>
                        </div>`;
                    grid.appendChild(wrap);

                } else {
                    const wrap = document.createElement('div');
                    wrap.className = `stamp-wrapper ${animClass}`;
                    if(shouldAnimate) wrap.style.animationDelay = `${delay}s`;

                    const rot = (Math.random() * 6 - 3).toFixed(1);
                    const sealRot = (Math.random() * 30 - 15).toFixed(1);
                    const theme = themes[i % themes.length];
                    const cityText = item.city.split(',')[0].trim();
                    const hasNotes = item.notes && item.notes.trim().length > 0;
                    
                    // Calculation for slide distance (simulated)
                    // We set CSS variable --slide-dist in JS if needed, but CSS transform is cleaner.
                    // The CSS handles translation based on .has-notes

                    wrap.innerHTML = `
                        <div class="stamp" style="--theme-color: ${theme}; --r_deg: ${rot}deg">
                            <div class="stamp-image ${hasNotes ? 'has-notes' : ''}">
                                ${item.img_url ? `<img src="${item.img_url}">` : `<div class="placeholder pattern-${(i%2)+1}" style="--theme-color: ${theme}"></div>`}
                                <div class="stamp-title-overlay" style="--slide-dist: calc(100% - 46px);">
                                    <div class="stamp-name">${item.name}</div>
                                    ${hasNotes ? `<div class="stamp-note">${item.notes}</div>` : ''}
                                </div>
                            </div>
                        </div>
                        <div class="postmark-seal" style="--seal-rot: ${sealRot}deg">
                            <div class="pm-line"></div>
                            <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.city)}" target="_blank" class="pm-city">${cityText}</a>
                            <div class="pm-line"></div>
                        </div>`;
                    
                    const stampEl = wrap.querySelector('.stamp');
                    addPressHandlers(stampEl, item);
                    grid.appendChild(wrap);
                }
            });
            setupMobileScroll();
        }

        function addPressHandlers(element, item) {
            let pressTimer;
            const start = (e) => {
                if (e.type === 'click' && e.button !== 0) return;
                pressTimer = setTimeout(() => {
                    if (currentUser && currentUser.id === item.user_id) openAddModal(item);
                }, 800);
            };
            const cancel = (e) => clearTimeout(pressTimer);
            const click = (e) => {
                if(e.target.closest('a')) return;
                if(item.img_url) {
                   document.getElementById('modal-img').src = item.img_url;
                   document.getElementById('modal-caption').innerText = item.name;
                   document.getElementById('img-modal').classList.remove('hidden');
                }
            }
            element.addEventListener('mousedown', start);
            element.addEventListener('touchstart', start);
            element.addEventListener('mouseup', cancel);
            element.addEventListener('mouseleave', cancel);
            element.addEventListener('touchend', cancel);
            element.addEventListener('click', click);
        }

        function renderNav(groups) {
            const nav = document.getElementById('filter-nav');
            nav.innerHTML = '';
            const allBtn = document.createElement('div');
            allBtn.className = 'nav-tag active';
            allBtn.innerHTML = `ALL`;
            allBtn.onclick = () => filterOrScroll('ALL', allBtn);
            nav.appendChild(allBtn);

            const keys = Object.keys(groups).sort((a,b) => {
                if(a==='INTL') return 1; if(b==='INTL') return -1;
                return a.localeCompare(b);
            });

            keys.forEach(k => {
                const btn = document.createElement('div');
                btn.className = 'nav-tag';
                btn.dataset.code = k;
                btn.innerHTML = `${k} <span style="opacity:0.6; font-size:9px; margin-left:2px;">${groups[k]}</span>`;
                btn.onclick = () => filterOrScroll(k, btn);
                nav.appendChild(btn);
            });
        }

        function filterOrScroll(code, btnEl) {
            const isMobile = window.innerWidth <= 600;
            document.querySelectorAll('.nav-tag').forEach(t => {
                t.classList.remove('active');
                const tCode = t.dataset.code;
                if(tCode) t.innerHTML = `${tCode} <span style="opacity:0.6; font-size:9px; margin-left:2px;">${globalGroups[tCode]}</span>`;
                else t.innerHTML = `ALL`;
            });
            btnEl.classList.add('active');

            if (code !== 'ALL') {
                const full = abbrToState[code] || (code === 'INTL' ? 'INTERNATIONAL' : code);
                btnEl.innerText = full;
            }

            if (isMobile) {
                if(currentFilter !== 'ALL') {
                     renderGrid(globalStamps, false);
                     currentFilter = 'ALL';
                     setTimeout(() => {
                         const target = document.getElementById(`group-${code}`);
                         if(target) target.scrollIntoView({ behavior: 'smooth', inline: 'center' });
                     }, 100);
                } else {
                    const target = document.getElementById(`group-${code}`);
                    if(target) target.scrollIntoView({ behavior: 'smooth', inline: 'center' });
                }
            } else {
                currentFilter = code;
                if (code === 'ALL') renderGrid(globalStamps, true);
                else {
                    const filtered = globalStamps.filter(s => s._groupKey === code);
                    renderGrid(filtered, true);
                }
            }
        }

        function scrollGrid(dir) {
            const grid = document.getElementById('main-grid');
            // Calculate EXACT width of card (80vw) + gap (20px)
            // 80vw in pixels:
            const cardWidth = window.innerWidth * 0.8; 
            const gap = 20;
            const scrollAmount = cardWidth + gap;
            
            grid.scrollBy({ left: dir * scrollAmount, behavior: 'smooth' });
        }

        function shareProfile() {
            if(!userProfile && !publicViewUser) return alert("Please log in first.");
            const usernameToShare = publicViewUser || userProfile.username;
            // Ensure clean URL sharing
            const baseUrl = window.location.origin + window.location.pathname;
            const url = `${baseUrl}#${usernameToShare}`;
            
            if (navigator.share) {
                navigator.share({ title: 'MassPort', url: url }).catch(console.error);
            } else {
                navigator.clipboard.writeText(url);
                alert("Profile link copied to clipboard!");
            }
        }

        // --- ADD/EDIT LOGIC (Same as before) ---
        function openAddModal(existing = null) {
            document.getElementById('modal-overlay').classList.remove('hidden');
            clearImage();
            if(existing) {
                document.getElementById('edit-id').value = existing.id;
                document.getElementById('s-name').value = existing.name;
                document.getElementById('s-address').value = existing.city; 
                document.getElementById('s-notes').value = existing.notes;
                document.getElementById('current-img-url').value = existing.img_url || '';
                if(existing.img_url) {
                    document.getElementById('img-preview').src = existing.img_url;
                    document.getElementById('preview-box').classList.add('has-image');
                }
                document.getElementById('save-btn').innerText = "Update Stamp";
            } else {
                document.getElementById('edit-id').value = '';
                document.getElementById('s-name').value = '';
                document.getElementById('s-address').value = '';
                document.getElementById('s-notes').value = '';
                document.getElementById('save-btn').innerText = "Save Stamp";
            }
        }
        function closeModal() { document.getElementById('modal-overlay').classList.add('hidden'); }
        function previewImage() {
            const file = document.getElementById('s-image-input').files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('img-preview').src = e.target.result;
                    document.getElementById('preview-box').classList.add('has-image');
                }
                reader.readAsDataURL(file);
            }
        }
        function clearImage() {
            document.getElementById('s-image-input').value = '';
            document.getElementById('preview-box').classList.remove('has-image');
            document.getElementById('img-preview').src = '';
        }
        async function saveStamp() {
            const btn = document.getElementById('save-btn');
            const addressInput = document.getElementById('s-address').value;
            if(!addressInput) return alert("Location is required!");
            btn.innerText = "Processing...";
            
            let finalCity = addressInput;
            let finalStateCode = null;
            let finalStateName = null;
            let finalCountry = 'US';

            try {
                const res = await fetch(`https://us1.locationiq.com/v1/search?key=${LOCATIONIQ_KEY}&q=${encodeURIComponent(addressInput)}&format=json&addressdetails=1`);
                const data = await res.json();
                if(data && data[0]) {
                    const addr = data[0].address;
                    finalCity = addr.city || addr.town || addr.village || addr.county || addressInput.split(',')[0];
                    finalCountry = addr.country_code ? addr.country_code.toUpperCase() : 'INTL';
                    if(finalCountry === 'US' || finalCountry === 'USA') {
                        finalStateCode = addr.state_code ? addr.state_code.toUpperCase() : null;
                        finalStateName = addr.state ? addr.state.toUpperCase() : null;
                    }
                    if(finalStateCode) finalCity = `${finalCity}, ${finalStateCode}`;
                    else finalCity = `${finalCity}, ${addr.country || finalCountry}`;
                }
            } catch(e) { console.log("Geocode fail", e); }

            let imgUrl = document.getElementById('current-img-url').value;
            const file = document.getElementById('s-image-input').files[0];
            if (file) {
                btn.innerText = "Uploading Image...";
                const fd = new FormData(); fd.append('image', file);
                const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { method: 'POST', body: fd });
                const json = await res.json();
                imgUrl = json.data.url;
            }

            const payload = {
                name: document.getElementById('s-name').value,
                city: finalCity,
                country_code: finalCountry,
                state_code: finalStateCode,
                full_state_name: finalStateName,
                notes: document.getElementById('s-notes').value,
                user_id: currentUser.id,
                img_url: imgUrl
            };
            const editId = document.getElementById('edit-id').value;
            if (editId) await supabaseClient.from('stamps').update(payload).eq('id', editId);
            else await supabaseClient.from('stamps').insert([payload]);
            closeModal();
            fetchMyStamps();
        }

        function setupMobileScroll() {
            if(window.innerWidth > 600) return;
            const grid = document.getElementById('main-grid');
            grid.addEventListener('scroll', () => {
                const center = window.innerWidth / 2;
                document.querySelectorAll('.stamp-wrapper').forEach(card => {
                    const rect = card.getBoundingClientRect();
                    const cardCenter = rect.left + rect.width/2;
                    const dist = Math.abs(center - cardCenter);
                    if(dist < 120) {
                        card.classList.add('is-centered');
                        card.style.transform = `scale(1)`;
                    } else {
                        card.classList.remove('is-centered');
                        card.style.transform = 'scale(0.9)';
                    }
                });
            });
        }
    </script>
</body>
</html>
